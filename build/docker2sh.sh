#!/bin/bash

# This converts a docker file to a shell file
# Almost guaranteed to not work with many Docker files, but hey, it works for us

HOME_DIRECTORY=/$3
CONVERT_HOME_DIRECTORY=1

INPUT=$1
OUTPUT=$2

cp -f $INPUT $OUTPUT
sed -i "1i export HOME_DIRECTORY=$HOME_DIRECTORY" $OUTPUT

# Convert FROM, MAINTAINER, VOLUME to comments
sed -i "s/^FROM\s/# FROM /g" $OUTPUT
sed -i "s/^MAINTAINER\s/# MAINTAINER /g" $OUTPUT
sed -i "s/^VOLUME\s/# VOLUME /g" $OUTPUT

# Get rid of RUNs
sed -i "s/^RUN\s/echo RUN;/g" $OUTPUT

# Convert home directory into squiggles (tildes)
#sed -i "s/$HOME_DIRECTORY/~/g" $OUTPUT

# Convert ENVs into EXPORTs
sed -r 's/^ENV\s/export /g' -i $OUTPUT
sed -r 's/^ARG\s/export /g' -i $OUTPUT
sed -r 's/^LABEL\s/export /g' -i $OUTPUT
#sed -r 's/^ENV\s([A-Z]*)\s*([a-z]*)/export \1=\2/g' -i $OUTPUT
#sed -r 's/^ARG\s([A-Z]*)\s*([a-z]*)/export \1=\2/g' -i $OUTPUT
#sed -r 's/^LABEL\s([A-Z]*)\s*([a-z]*)/export \1=\2/g' -i $OUTPUT

# Get rid of EXPOSE todo: open up ports based on these?
sed -i "s/^EXPOSE\s/# EXPOSE /g" $OUTPUT

# Convert ADDs into cp
sed -i "s/^COPY\s--from=build\s/#COPY --from=build /g" $OUTPUT
sed -i "s/^COPY\s/cd \$HOME_DIRECTORY; cp /g" $OUTPUT
sed -i "s/^ADD\s/cd \$HOME_DIRECTORY; cp -rf /g" $OUTPUT
sed -i "s/^CMD\s/#CMD /g" $OUTPUT
sed -i "s/^STOPSIGNAL\s/#STOPSIGNAL /g" $OUTPUT
sed -i "s/ENTRYPOINT\s/#ENTRYPOINT /g" $OUTPUT
sed -i "s/WORKDIR\s/#WORKDIR /g" $OUTPUT

# Timestamp
#sed -i '1s/^/# Generated by docker_to_sh, for all your shoddy bash script from Dockerfile generation needs. \n/' $OUTPUT
