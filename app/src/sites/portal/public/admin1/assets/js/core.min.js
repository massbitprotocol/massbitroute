(function(context){"use strict";function init(){var channels={},funcType=Function;return{publish:function(){var args=arguments,subs=channels[args[0]],len,params,x;if(subs){len=subs.length;params=args.length>1?Array.prototype.splice.call(args,1):[];setTimeout(function(){for(x=0;x<len;x+=1){subs[x].apply(context,params)}subs=context=params=null},0)}},subscribe:function(channel,callback){if(typeof channel!=="string"){throw"invalid or missing channel"}if(!(callback instanceof funcType)){throw"invalid or missing callback"}if(!channels[channel]){channels[channel]=[]}channels[channel].push(callback);return{channel:channel,callback:callback}},unsubscribe:function(handle,callback){if(handle.channel&&handle.callback){callback=handle.callback;handle=handle.channel}if(typeof handle!=="string"){throw"invalid or missing channel"}if(!(callback instanceof funcType)){throw"invalid or missing callback"}var subs=channels[handle],x,y=subs instanceof Array?subs.length:0;for(x=0;x<y;x+=1){if(subs[x]===callback){subs.splice(x,1);break}}}}}context.PubSub=init()})(window);(function(n){var e=[],t={},r="routie",o=n[r],i=function(n,e){this.name=e,this.path=n,this.keys=[],this.fns=[],this.params={},this.regex=a(this.path,this.keys,!1,!1)};i.prototype.addHandler=function(n){this.fns.push(n)},i.prototype.removeHandler=function(n){for(var e=0,t=this.fns.length;t>e;e++){var r=this.fns[e];if(n==r)return this.fns.splice(e,1),void 0}},i.prototype.run=function(n){for(var e=0,t=this.fns.length;t>e;e++)this.fns[e].apply(this,n)},i.prototype.match=function(n,e){var t=this.regex.exec(n);if(!t)return!1;for(var r=1,o=t.length;o>r;++r){var i=this.keys[r-1],a="string"==typeof t[r]?decodeURIComponent(t[r]):t[r];i&&(this.params[i.name]=a),e.push(a)}return!0},i.prototype.toURL=function(n){var e=this.path;for(var t in n)e=e.replace("/:"+t,"/"+n[t]);if(e=e.replace(/\/:.*\?/g,"/").replace(/\?/g,""),-1!=e.indexOf(":"))throw Error("missing parameters for url: "+e);return e};var a=function(n,e,t,r){return n instanceof RegExp?n:(n instanceof Array&&(n="("+n.join("|")+")"),n=n.concat(r?"":"/?").replace(/\/\(/g,"(?:/").replace(/\+/g,"__plus__").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(n,t,r,o,i,a){return e.push({name:o,optional:!!a}),t=t||"",""+(a?"":t)+"(?:"+(a?t:"")+(r||"")+(i||r&&"([^/.]+?)"||"([^/]+?)")+")"+(a||"")}).replace(/([\/.])/g,"\\$1").replace(/__plus__/g,"(.+)").replace(/\*/g,"(.*)"),RegExp("^"+n+"$",t?"":"i"))},s=function(n,r){var o=n.split(" "),a=2==o.length?o[0]:null;n=2==o.length?o[1]:o[0],t[n]||(t[n]=new i(n,a),e.push(t[n])),t[n].addHandler(r)},h=function(n,e){if("function"==typeof e)s(n,e),h.reload();else if("object"==typeof n){for(var t in n)s(t,n[t]);h.reload()}else e===void 0&&h.navigate(n)};h.lookup=function(n,t){for(var r=0,o=e.length;o>r;r++){var i=e[r];if(i.name==n)return i.toURL(t)}},h.remove=function(n,e){var r=t[n];r&&r.removeHandler(e)},h.removeAll=function(){t={},e=[]},h.navigate=function(n,e){e=e||{};var t=e.silent||!1;t&&l(),setTimeout(function(){window.location.hash=n,t&&setTimeout(function(){p()},1)},1)},h.noConflict=function(){return n[r]=o,h};var f=function(){return window.location.hash.substring(1)},c=function(n,e){var t=[];return e.match(n,t)?(e.run(t),!0):!1},u=h.reload=function(){for(var n=f(),t=0,r=e.length;r>t;t++){var o=e[t];if(c(n,o))return}},p=function(){n.addEventListener?n.addEventListener("hashchange",u,!1):n.attachEvent("onhashchange",u)},l=function(){n.removeEventListener?n.removeEventListener("hashchange",u):n.detachEvent("onhashchange",u)};p(),n[r]=h})(window);define([],function(){var viewdir="views";function show(path,config){if(config==-1)return render_sub_stack(this,path);if(this._subs[path])return render_sub_stack(this._subs[path],config);var scope=get_app_scope(this);var index=this.index;if(typeof path=="string"){if(path.indexOf("./")===0){index++;path=path.substr(2)}var parsed=parse_parts(path);scope.path=scope.path.slice(0,index).concat(parsed)}else{webix.extend(scope.path[index].params,path,true)}scope.show(url_string(scope.path),-1)}function get_app_scope(scope){while(scope){if(scope.app)return scope;scope=scope.parent}return app}function url_string(stack){var url=[];var start=app.config.layout?1:0;for(;start<stack.length;start++){url.push("/"+stack[start].page);var params=params_string(stack[start].params);if(params)url.push(":"+params)}return url.join("")}function params_string(obj){var str=[];for(var key in obj){if(str.length)str.push(":");str.push(key+"="+obj[key])}return str.join("")}function subui(ui,name,stack){if(name.page!=this.name){this.name=name.page;this.ui=create_temp_ui;this.on=create_temp_event;this.show=show;this.module=ui;destroy.call(this);this._init=[];this._destroy=[];this._windows=[];this._events=[];this._subs={};this.$layout=false;var subview=copy(ui,null,this);subview.$scope=this;create.call(this,subview);if(this.$layout){this.$layout={root:(this._ui.$$||webix.$$)(this.name+":subview"),sub:subui,parent:this,index:this.index+1}}}return this.$layout}function parse_parts(url){var chunks=url.split("/");if(!chunks[0]){if(app.config.layout)chunks[0]=app.config.layout;else chunks.shift()}for(var i=0;i<chunks.length;i++){var test=chunks[i];var result={};var pos=test.indexOf(":");if(pos!==-1){var params=test.substr(pos+1).split(":");var objmode=params[0].indexOf("=")!==-1;if(objmode){result={};for(var j=0;j<params.length;j++){var dchunk=params[j].split("=");result[dchunk[0]]=dchunk[1]}}else{result=params}}chunks[i]={page:pos>-1?test.substr(0,pos):test,params:result}}return chunks}function copy(obj,target,config){if(obj.$oninit)config._init.push(obj.$oninit);if(obj.$ondestroy)config._destroy.push(obj.$ondestroy);if(obj.$onevent){for(var key in obj.$onevent)config._events.push(key,obj.$onevent[key])}if(obj.$windows)config._windows.push.apply(config._windows,obj.$windows);if(obj.$subview){if(typeof obj.$subview=="string"){var tname=config.name+":subview:"+obj.$subview;var tobj=config._subs[obj.$subview]={parent:this,root:tname,sub:subui,index:0,app:true};obj.id=tname}else{obj={id:config.name+":subview"};config.$layout=true}}if(obj.$ui)obj=obj.$ui;if(obj.$init){return obj}target=target||(webix.isArray(obj)?[]:{});for(var method in obj){if(obj[method]&&typeof obj[method]=="object"&&!webix.isDate(obj[method])){target[method]=copy(obj[method],webix.isArray(obj[method])?[]:{},config)}else{target[method]=obj[method]}}return target}function render_sub_stack(scope,path){if(scope.root)scope.root=webix.$$(scope.root);var parts=parse_parts(path);var parts1=[].concat(parts);render_stack(scope,parts1)}function render_stack(layout,stack,prev_url){var line=stack[0];if(line){layout.path=line;var url=line.page;var issubpage=url.indexOf(".")===0;if(issubpage)url=(layout.fullname||"")+url;url=url.replace(/\./g,"/");if(url[0]=="$")url=prev_url+"/"+url.substring(1);var next_step=function(ui){if(typeof ui==="function")ui=ui();stack.shift();var next=layout.sub(ui,line,stack);if(next){next.fullname=(issubpage?layout.fullname||"":"")+line.page;render_stack(next,stack,url)}else{webix.ui.$freeze=false;webix.ui.resize()}};require([(viewdir||"views")+"/"+url],function(ui){if(ui.then)ui.then(next_step);else next_step(ui)})}else{webix.ui.$freeze=false;webix.ui.resize()}}var ui_plugins=[];var url_plugins=[];var require_plugins=[];function run_plugins(plugins,ui,name,stack,scope){for(var i=0;i<plugins.length;i++)if(plugins[i](ui,name,stack,scope)===false)return false;return true}function _createStore(initState,reducer){var _debug=true;var $state=initState||{};var _reducer=reducer||{};var _event=PubSub;function _getState(){return webix.copy($state)}function _dispatch(action,callback,isPublish){_debug&&console.log("=> dispatch:"+action.type);_debug&&console.log(action.payload);var reducer=_reducer[action.type];if(reducer)reducer($state,action,_event,function(_state){if(_state)$state=_state;_debug&&console.log($state);if(!isPublish)_event.publish(action.type,$state);if(callback)callback($state)})}function _registerReducer(type,handler){_reducer[type]=handler}function _initState(_initState){$state=_initState}function _updateState(_state){Object.assign($state,_state)}return{getState:_getState,initState:_initState,updateState:_updateState,registerReducer:_registerReducer,subscribe:_event.subscribe,unsubscribe:_event.unsubscribe,publish:_event.publish,dispatch:_dispatch}}var app={createStore:_createStore,create:function(config){app.config=webix.extend({name:"App",version:"1.0",container:document.body,start:"/home"},config,true);app.debug=config.debug;app.$layout={sub:subui,root:app.config.container,index:0,add:true};viewdir=app.config.viewdir||"views";webix.extend(app,webix.EventSystem);webix.attachEvent("onClick",function(e){if(e){var target=e.target||e.srcElement;if(target&&target.getAttribute){var trigger=target.getAttribute("trigger");if(trigger)app.trigger(trigger)}}});setTimeout(function(){app.start()},1);var title=document.getElementsByTagName("title")[0];if(title)title.innerHTML=app.config.name;return app},ui:create_temp_ui,_params:function(){var _arr=parse_parts(location.hash);_arr.splice(0,1);return _arr},params:function(){var _arr=parse_parts(location.hash);_arr.splice(0,1);return _arr.reduce(function(_o,_i){_o[_i.page]=_i.params;return _o},{})},router:function(name){var parts=parse_parts(name);app.path=[].concat(parts);webix.ui.$freeze=true;render_stack(app.$layout,[].concat(parts))},show:function(name,options){if(window.location.hash!="#!"+name)routie.navigate("!"+name,options);else app.router(name)},start:function(name){routie("!*",app.router);if(!window.location.hash)app.show(app.config.start);else{webix.ui.$freeze=false;webix.ui.resize()}},use:function(handler,config){if(handler.$oninit)handler.$oninit(this,config||{});if(handler.$onurlchange)url_plugins.push(handler.$onurlchange);if(handler.$onurl)require_plugins.push(handler.$onurl);if(handler.$onui)ui_plugins.push(handler.$onui)},trigger:function(name){app.apply(name,[].splice.call(arguments,1))},apply:function(name,data){app.callEvent(name,data)},action:function(name){return function(){app.apply(name,arguments)}},on:function(name,handler){this.attachEvent(name,handler)},_uis:[],_handlers:[]};function create_temp_event(obj,name,code){var id=obj.attachEvent(name,code);this._handlers.push({obj:obj,id:id});return id}function run_handlers(arr,view,scope){if(arr)for(var i=0;i<arr.length;i++)arr[i](view,scope)}function destroy(){if(!this._ui)return;if(this.$layout)destroy.call(this.$layout);var handlers=this._handlers;for(var i=handlers.length-1;i>=0;i--)handlers[i].obj.detachEvent(handlers[i].id);this._handlers=[];var uis=this._uis;for(var i=uis.length-1;i>=0;i--)if(uis[i]&&uis[i].destructor)uis[i].destructor();this._uis=[];run_handlers(this._destroy,this._ui,this);if(!this.parent&&this._ui)this._ui.destructor()}function delete_ids(view){delete webix.ui.views[view.config.id];view.config.id="";var childs=view.getChildViews();for(var i=childs.length-1;i>=0;i--)delete_ids(childs[i])}function create_temp_ui(module,container){var view;var temp={_init:[],_destroy:[],_windows:[],_events:[]};var ui=copy(module,null,temp);ui.$scope=this;if(ui.id)view=$$(ui.id);if(!view){for(var i=0;i<temp._windows.length;i++)this.ui(temp._windows[i]);view=webix.ui(ui,container);this._uis.push(view);for(var i=0;i<temp._events.length;i+=2)this.on(app,temp._events[i],temp._events[i+1]);run_handlers(temp._init,view,this)}return view}function create(subview){this._uis=[];this._handlers=[];if(this.root&&this.root.config)delete_ids(this.root);for(var i=0;i<this._windows.length;i++)this.ui(this._windows[i]);this._ui=webix.ui(subview,this.root);if(this.parent)this.root=this._ui;for(var i=0;i<this._events.length;i+=2)this.on(app,this._events[i],this._events[i+1]);run_handlers(this._init,this._ui,this)}function invalid_url(err){if(app.debug)console.log(err.stack);if(!err.requireModules)throw err;if(app.debug)webix.message({type:"error",expire:5e3,text:"Can't load "+err.requireModules.join(", ")});app.show(app.config.start)}requirejs.onError=invalid_url;return app});
