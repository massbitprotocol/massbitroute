/*
@license
Webix <%= pkg.productName %> v.<%= pkg.version %>
This software is covered by Webix Trial License.
Usage without proper license is prohibited.
(c) XB Software Ltd.
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).chat={})}(this,(function(t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,i)};function i(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}var n=function(){return(n=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)},r=function(){},a=function(){function t(t,e){this.webixJet=!0,this.webix=t,this._events=[],this._subs={},this._data={},e&&e.params&&t.extend(this._data,e.params)}return t.prototype.getRoot=function(){return this._root},t.prototype.destructor=function(){this._detachEvents(),this._destroySubs(),this._events=this._container=this.app=this._parent=this._root=null},t.prototype.setParam=function(t,e,i){if(this._data[t]!==e&&(this._data[t]=e,this._segment.update(t,e,0),i))return this.show(null)},t.prototype.getParam=function(t,e){var i=this._data[t];if(void 0!==i||!e)return i;var n=this.getParentView();return n?n.getParam(t,e):void 0},t.prototype.getUrl=function(){return this._segment.suburl()},t.prototype.getUrlString=function(){return this._segment.toString()},t.prototype.getParentView=function(){return this._parent},t.prototype.$$=function(t){if("string"==typeof t){var e=this.getRoot();return e.queryView((function(i){return(i.config.id===t||i.config.localId===t)&&i.$scope===e.$scope}),"self")}return t},t.prototype.on=function(t,e,i){var n=t.attachEvent(e,i);return this._events.push({obj:t,id:n}),n},t.prototype.contains=function(t){for(var e in this._subs){var i=this._subs[e].view;if(i===t||i.contains(t))return!0}return!1},t.prototype.getSubView=function(t){var e=this.getSubViewInfo(t);if(e)return e.subview.view},t.prototype.getSubViewInfo=function(t){var e=this._subs[t||"default"];return e?{subview:e,parent:this}:"_top"===t?(this._subs[t]={url:"",id:null,popup:!0},this.getSubViewInfo(t)):this._parent?this._parent.getSubViewInfo(t):null},t.prototype._detachEvents=function(){for(var t=this._events,e=t.length-1;e>=0;e--)t[e].obj.detachEvent(t[e].id)},t.prototype._destroySubs=function(){for(var t in this._subs){var e=this._subs[t].view;e&&e.destructor()}this._subs={}},t.prototype._init_url_data=function(){var t=this._segment.current();this._data={},this.webix.extend(this._data,t.params,!0)},t.prototype._getDefaultSub=function(){if(this._subs.default)return this._subs.default;for(var t in this._subs){var e=this._subs[t];if(!e.branch&&e.view&&"_top"!==t){var i=e.view._getDefaultSub();if(i)return i}}},t.prototype._routed_view=function(){var t=this.getParentView();if(!t)return!0;var e=t._getDefaultSub();return!(!e&&e!==this)&&t._routed_view()},t}();function o(t){"/"===t[0]&&(t=t.substr(1));for(var e=t.split("/"),i=[],n=0;n<e.length;n++){var r=e[n],a={},o=r.indexOf(":");if(-1===o&&(o=r.indexOf("?")),-1!==o)for(var s=0,c=r.substr(o+1).split(/[\:\?\&]/g);s<c.length;s++){var u=c[s].split("=");a[u[0]]=decodeURIComponent(u[1])}i[n]={page:o>-1?r.substr(0,o):r,params:a,isNew:!0}}return i}function s(t){for(var e=[],i=0,n=t;i<n.length;i++){var r=n[i];e.push("/"+r.page);var a=c(r.params);a&&e.push("?"+a)}return e.join("")}function c(t){var e=[];for(var i in t)"object"!=typeof t[i]&&(e.length&&e.push("&"),e.push(i+"="+encodeURIComponent(t[i])));return e.join("")}var u=function(){function t(t,e){this._next=1,this.route="string"==typeof t?{url:o(t),path:t}:t,this.index=e}return t.prototype.current=function(){return this.route.url[this.index]},t.prototype.next=function(){return this.route.url[this.index+this._next]},t.prototype.suburl=function(){return this.route.url.slice(this.index)},t.prototype.shift=function(e){var i=new t(this.route,this.index+this._next);return i.setParams(i.route.url,e,i.index),i},t.prototype.setParams=function(t,e,i){if(e){var n=t[i].params;for(var r in e)n[r]=e[r]}},t.prototype.refresh=function(){for(var t=this.route.url,e=this.index+1;e<t.length;e++)t[e].isNew=!0},t.prototype.toString=function(){var t=s(this.suburl());return t?t.substr(1):""},t.prototype._join=function(t,e){var i=this.route.url;if(null===t)return i;var n=this.route.url,r=!0;if(i=n.slice(0,this.index+(e?this._next:0)),t){i=i.concat(o(t));for(var a=0;a<i.length;a++)n[a]&&(i[a].view=n[a].view),r&&n[a]&&i[a].page===n[a].page?i[a].isNew=!1:i[a].isNew&&(r=!1)}return i},t.prototype.append=function(t){var e=this._join(t,!0);return this.route.path=s(e),this.route.url=e,this.route.path},t.prototype.show=function(t,e,i){var n=this,a=this._join(t.url,i);return this.setParams(a,t.params,this.index+(i?this._next:0)),new Promise((function(t,i){var o=s(a),c={url:a,redirect:o,confirm:Promise.resolve()},u=e?e.app:null;if(u&&!u.callEvent("app:guard",[c.redirect,e,c]))return void i(new r);c.confirm.catch((function(t){return i(t)})).then((function(){if(null!==c.redirect){if(c.redirect!==o)return u.show(c.redirect),void i(new r);n.route.path=o,n.route.url=a,t()}else i(new r)}))}))},t.prototype.size=function(t){this._next=t},t.prototype.split=function(){var e={url:this.route.url.slice(this.index+1),path:""};return e.url.length&&(e.path=s(e.url)),new t(e,0)},t.prototype.update=function(t,e,i){var n=this.route.url[this.index+(i||0)];if(!n)return this.route.url.push({page:"",params:{}}),this.update(t,e,i);""===t?n.page=e:n.params[t]=e,this.route.path=s(this.route.url)},t}(),h=function(t){function e(e,i){var n=t.call(this,e.webix)||this;return n.app=e,n._children=[],n}return i(e,t),e.prototype.ui=function(t,e){var i=(e=e||{}).container||t.container,n=this.app.createView(t);return this._children.push(n),n.render(i,this._segment,this),"object"!=typeof t||t instanceof a?n:n.getRoot()},e.prototype.show=function(t,e){if(e=e||{},"object"==typeof t){for(var i in t)this.setParam(i,t[i]);t=null}else{if("/"===t.substr(0,1))return this.app.show(t,e);if(0===t.indexOf("./")&&(t=t.substr(2)),0===t.indexOf("../")){var n=this.getParentView();return n?n.show(t.substr(3),e):this.app.show("/"+t.substr(3))}var r=this.getSubViewInfo(e.target);if(r){if(r.parent!==this)return r.parent.show(t,e);if(e.target&&"default"!==e.target)return this._renderFrameLock(e.target,r.subview,{url:t,params:e.params})}else if(t)return this.app.show("/"+t,e)}return this._show(this._segment,{url:t,params:e.params},this)},e.prototype._show=function(t,e,i){var n=this;return t.show(e,i,!0).then((function(){return n._init_url_data(),n._urlChange()})).then((function(){t.route.linkRouter&&(n.app.getRouter().set(t.route.path,{silent:!0}),n.app.callEvent("app:route",[t.route.path]))}))},e.prototype.init=function(t,e){},e.prototype.ready=function(t,e){},e.prototype.config=function(){this.app.webix.message("View:Config is not implemented")},e.prototype.urlChange=function(t,e){},e.prototype.destroy=function(){},e.prototype.destructor=function(){this.destroy(),this._destroyKids(),this._root&&(this._root.destructor(),t.prototype.destructor.call(this))},e.prototype.use=function(t,e){t(this.app,this,e)},e.prototype.refresh=function(){this.getUrl();return this.destroy(),this._destroyKids(),this._destroySubs(),this._detachEvents(),this._container.tagName&&this._root.destructor(),this._segment.refresh(),this._render(this._segment)},e.prototype.render=function(t,e,i){var n=this;"string"==typeof e&&(e=new u(e,0)),this._segment=e,this._parent=i,this._init_url_data();var r="string"==typeof(t=t||document.body)?this.webix.toNode(t):t;return this._container!==r?(this._container=r,this._render(e)):this._urlChange().then((function(){return n.getRoot()}))},e.prototype._render=function(t){var e=this,i=this.config();return i.then?i.then((function(i){return e._render_final(i,t)})):this._render_final(i,t)},e.prototype._render_final=function(t,e){var i,n=this,r=null,a=null,o=!1;if(this._container.tagName?a=this._container:(r=this._container).popup?(a=document.body,o=!0):a=this.webix.$$(r.id),!this.app||!a)return Promise.reject(null);var s=this._segment.current(),c={ui:{}};this.app.copyConfig(t,c.ui,this._subs),this.app.callEvent("app:render",[this,e,c]),c.ui.$scope=this,!r&&s.isNew&&s.view&&s.view.destructor();try{if(r&&!o){var u=a,h=u.getParentView();h&&"multiview"===h.name&&!c.ui.id&&(c.ui.id=u.config.id)}this._root=this.app.webix.ui(c.ui,a);var p=this._root;o&&p.setPosition&&!p.isVisible()&&p.show(),r&&(r.view&&r.view!==this&&r.view!==this.app&&r.view.destructor(),r.id=this._root.config.id,this.getParentView()||!this.app.app?r.view=this:r.view=this.app),s.isNew&&(s.view=this,s.isNew=!1),i=Promise.resolve(this._init(this._root,e)).then((function(){return n._urlChange().then((function(){return n._initUrl=null,n.ready(n._root,e.suburl())}))}))}catch(t){i=Promise.reject(t)}return i.catch((function(t){return n._initError(n,t)}))},e.prototype._init=function(t,e){return this.init(t,e.suburl())},e.prototype._urlChange=function(){var t=this;this.app.callEvent("app:urlchange",[this,this._segment]);var e=[];for(var i in this._subs){var n=this._subs[i],r=this._renderFrameLock(i,n,null);r&&e.push(r)}return Promise.all(e).then((function(){return t.urlChange(t._root,t._segment.suburl())}))},e.prototype._renderFrameLock=function(t,e,i){if(!e.lock){var n=this._renderFrame(t,e,i);n&&(e.lock=n.then((function(){return e.lock=null}),(function(){return e.lock=null})))}return e.lock},e.prototype._renderFrame=function(t,e,i){var n=this;if("default"===t){if(this._segment.next()){var r=i?i.params:null;return e.params&&(r=this.webix.extend(r||{},e.params)),this._createSubView(e,this._segment.shift(r))}e.view&&e.popup&&(e.view.destructor(),e.view=null)}if(null!==i&&(e.url=i.url,e.params&&(i.params=this.webix.extend(i.params||{},e.params))),e.route){if(null!==i)return e.route.show(i,e.view).then((function(){return n._createSubView(e,e.route)}));if(e.branch)return}var a=e.view;if(!a&&e.url){if("string"==typeof e.url)return e.route=new u(e.url,0),i&&e.route.setParams(e.route.route.url,i.params,0),e.params&&e.route.setParams(e.route.route.url,e.params,0),this._createSubView(e,e.route);"function"!=typeof e.url||a instanceof e.url||(a=new(this.app._override(e.url))(this.app,"")),a||(a=e.url)}if(a)return a.render(e,e.route||this._segment,this)},e.prototype._initError=function(t,e){return this.app&&this.app.error("app:error:initview",[e,t]),!0},e.prototype._createSubView=function(t,e){var i=this;return this.app.createFromURL(e.current()).then((function(n){return n.render(t,e,i)}))},e.prototype._destroyKids=function(){for(var t=this._children,e=t.length-1;e>=0;e--)t[e]&&t[e].destructor&&t[e].destructor();this._children=[]},e}(a),p=function(t){function e(e,i){var n=t.call(this,e,i)||this;return n._ui=i.ui,n}return i(e,t),e.prototype.config=function(){return this._ui},e}(h),l=function(){function t(t,e,i){this.path="",this.app=i}return t.prototype.set=function(t,e){this.path=t;var i=this.app;i.app.getRouter().set(i._segment.append(this.path),{silent:!0})},t.prototype.get=function(){return this.path},t}(),f=!0,d=function(t){function e(e){var i=this,n=(e||{}).webix||window.webix;return e=n.extend({name:"App",version:"1.0",start:"/home"},e,!0),(i=t.call(this,n,e)||this).config=e,i.app=i.config.app,i.ready=Promise.resolve(),i._services={},i.webix.extend(i,i.webix.EventSystem),i}return i(e,t),e.prototype.getUrl=function(){return this._subSegment.suburl()},e.prototype.getUrlString=function(){return this._subSegment.toString()},e.prototype.getService=function(t){var e=this._services[t];return"function"==typeof e&&(e=this._services[t]=e(this)),e},e.prototype.setService=function(t,e){this._services[t]=e},e.prototype.destructor=function(){this.getSubView().destructor(),t.prototype.destructor.call(this)},e.prototype.copyConfig=function(t,e,i){if((t instanceof a||"function"==typeof t&&t.prototype instanceof a)&&(t={$subview:t}),void 0!==t.$subview)return this.addSubView(t,e,i);var n=t instanceof Array;for(var r in e=e||(n?[]:{}),t){var o=t[r];if("function"==typeof o&&o.prototype instanceof a&&(o={$subview:o}),!o||"object"!=typeof o||o instanceof this.webix.DataCollection||o instanceof RegExp||o instanceof Map)e[r]=o;else if(o instanceof Date)e[r]=new Date(o);else{var s=this.copyConfig(o,o instanceof Array?[]:{},i);null!==s&&(n?e.push(s):e[r]=s)}}return e},e.prototype.getRouter=function(){return this.$router},e.prototype.clickHandler=function(t,e){if(t&&(e=e||t.target||t.srcElement)&&e.getAttribute){var i=e.getAttribute("trigger");if(i)return this._forView(e,(function(t){return t.app.trigger(i)})),t.cancelBubble=!0,t.preventDefault();var n=e.getAttribute("route");if(n)return this._forView(e,(function(t){return t.show(n)})),t.cancelBubble=!0,t.preventDefault()}var r=e.parentNode;r&&this.clickHandler(t,r)},e.prototype.getRoot=function(){return this.getSubView().getRoot()},e.prototype.refresh=function(){var t=this;return this._subSegment?this.getSubView().refresh().then((function(e){return t.callEvent("app:route",[t.getUrl()]),e})):Promise.resolve(null)},e.prototype.loadView=function(t){var e=this,i=this.config.views,n=null;if(""===t)return Promise.resolve(this._loadError("",new Error("Webix Jet: Empty url segment")));try{i&&"string"==typeof(n="function"==typeof i?i(t):i[t])&&(t=n,n=null),n||("_hidden"===t?n={hidden:!0}:"_blank"===t?n={}:(t=t.replace(/\./g,"/"),n=this.require("jet-views",t)))}catch(e){n=this._loadError(t,e)}return n.then||(n=Promise.resolve(n)),n=n.then((function(t){return t.__esModule?t.default:t})).catch((function(i){return e._loadError(t,i)}))},e.prototype._forView=function(t,e){var i=this.webix.$$(t);i&&e(i.$scope)},e.prototype._loadViewDynamic=function(t){return null},e.prototype.createFromURL=function(t){var e=this;return t.isNew||!t.view?this.loadView(t.page).then((function(i){return e.createView(i,name,t.params)})):Promise.resolve(t.view)},e.prototype._override=function(t){var e=this.config.override;if(e){for(var i=void 0;t;)i=t,t=e.get(t);return i}return t},e.prototype.createView=function(t,i,n){if("function"==typeof(t=this._override(t))){if(t.prototype instanceof e)return new t({app:this,name:i,params:n,router:l});if(t.prototype instanceof a)return new t(this,{name:i,params:n});t=t(this)}return t instanceof a?t:new p(this,{name:i,ui:t})},e.prototype.show=function(t,e){return t&&this.app&&0==t.indexOf("//")?this.app.show(t.substr(1),e):this.render(this._container,t||this.config.start,e)},e.prototype.trigger=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];this.apply(t,e)},e.prototype.apply=function(t,e){this.callEvent(t,e)},e.prototype.action=function(t){return this.webix.bind((function(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];this.apply(t,e)}),this)},e.prototype.on=function(t,e){this.attachEvent(t,e)},e.prototype.use=function(t,e){t(this,null,e)},e.prototype.error=function(t,e){if(this.callEvent(t,e),this.callEvent("app:error",e),this.config.debug)for(var i=0;i<e.length;i++)if(console.error(e[i]),e[i]instanceof Error){var n=e[i].message;0===n.indexOf("Module build failed")?(n=n.replace(/\x1b\[[0-9;]*m/g,""),document.body.innerHTML="<pre style='font-size:16px; background-color: #ec6873; color: #000; padding:10px;'>"+n+"</pre>"):(n+="<br><br>Check console for more details",this.webix.message({type:"error",text:n,expire:-1}))}},e.prototype.render=function(t,e,i){var n=this;this._container="string"==typeof t?this.webix.toNode(t):t||document.body;var r=null;!this.$router?(f&&"tagName"in this._container&&(this.webix.event(document.body,"click",(function(t){return n.clickHandler(t)})),f=!1),"string"==typeof e&&(e=new u(e,0)),this._subSegment=this._first_start(e),this._subSegment.route.linkRouter=!0):r="string"==typeof e?e:this.app?e.split().route.path||this.config.start:e.toString();var a=i?i.params:this.config.params||null,o=this.getSubView(),s=this._subSegment,c=s.show({url:r,params:a},o).then((function(){return n.createFromURL(s.current())})).then((function(e){return e.render(t,s)})).then((function(t){return n.$router.set(s.route.path,{silent:!0}),n.callEvent("app:route",[n.getUrl()]),t}));return this.ready=this.ready.then((function(){return c})),c},e.prototype.getSubView=function(){if(this._subSegment){var t=this._subSegment.current().view;if(t)return t}return new h(this,{})},e.prototype.require=function(t,e){return null},e.prototype._first_start=function(t){var e=this;this._segment=t;if(this.$router=new this.config.router((function(t){return setTimeout((function(){e.show(t).catch((function(t){if(!(t instanceof r))throw t}))}),1)}),this.config,this),this._container===document.body&&!1!==this.config.animation){var i=this._container;this.webix.html.addCss(i,"webixappstart"),setTimeout((function(){e.webix.html.removeCss(i,"webixappstart"),e.webix.html.addCss(i,"webixapp")}),10)}if(t){if(this.app){var n=t.current().view;t.current().view=this,t.next()?(t.refresh(),t=t.split()):t=new u(this.config.start,0),t.current().view=n}}else{var a=this.$router.get();a||(a=this.config.start,this.$router.set(a,{silent:!0})),t=new u(a,0)}return t},e.prototype._loadError=function(t,e){return this.error("app:error:resolve",[e,t]),{template:" "}},e.prototype.addSubView=function(t,e,i){var n=!0!==t.$subview?t.$subview:null,r=t.name||(n?this.webix.uid():"default");return e.id=t.id||"s"+this.webix.uid(),(i[r]={id:e.id,url:n,branch:t.branch,popup:t.popup,params:t.params}).popup?null:e},e}(a),v=function(){function t(t,e){var i=this;this.config=e||{},this._detectPrefix(),this.cb=t,window.onpopstate=function(){return i.cb(i.get())}}return t.prototype.set=function(t,e){var i=this;if(this.config.routes){var n=t.split("?",2);for(var r in this.config.routes)if(this.config.routes[r]===n[0]){t=r+(n.length>1?"?"+n[1]:"");break}}this.get()!==t&&window.history.pushState(null,null,this.prefix+this.sufix+t),e&&e.silent||setTimeout((function(){return i.cb(t)}),1)},t.prototype.get=function(){var t=this._getRaw().replace(this.prefix,"").replace(this.sufix,"");if(t="/"!==t&&"#"!==t?t:"",this.config.routes){var e=t.split("?",2),i=this.config.routes[e[0]];i&&(t=i+(e.length>1?"?"+e[1]:""))}return t},t.prototype._detectPrefix=function(){var t=this.config.routerPrefix;this.sufix="#"+(void 0===t?"!":t),this.prefix=document.location.href.split("#",2)[0]},t.prototype._getRaw=function(){return document.location.href},t}(),m=!1;function g(t){if(!m&&t){m=!0;var e=window;e.Promise||(e.Promise=t.promise);var i=t.version.split(".");10*i[0]+1*i[1]<53&&(t.ui.freeze=function(e){var i=e();return i&&i.then?i.then((function(e){return t.ui.$freeze=!1,t.ui.resize(),e})):(t.ui.$freeze=!1,t.ui.resize()),i});var n=t.ui.baselayout.prototype.addView,r=t.ui.baselayout.prototype.removeView,a={addView:function(t,e){if(this.$scope&&this.$scope.webixJet&&!t.queryView){var i=this.$scope,r={};t=i.app.copyConfig(t,{},r),n.apply(this,[t,e]);var a=function(t){i._renderFrame(t,r[t],null).then((function(){i._subs[t]=r[t]}))};for(var o in r)a(o);return t.id}return n.apply(this,arguments)},removeView:function(){if(r.apply(this,arguments),this.$scope&&this.$scope.webixJet){var e=this.$scope._subs;for(var i in e){var n=e[i];t.$$(n.id)||(n.view.destructor(),delete e[i])}}}};t.extend(t.ui.layout.prototype,a,!0),t.extend(t.ui.baselayout.prototype,a,!0),t.protoUI({name:"jetapp",$init:function(e){this.$app=new this.app(e);var i=t.uid().toString();e.body={id:i},this.$ready.push((function(){this.callEvent("onInit",[this.$app]),this.$app.render({id:i})}))}},t.ui.proxy,t.EventSystem)}}var _=function(t){function e(e){var i;return e.router=e.router||v,g((i=t.call(this,e)||this).webix),i}return i(e,t),e.prototype.require=function(t,e){return require(t+"/"+e)},e}(d),b=(function(t){function e(){return null!==t&&t.apply(this,arguments)||this}i(e,t),e.prototype._detectPrefix=function(){this.prefix="",this.sufix=this.config.routerPrefix||""},e.prototype._getRaw=function(){return document.location.pathname+(document.location.search||"")}}(v),function(){function t(t,e){this.path="",this.cb=t}return t.prototype.set=function(t,e){var i=this;this.path=t,e&&e.silent||setTimeout((function(){return i.cb(t)}),1)},t.prototype.get=function(){return this.path},t}());function w(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function y(t,e,i){for(var n in t)w(t,n)&&e.call(i||t,t[n],n,t)}function x(t){t="Warning: "+t,"undefined"!=typeof console&&console.error(t);try{throw new Error(t)}catch(t){}}var S=String.prototype.replace,C=String.prototype.split,$=function(t){var e=t%10;return 11!==t&&1===e?0:2<=e&&e<=4&&!(t>=12&&t<=14)?1:2},k={arabic:function(t){if(t<3)return t;var e=t%100;return e>=3&&e<=10?3:e>=11?4:5},bosnian_serbian:$,chinese:function(){return 0},croatian:$,french:function(t){return t>1?1:0},german:function(t){return 1!==t?1:0},russian:$,lithuanian:function(t){return t%10==1&&t%100!=11?0:t%10>=2&&t%10<=9&&(t%100<11||t%100>19)?1:2},czech:function(t){return 1===t?0:t>=2&&t<=4?1:2},polish:function(t){if(1===t)return 0;var e=t%10;return 2<=e&&e<=4&&(t%100<10||t%100>=20)?1:2},icelandic:function(t){return t%10!=1||t%100==11?1:0},slovenian:function(t){var e=t%100;return 1===e?0:2===e?1:3===e||4===e?2:3}},I={arabic:["ar"],bosnian_serbian:["bs-Latn-BA","bs-Cyrl-BA","srl-RS","sr-RS"],chinese:["id","id-ID","ja","ko","ko-KR","lo","ms","th","th-TH","zh"],croatian:["hr","hr-HR"],german:["fa","da","de","en","es","fi","el","he","hi-IN","hu","hu-HU","it","nl","no","pt","sv","tr"],french:["fr","tl","pt-br"],russian:["ru","ru-RU"],lithuanian:["lt"],czech:["cs","cs-CZ","sk"],polish:["pl"],icelandic:["is"],slovenian:["sl-SL"]};function P(t){var e,i=(e={},y(I,(function(t,i){y(t,(function(t){e[t]=i}))})),e);return i[t]||i[C.call(t,/-/,1)[0]]||i.en}function M(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var E=/\$/g,A=/%\{(.*?)\}/g;function U(t,e,i,n){if("string"!=typeof t)throw new TypeError("Polyglot.transformPhrase expects argument #1 to be string");if(null==e)return t;var r=t,a=n||A,o="number"==typeof e?{smart_count:e}:e;if(null!=o.smart_count&&r){var s=C.call(r,"||||");r=(s[function(t,e){return k[P(t)](e)}(i||"en",o.smart_count)]||s[0]).replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}return r=S.call(r,a,(function(t,e){return w(o,e)&&null!=o[e]?S.call(o[e],E,"$$"):t}))}function L(t){var e=t||{};this.phrases={},this.extend(e.phrases||{}),this.currentLocale=e.locale||"en";var i=e.allowMissing?U:null;this.onMissingKey="function"==typeof e.onMissingKey?e.onMissingKey:i,this.warn=e.warn||x,this.tokenRegex=function(t){var e=t&&t.prefix||"%{",i=t&&t.suffix||"}";if("||||"===e||"||||"===i)throw new RangeError('"||||" token is reserved for pluralization');return new RegExp(M(e)+"(.*?)"+M(i),"g")}(e.interpolation)}L.prototype.locale=function(t){return t&&(this.currentLocale=t),this.currentLocale},L.prototype.extend=function(t,e){y(t,(function(t,i){var n=e?e+"."+i:i;"object"==typeof t?this.extend(t,n):this.phrases[n]=t}),this)},L.prototype.unset=function(t,e){"string"==typeof t?delete this.phrases[t]:y(t,(function(t,i){var n=e?e+"."+i:i;"object"==typeof t?this.unset(t,n):delete this.phrases[n]}),this)},L.prototype.clear=function(){this.phrases={}},L.prototype.replace=function(t){this.clear(),this.extend(t)},L.prototype.t=function(t,e){var i,n,r=null==e?{}:e;if("string"==typeof this.phrases[t])i=this.phrases[t];else if("string"==typeof r._)i=r._;else if(this.onMissingKey){n=(0,this.onMissingKey)(t,r,this.currentLocale,this.tokenRegex)}else this.warn('Missing translation for key: "'+t+'"'),n=t;return"string"==typeof i&&(n=U(i,r,this.currentLocale,this.tokenRegex)),n},L.prototype.has=function(t){return w(this.phrases,t)},L.transformPhrase=function(t,e,i){return U(t,e,i)};var T=L;var V=window.webix;V&&g(V);var R=function(t,e,i){var n=(i=i||{}).storage,r=n?n.get("lang")||"en":i.lang||"en";function a(e,a,o){a.__esModule&&(a=a.default);var c={phrases:a};i.polyglot&&t.webix.extend(c,i.polyglot);var u=s.polyglot=new T(c);if(u.locale(e),s._=t.webix.bind(u.t,u),r=e,n&&n.put("lang",r),i.webix){var h=i.webix[e];h&&t.webix.i18n.setLocale(h)}return o?Promise.resolve():t.refresh()}function o(e,n){if(!1!==i.path){var r=(i.path?i.path+"/":"")+e;a(e,t.require("jet-locales",r),n)}}var s={getLang:function(){return r},setLang:o,setLangData:a,_:null,polyglot:null};t.setService("locale",s),o(r,!0)},D=window;D.Promise||(D.Promise=D.webix.promise);var O=1;function H(t,e,i){Object.defineProperty(e,i,{get:function(){return t[i]},set:function(e){return t[i]=e}})}function N(t,e){e=e||{};var i={},n={},r=function(t,e){var r=O++;return i[r]={mask:t,handler:e},e("*"===t?n:n[t],void 0,t),r},a=[],o=!1,s=function(t,e,n,r){if(o)a.push([t,e,n,r]);else for(var s=Object.keys(i),c=0;c<s.length;c++){var u=i[s[c]];u&&("*"!==u.mask&&u.mask!==t||u.handler(n,e,t,r))}};return Object.defineProperty(n,"$changes",{value:{attachEvent:r,detachEvent:function(t){delete i[t]}},enumerable:!1,configurable:!1}),Object.defineProperty(n,"$observe",{value:r,enumerable:!1,configurable:!1}),Object.defineProperty(n,"$batch",{value:function(t){if("function"!=typeof t){var e=t;t=function(){for(var t in e)n[t]=e[t]}}for(o=!0,t(n),o=!1;a.length;){var i=a.shift();s.apply(this,i)}},enumerable:!1,configurable:!1}),Object.defineProperty(n,"$extend",{value:function(t,i){for(var r in i=i||e,t)if(t.hasOwnProperty(r)){var a=t[r];i.nested&&"object"==typeof a&&a?n[r]=N(a,i):j(n,a,r,s)}},enumerable:!1,configurable:!1}),n.$extend(t,e),n}function j(t,e,i,n){Object.defineProperty(t,i,{get:function(){return e},set:function(t){if(null===e||null===t?e!==t:e.valueOf()!=t.valueOf()){var r=e;e=t,n(i,r,t,null)}},enumerable:!0,configurable:!1})}var F=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._,i=this.app.getService("helpers");return{padding:20,margin:20,elementsConfig:{labelWidth:130,labelAlign:"right"},view:"form",localId:"form",css:"webix_chat_newchat_form",elements:[{align:"center",body:{view:"forminput",name:"avatar",body:{localId:"avatar",css:"webix_chat_form_avatar",width:130,height:130,borderless:!0,template:function(t){return i.formAvatar(t,e("Change avatar"))},onClick:{webix_chat_avatar:function(){var e=t.app.getService("upload");e.config({upload:"avatar/"+webix.uid()}),e.fileDialog()}}}}},{align:"center",body:{name:"name",localId:"name",inputAlign:"center",view:"text",width:300,placeholder:e("Chat name"),on:{onChange:function(e){t.NameChangedHandler(e)},onTimedKeyPress:function(){t.NameChangedHandler(t.$$("name").getValue())}}}},{}]}},e.prototype.init=function(){var t=this,e=this.app.getService("upload").getUploader();this.on(e,"onAfterFileAdd",(function(e){t.UpdateAvatar(e)})),this.on(e,"onUploadComplete",(function(e){t.UpdateAvatar(e)}));var i=this.getParam("state",!0),n=i.name,r=i.avatar;this.$$("form").setValues({name:n,avatar:{avatar:r}})},e.prototype.ready=function(){var t=this;webix.delay((function(){t.$$("name").focus()}))},e.prototype.UpdateAvatar=function(t){var e=this;if("client"===t.status&&t.file){var i=new FileReader;i.onload=function(){e.SetLocalAvatar(i.result)},i.readAsDataURL(t.file)}else if("server"===t.status){var n=t.value;this.$$("form").setValues({avatar:n},!0),this.AvatarChangedHandler(n),this.SetLocalAvatar(n)}},e.prototype.SetLocalAvatar=function(t){this.$$("avatar").setValues({avatar:t})},e.prototype.SetInitValues=function(){var t=this.getParam("state",!0).values.form,e=t.name,i=t.avatar;(e||i)&&this.$$("form").setValues({name:e,avatar:{avatar:i}})},e.prototype.NameChangedHandler=function(){},e.prototype.AvatarChangedHandler=function(){},e}(h);webix.ui.datafilter.umMasterCheckox=webix.extend({refresh:function(t,e,i){e.onclick=function(){i.checked=!i.checked,e.querySelector(".webix_icon").className="webix_icon wxi-checkbox-"+(i.checked?"marked":"blank"),t.data.each((function(t){return t[i.columnId]=i.checked})),t.refresh(),t.callEvent("onCustomSave",[])}},render:function(t,e){return e.checked?"<span class='webix_icon wxi-checkbox-marked'></span>":"<span class='webix_icon wxi-checkbox-blank'></span>"}},webix.ui.datafilter.masterCheckbox);var B=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this;return{visibleBatch:"default",margin:5,rows:[{batch:"selected",view:"template",localId:"selected",autoheight:!0,scroll:"x",template:"",borderless:!0},{view:"datatable",localId:"table",css:"webix_chat_people_table",rowHeight:60,headerRowHeight:Math.max(webix.skin.$active.barHeight-2,44),columns:this.GetColumns(),scheme:{$sort:{by:"name",dir:"asc"}},checkboxRefresh:!0,on:{onItemClick:function(e){return t.Toggle(1*e.row)},onCustomSave:function(){return t.UpdatePeopleList()}}}]}},e.prototype.init=function(){var t=this,e=this.app.getService("local").users(),i=this.$$("table");this.Users=[].concat(this.getParam("state",!0).users),this.UsersStore=new webix.DataCollection({data:[]}),this.UsersStore.data.attachEvent("onSyncApply",(function(){i.clearAll(),i.parse(t.UsersStore.data.serialize().map((function(t){return{id:t.id,name:t.name,avatar:t.avatar,status:t.status}})).filter((function(e){return e.id!==t.app.config.user}))),i.sort((function(e,i){return t.SortUsers(e,i)})),t.LoadPeopleList()})),this.UsersStore.sync(e)},e.prototype.destroy=function(){this.UsersStore.destructor(),this.UsersStore=null},e.prototype.GetColumns=function(){var t=this,e=this.app.getService("locale")._,i=this.app.getService("helpers");return[{id:"selected",header:{content:"textFilter",placeholder:e("Search"),colspan:2,prepare:function(t){return t.toLowerCase()},compare:this.GetCompare()},width:45,cssFormat:function(e,i){return i.selected?"webix_chat_row_"+(t.Users.indexOf(i.id)>=0?"group_user":"select"):""},template:function(t){return t.selected?i.checkedIcon:i.notCheckedIcon}},{id:"name",header:"",template:function(t){return i.listAvatar(t,"webix_chat_people_avatar")+t.name},fillspace:2,cssFormat:function(e,i){return i.selected?"webix_chat_row_"+(t.Users.indexOf(i.id)>=0?"group_user":"select"):""}}]},e.prototype.GetCompare=function(){return function(t,e,i){return i.name.toLowerCase().indexOf(e)>-1}},e.prototype.GetPeopleList=function(t){var e=this;return t.sort((function(t,i){return e.SortUsers(t,i)})),this.app.getService("helpers").peopleList(t,!1,this.Users)},e.prototype.SortUsers=function(t,e){var i=this.Users.indexOf(t.id),n=this.Users.indexOf(e.id);return i>=0&&n<0?1:n>=0&&i<0?-1:t.name>e.name?1:t.name<e.name?-1:0},e.prototype.Toggle=function(t){var e=this.$$("table"),i=e.getItem(t);e.updateItem(t,{selected:!i.selected}),this.UpdatePeopleList()},e.prototype.UpdatePeopleList=function(){var t=this.GetSelected();this.SetBatch(t.length?"selected":"default");var e=this.GetPeopleList(t);this.$$("selected").setHTML(e),this.getParam("state",!0).users=this.GetSelectedIds()},e.prototype.LoadPeopleList=function(){var t=this,e=this.getParam("state",!0).users.filter((function(e){return e!==t.app.config.user}));if(e&&e.length){var i=[];e.forEach((function(e){var n=t.$$("table").getItem(e);i.push(n),n.selected=!0})),this.SetBatch("selected");var n=this.GetPeopleList(i);this.$$("selected").setHTML(n)}},e.prototype.GetSelected=function(){var t=[];return this.$$("table").data.each((function(e){e.selected&&t.push(e)})),t},e.prototype.GetSelectedIds=function(){var t=[];return this.$$("table").data.each((function(e){e.selected&&t.push(e.id)})),t},e.prototype.SetBatch=function(t){t?this.getRoot().showBatch(t):this.getRoot().showBatch("default")},e}(h),z=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){return{view:"toolbar",height:Math.max(webix.skin.$active.toolbarHeight,46),borderless:!0,cols:[]}},e.prototype.init=function(){var t=this,e=this.getParam("state",!0);this.on(e.$changes,"toolbar",(function(){var i=e.toolbar.cols.map((function(i){return t.ButtonFactory(i,e)}));t.webix.ui(i,t.getRoot())}))},e.prototype.ButtonFactory=function(t,e){var i=this,n=this.app.getService("locale")._;switch(t){case"close":return{view:"icon",icon:"wxi-close",hotkey:"esc",width:Math.max(webix.skin.$active.inputHeight,38),click:function(){e.cursor=0}};case"back":return{view:"icon",icon:"chi-back",width:Math.max(webix.skin.$active.inputHeight,38),hotkey:"esc",click:function(){e.cursor=e.cursor-1}};case"start":return{view:"icon",icon:"chi-back",width:Math.max(webix.skin.$active.inputHeight,38),hotkey:"esc",click:function(){i.app.callEvent("wizardStart",[])}};case"label":return{view:"label",css:"webix_chat_wizard_title",labelAlign:"center",label:"function"==typeof e.toolbar.label?e.toolbar.label():e.toolbar.label};case"edit":return{view:"icon",icon:"wxi-pencil",width:Math.max(webix.skin.$active.inputHeight,38),batch:"m1",click:function(){e.cursor=e.cursor+1}};case"save":return{batch:"m2",view:"button",label:n("Save"),hotkey:"enter",width:130,css:"webix_primary",click:function(){i.app.callEvent("wizardSave",[])}}}},e}(h),q=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){return this.Compact=this.getParam("compact",!0),{view:"window",modal:!0,move:!0,fullscreen:this.Compact,position:"center",width:450,height:600,borderless:!0,head:z,body:{$subview:!0}}},e.prototype.init=function(){var t=this,e=this.getParam("id")||0,i=e?this.app.getService("local").chats().getItem(e):{id:0,name:"",users:[],avatar:""},n=N({cursor:1,toolbar:{label:"",cols:[]},chat:i.id,name:i.name,avatar:i.avatar,users:[].concat(i.users),group:!i.direct_id});this.setParam("state",n);var r=this.stages();this.on(n.$changes,"cursor",(function(e){webix.delay((function(){r[e]?(t.show(r[e][0]),n.toolbar=r[e][1]):t.Close()}))})),this.on(this.app,"wizardSave",(function(){t.Save&&(t.Save(),t.Close())}))},e.prototype.Close=function(){this.show("_hidden",{target:"top"})},e}(h),G=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.init=function(){var e=this;return this.on(this.app,"wizardSave",(function(){return e.Save()})),t.prototype.init.call(this)},e.prototype.Save=function(){var t=this.getParam("state",!0),e=this.app.getService("operations"),i=this.$$("form").getValues();e.updateChat(t.chat,i.name,i.avatar.avatar),t.$batch({name:i.name,avatar:i.avatar.avatar,cursor:1})},e}(F),W=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.stages=function(){var t=this,e=this.app.getService("locale")._;return[null,["./chat.info.info",{label:function(){return t.getParam("state").name},cols:["close","label","edit"]}],["./chat.info.form",{label:'<span class="webix_chat_wizard_title2">'+e("Edit chat")+"</span>",cols:["back","label","save"]}],["./chat.info.people",{label:'<span class="webix_chat_wizard_title2">'+e("Add members")+"</span>",cols:["start","label","save"]}]]},e.prototype.init=function(){var e=this;t.prototype.init.call(this),this.on(this.app,"leaveChatClick",(function(){e.LeaveChat()}))},e.prototype.LeaveChat=function(){var t=this,e=this.app.getService("locale")._;webix.confirm({title:e("Leave chat"),ok:e("Leave"),cancel:e("Cancel"),text:e("Are you sure to leave this chat?")}).then((function(){t.app.getService("operations").leaveChat(t.getParam("state").chat),t.Close()}))},e}(q),J=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._,i=this.getParam("state",!0),n=this.app.getService("helpers");this.ShowAll=!1,this.MemberListMaxCount=3,this.CanAddUsers=i.group;var r={localId:"avatar",css:"webix_chat_form_avatar",width:130,height:130,borderless:!0,template:function(t){return n.formAvatar(t,e("Avatar"))},data:{avatar:i.avatar}},a={view:"list",localId:"members",css:"webix_chat_list",borderless:!0,autoheight:!0,type:{height:60,template:function(e){return t.ListTemplate(e)},text:function(t){return t.replace(/<[^>]*>/g,"")}},onClick:{webix_chat_list_item_delete:function(e,i){return t.DeleteMemberClickHandler(i)}}},o={view:"button",type:"icon",width:150,height:Math.max(webix.skin.$active.inputHeight,38),icon:"wxi-plus",label:"Add members",click:function(){return i.cursor=3}},s={view:"button",css:"webix_chat_delete_button",label:e("Leave chat"),width:130,click:function(){return t.LeaveChat()}},c=[{type:"form",cols:[{},r,{}]},{type:"form",rows:[{cols:[{view:"label",label:e("Members")+" ("+i.users.length+")"},o]},a,{localId:"showAllButton",hidden:!0,autoheight:!0,borderless:!0,view:"template",template:'<span class="webix_chat_show_all_btn">'+e("Show all members")+"</span>",css:"webix_chat_show_all_tmpl",onClick:{webix_chat_show_all_btn:function(){return t.ShowAllMembers(i.users)}},inputWidth:150}]},{}];return i.group&&c.push({type:"form",padding:{top:0},cols:[s,{}]}),{view:"form",type:"clean",scroll:!0,borderless:!0,elements:c}},e.prototype.init=function(){var t=this,e=this.getParam("state",!0);this.$$("members")&&this.InitMembersList(e.users),this.on(e.$changes,"users",(function(e){return t.Filter(e)}))},e.prototype.InitMembersList=function(t){var e=this,i=this.app.getService("local"),n=this.$$("members");n.data.attachEvent("onSyncApply",(function(){n.data.sort((function(t,i){return e.Sort(t,i)}),"asc"),e.Filter(t)})),n.sync(i.users())},e.prototype.ListTemplate=function(t){var e=this.app.getService("locale")._,i=t.id==this.app.config.user?" (<span class='webix_chat_list_you_text'>"+e("You")+"</span>)":"";return this.app.getService("helpers").listAvatar(t)+t.name+i+this.DeleteButtonTemplate(t)},e.prototype.DeleteButtonTemplate=function(t){var e="";return t.id!=this.app.config.user&&this.CanAddUsers&&(e="<button type='button' class='webix_icon_button webix_chat_list_item_delete'><span class='webix_icon wxi-close'></span></button>"),e},e.prototype.Sort=function(t,e){return e.id==this.app.config.user?1:t.id==this.app.config.user?-1:t.name>e.name?1:-1},e.prototype.ShowAllMembers=function(t){this.ShowAll=!0,this.Filter(t),this.$$("showAllButton").hide()},e.prototype.Filter=function(t){var e=this;this.MemberListCount=0,this.$$("members").data.filter((function(i){var n=i.direct_id==i.id,r=t&&t.indexOf(i.id)>-1,a=n||r;return a&&!e.ShowAll&&e.MemberListCount++,a&&e.MemberListCount<=e.MemberListMaxCount})),this.MemberListCount>this.MemberListMaxCount&&this.$$("showAllButton").show()},e.prototype.DeleteMemberClickHandler=function(t){var e=this,i=this.app.getService("locale")._,n=this.app.getService("operations");webix.confirm({title:i("Delete member"),ok:i("Delete"),cancel:i("Cancel"),text:i("Are you sure to delete this member?")}).then((function(){var i=e.getParam("state",!0);i.users=i.users.filter((function(e){return e!=t})),n.setUsers(i.chat,i.users)}))},e.prototype.LeaveChat=function(){var t=this,e=this.app.getService("locale")._;webix.confirm({title:e("Leave chat"),ok:e("Leave"),cancel:e("Cancel"),text:e("Are you sure to leave this chat?")}).then((function(){var e=t.app.getService("operations"),i=t.getParam("state",!0);e.leaveChat(i.chat),i.cursor=0}))},e}(h),K=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.init=function(){var e=this,i=this.getParam("state",!0);return this._users=[].concat(i.users),this.on(this.app,"wizardStart",(function(){return e.Back()})),this.on(this.app,"wizardSave",(function(){return e.Save()})),t.prototype.init.call(this)},e.prototype.Save=function(){var t=this.getParam("state",!0);this.app.getService("operations").setUsers(t.chat,t.users),t.cursor=1},e.prototype.Back=function(){this.getParam("state",!0).$batch({cursor:1,users:this._users})},e}(B),Y=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.stages=function(){return[null,["./chat.common.people",{label:'<span class="webix_chat_wizard_title2">'+(0,this.app.getService("locale")._)("Add members")+"</span>",cols:["close","label","save"]}]]},e.prototype.Save=function(){var t=this.app,e=this.getParam("state");e.users.length&&t.getService("operations").setUsers(e.chat,e.users)},e}(q),Z=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var e=this,i=this.app.getService("locale")._,n=t.prototype.config.call(this,!0),r={view:"button",localId:"next",type:"icon",hotkey:"enter",icon:"chi-next",css:"webix_primary",label:'<span class="webix_chat_next_text">'+i("People")+"</span>",width:160,disabled:!0,height:Math.max(webix.skin.$active.inputHeight,38),align:"center",click:function(){e.ShowNextPage()}};return n.elements.push({align:"right",body:r}),n},e.prototype.ShowNextPage=function(){var t=this.getParam("state",!0),e=this.$$("form").getValues();t.name=e.name,t.avatar=e.avatar.avatar,t.cursor=t.cursor+1},e.prototype.NameChangedHandler=function(t){var e=this.$$("next");t?e.enable():e.disable()},e}(F),Q=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.stages=function(){var t=this.app.getService("locale")._;return[null,["./chat.new.form",{label:'<span class="webix_chat_wizard_title1">'+t("New chat")+"</span>",cols:["close","label"]}],["./chat.common.people",{label:'<span class="webix_chat_wizard_title2">'+t("Add members")+"</span>",cols:["back","label","save"]}]]},e.prototype.Save=function(){var t=this.app,e=this.getParam("state"),i=e.name,n=e.avatar,r=e.users;r&&r.length&&t.getService("operations").addGroupChat(i,n,r).then((function(e){return t.callEvent("showChat",["chat",e])}))},e}(q),X=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this;return{view:"list",localId:"list",select:!0,css:"webix_chat_list",type:{height:60,template:function(e,i){return t.ListTemplate(e,i)},text:function(t){return t.replace(/<[^>]*>/g,"")}}}},e.prototype.InitSelf=function(t,e){var i=this,n=this.$$("list");n.data.attachEvent("onSyncApply",(function(){i.ApplySearchValue(),i.SyncHandler()})),n.sync(t,e||null),n.attachEvent("onAfterSelect",(function(t){i.SelectHandler(t)})),this.on(this.app.getState().$changes,"search",(function(t){i.Find(t)}))},e.prototype.SyncHandler=function(){},e.prototype.SelectHandler=function(){},e.prototype.ListTemplate=function(t){return t.name},e.prototype.EscapeRegExp=function(t){return t.replace(/[[\]{}()*+?.\\^$|]/g,"\\$&")},e.prototype.ApplySearchValue=function(){var t=this.app.getState().search;t&&this.Find(t)},e.prototype.Find=function(t){var e=this,i=this.$$("list");this.EscapedSearchText=this.EscapeRegExp(t||""),t?(t=t.toLowerCase(),i.filter((function(i){return e.SearchCompare(t,i)}))):i.filter()},e.prototype.SearchCompare=function(t,e){return e.name.toLowerCase().indexOf(t)>-1},e.prototype.Select=function(t){var e=this.$$("list");t!=e.getSelectedId()&&e.getItem(t)&&e.select(t)},e}(h),tt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var e=this,i="limited"===this.app.config.mode,n=this.app.getService("locale")._;return{type:"clean",rows:[t.prototype.config.call(this),{padding:9,rows:[{view:"button",type:"icon",icon:"wxi-plus",css:"webix_chat_add_button",height:Math.max(webix.skin.$active.inputHeight,38),label:n("New chat"),click:function(){return e.app.callEvent("newChat",[])},hidden:i}]}]}},e.prototype.init=function(){var t=this,e=this.app.getParam("state",!0),i=this.app.getService("local").chats();this.InitSelf(i),i.waitData.then((function(){t.on(e.$changes,"chatId",(function(e){e?t.Select(e):t.$$("list").unselectAll()}))}))},e.prototype.SelectHandler=function(t){this.app.callEvent("showChat",["chat",1*t])},e.prototype.ListTemplate=function(t,e){var i=this.app.getService("helpers"),n="";if(n+=i.listAvatar(t),n+="<div class='webix_chat_listitem_block'>",n+="<div class='webix_chat_listitem_name'>"+i.addTextMark(t.name,this.EscapedSearchText)+"</div>",t.date&&(n+="<span class='webix_chat_listitem_date'>"+i.dateChatFormat(t.date)+"</span>"),t.unread_count){var r="webix_chat_listitem_number";t.unread_count>9&&(r+=" webix_chat_listitem_number_wide"),n+="<span class='"+r+"'>"+t.unread_count+"</span>"}return t.message&&(n+="<div class='webix_chat_listitem_message'>"+e.text(t.message)+"</div>"),n+"</div>"},e}(X);webix.protoUI({name:"chat-search",$cssName:"search",on_click:{webix_input_icon:function(t){t.target.className.indexOf(this.config.closeIcon)>-1?(this.getInputNode().focus(),this.setValue(""),this.callEvent("onCloseIconClick",[t]),this.hideCloseIcon()):(this.getInputNode().focus(),this.callEvent("onSearchIconClick",[t]))}},setIcon:function(t){var e=this.$view.getElementsByClassName("webix_input_icon");e.length&&(e[0].className="webix_input_icon "+t)},showCloseIcon:function(){this.setIcon(this.config.closeIcon)},hideCloseIcon:function(){this.setIcon(this.config.icon)},defaults:{closeIcon:"wxi-close"}},webix.ui.search);var et=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._;return{css:"webix_chat_sidebar",width:320,type:"clean",rows:[{view:"tabbar",css:"webix_chat_tabbar",height:52,bottomOffset:0,options:[{value:e("Chats"),id:"chats"},{value:e("Users"),id:"users"}],on:{onChange:function(e){return t.ShowPanel(e)}}},{padding:9,rows:[{view:"chat-search",localId:"search",height:Math.max(webix.skin.$active.inputHeight,38),placeholder:e("Search")}]},{$subview:!0,name:"left"}]}},e.prototype.init=function(){var t=this;this.State=this.getParam("state",!0),this.ShowPanel("chats"),this.$$("search").attachEvent("onTimedKeyPress",(function(){t.State.search=t.$$("search").getValue()})),this.$$("search").attachEvent("onChange",(function(){t.State.search=t.$$("search").getValue()})),this.on(this.State.$changes,"search",(function(e){e?t.$$("search").showCloseIcon():(t.$$("search").setValue(""),t.$$("search").hideCloseIcon())}))},e.prototype.ShowPanel=function(t){this.State.search="",this.show("./"+t,{target:"left"})},e}(h),it=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this;return{view:"sidemenu",width:320,position:"left",state:function(e){e.left=t.Parent.left,e.top=t.Parent.top,e.height=t.Parent.height},body:et}},e.prototype.init=function(){var t=this;this.on(this.app,"top:navigation",(function(){t.getRoot().hide()}))},e.prototype.Show=function(t){var e=this;this.getRoot().isVisible()||(this.Parent=t,this.webix.delay((function(){return e.getRoot().show()})))},e}(h),nt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._;this.Compact=this.getParam("compact",!0);var i=this.app.config.mode;return this.Limited="single"===i||"limited"===i,{view:"toolbar",localId:"toolbar",visibleBatch:"active",height:50,css:"webix_chat_toolbar",padding:{right:5},elements:[{view:"icon",icon:"webix_icon chi-menu",click:function(){return t.app.callEvent("showSidebar",[])},hidden:!this.Compact||"single"===i},{view:"template",localId:"chatTitle",css:"webix_chat_toolbar_tmpl",name:"chatTitle",borderless:!0,template:function(e){return t.TitleTemplate(e)},onClick:{webix_chat_title:function(){t.ChatInfoHandler()}}},{view:"icon",batch:"active",icon:"chi-account-plus",tooltip:e("Add members"),width:Math.max(webix.skin.$active.inputHeight,38),click:function(){t.NewMembersHandler()}},{view:"icon",batch:"active",icon:"wxi-dots",width:Math.max(webix.skin.$active.inputHeight,38),click:function(e,i){t.ToggleMenu(i)}}]}},e.prototype.init=function(){var t=this,e=this.getParam("state",!0);this.State=e,this.app.getService("local").chats().data.attachEvent("onStoreUpdated",(function(i){i&&i!=e.chatId||t.Refresh()})),this.on(e.$changes,"*",(function(){t.Refresh()})),this.InitMenu()},e.prototype.Refresh=function(){var t=this.State;if(!this.getRoot())return!1;var e,i=this.app.getService("local");t.chatId?e=i.chats().getItem(t.chatId):e=i.users().getItem(t.userId);this.$$("chatTitle").setValues(e||{});var n=this.$$("toolbar");t.chatId&&!this.Limited?n.showBatch("active"):n.showBatch("inactive")},e.prototype.TitleTemplate=function(t){var e=this.app.getService("locale")._,i=this.app.getService("helpers"),n="";if(t.name)if(n+=i.listAvatar(t,"webix_chat_toolbar_avatar"),t.users){var r=t.users.length+" "+e("members");n+="<div class='webix_chat_title'>",t.direct_id?n+='<span class="webix_chat_messages_chat_name">'+t.name+"</span>":n+='<div class="webix_chat_messages_groupchat_name">'+t.name+'</div><div class="webix_chat_messages_groupchat_members">'+r+"</div>",n+="</div>"}else n+='<span class="webix_chat_messages_user_name">'+t.name+"</span>";return n},e.prototype.ToggleMenu=function(t){this.ToolbarMenu.isVisible()?this.ToolbarMenu.hide():this.ToolbarMenu.show(t.target,{pos:"left",y:30,x:10})},e.prototype.InitMenu=function(){var t=this;return this.ToolbarMenu=this.ui({view:"contextmenu",autowidth:!0,point:!1,data:this.GetMenuData(),on:{onItemClick:function(e){t.ToolbarMenu.callEvent("onBeforeMenuAction",[e])&&"info"==e&&t.ChatInfoHandler()}}}),this.ToolbarMenu},e.prototype.GetMenuData=function(){return[{id:"info",value:(0,this.app.getService("locale")._)("Chat info")}]},e.prototype.ChatInfoHandler=function(){this.State.chatId&&!this.Limited&&this.app.callEvent("chatInfo",[this.State.chatId])},e.prototype.NewMembersHandler=function(){this.app.callEvent("newMembers",[this.State.chatId])},e}(h),rt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("helpers"),i={view:"comments",sendAction:"enter",localId:"comments",currentUser:this.app.config.user,users:new webix.DataCollection({data:[],scheme:{$init:function(t){t.value=t.name,t.image=t.avatar}}}),listItem:{templateUser:function(e){var i=t.Comments.getUsers();return"<span class = 'webix_comments_name'>"+((i&&i.exists(e.user_id)?i.getItem(e.user_id):{}).name||"")+"</span>"},templateAvatar:function(i){var n="<div class='webix_chat_list_avatar'>",r=t.Comments.getUsers(),a=r&&r.exists(i.user_id)?r.getItem(i.user_id):{};return a.status&&(n+=e.status(a)),n+=e.avatar(a),n+="</div>"},templateDate:function(t){return t.date?"<span class='webix_comments_date'>"+e.dateChatFormat(t.date)+"</span>":""}}};return{rows:[nt,i]}},e.prototype.init=function(){var t=this,e=this.Comments=this.$$("comments"),i=this.getParam("state",!0),n=this.app.getService("local"),r=this.app.getService("backend"),a=this.app.getService("operations");e.getUsers().sync(n.users()),e.attachEvent("onAfterAdd",(function(n){var r=e.getItem(n);if(!r.chat_id){var o=i.userId,s=r.text.replace(/</g,"&lt;");s!==r.text&&e.updateItem(n,{text:s}),i.chatId?(t.AddMessage(i.chatId,r.text,n),t.ScrollToBottom()):o&&(e.disable(),a.addChat(o).then((function(e){return t.AddMessage(e,r.text,n)})).then((function(){return t.app.callEvent("showChat",["user",o])})))}})),e.attachEvent("onBeforeDelete",(function(i){return t.IsUsersMessage(e.getItem(i))&&a.removeMessage(i),!0})),e.attachEvent("onDataUpdate",(function(e,i){t.IsUsersMessage(i)&&a.updateMessage(e,i.text)})),this.on(this.app,"showChat",(function(){var r=n.chats();r.waitData.then((function(){t.getRoot()&&t.FilterUsers(e.getUsers(),r,i.chatId,i.userId)}))})),this.on(r.pubsub(),"messages",(function(n){var r=n.op,a=n.origin,o=n.msg;if(o.chat_id==i.chatId)switch(r){case"add":o.date=new Date(o.date),e.exists(a)?(e.queryView("list").data.changeId(a,o.id),e.updateItem(o.id,o)):e.exists(o.id)||(e.add(o),t.ScrollToBottom());break;case"remove":e.exists(o.id)&&e.remove(o.id);break;case"update":o.date=new Date(o.date),e.exists(o.id)&&e.updateItem(o.id,o)}})),this.on(i.$changes,"chatId",(function(){t.LoadChat(i.chatId,i.userId)}))},e.prototype.urlChange=function(){},e.prototype.IsUsersMessage=function(t){return t.user_id==this.app.config.user},e.prototype.AddMessage=function(t,e,i){var n=this;return this.app.getService("operations").addMessage(t,i,e).then((function(t){n.Comments.exists(i)&&n.Comments.queryView("list").data.changeId(i,t.id)}))},e.prototype.ScrollToBottom=function(){var t=this.$$("comments").queryView("list");t.showItem(t.getLastId())},e.prototype.LoadChat=function(t,e){var i=this,n=this.app.getService("local"),r=this.app.getService("operations"),a=this.$$("comments");a.clearAll(),t||e?(a.enable(),t&&n.messages(t).then((function(e){i.getRoot()&&(a.parse(e),r.resetCounter(t),i.ScrollToBottom())})),this.Focus()):a.disable()},e.prototype.FilterUsers=function(t,e,i,n){var r=this,a=i?e.getItem(i):null;t.data.filter((function(t){return i?a&&a.users.indexOf(t.id)>=0&&t.id!=r.app.config.user:t.id==n}))},e.prototype.Focus=function(){var t=this;webix.delay((function(){t.getRoot()&&t.Comments.focus()}))},e}(h);webix.protoUI({name:"r-layout",sizeTrigger:function(t,e,i){this._compactValue=i,this._compactWidth=t,this._compactHandler=e,this._checkTrigger(this.$view.width,i)},_checkTrigger:function(t,e){return!this._compactWidth||!(t<=this._compactWidth&&!e||t>this._compactWidth&&e)||(this._compactWidth=null,this._compactHandler(!e),!1)},$setSize:function(t,e){if(this._checkTrigger(t,this._compactValue))return webix.ui.layout.prototype.$setSize.call(this,t,e)}},webix.ui.layout);var at=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t="single"===this.app.config.mode,e=this.getParam("forceCompact"),i=void 0!==e||t;return i&&this.setParam("compact",e||t),this.Compact=this.getParam("compact"),{view:i?"layout":"r-layout",id:"main",rows:[{cols:this.Compact?[{$subview:!0}]:[et,{$subview:!0}]},{$subview:!0,name:"top",popup:!0}]}},e.prototype.init=function(){var t=this,e=this.app.getService("local"),i=this.getRoot();i.sizeTrigger&&i.sizeTrigger(this.app.config.compactWidth,(function(e){return t.SetCompactMode(e)}),!!this.Compact),this.ShowDefaultChat(),this.on(this.app,"showSidebar",(function(){return t.ShowSidebar()})),this.on(this.app,"showChat",(function(i,n){var r=null;if("user"===i){r=n;var a=e.chats().find((function(t){return t.direct_id==n}),!0);n=a?a.id:null}else{(a=e.chats().getItem(n)).direct_id&&(i="user",r=a.direct_id)}t.ShowChat(i,n,r)})),this.on(this.app,"leaveChat",(function(e){t.LeaveChat(e)})),this.on(this.app,"removeChatMember",(function(e){t.LeaveChat(e,!0)})),this.on(this.app,"newChat",(function(){t.ShowChatWindow()})),this.on(this.app,"chatInfo",(function(e){t.ShowChatInfo(e)})),this.on(this.app,"newMembers",(function(e){t.ShowNewMembersWindow(e)}))},e.prototype.ShowDefaultChat=function(){var t=this,e=this.getParam("state"),i=this.app.getService("local").chats();i.waitData.then((function(){e.chatId||(i.count()?e.chatId=i.getFirstId():t.Compact&&t.ShowSidebar())}))},e.prototype.ShowChat=function(t,e,i){this.getParam("state").$batch({chatId:e,chatType:t,userId:i}),this.show("_hidden",{target:"top"})},e.prototype.ShowChatWindow=function(){this.show("chat.new",{target:"top"})},e.prototype.ShowChatInfo=function(t){this.show("chat.info",{target:"top",params:{id:t}})},e.prototype.ShowNewMembersWindow=function(t){this.show("chat.members",{target:"top",params:{id:t}})},e.prototype.LeaveChat=function(t,e){var i=this.app.getService("locale")._,n=this.getParam("state");t===n.chatId&&(e&&webix.alert(i("You have been removed from the group")),n.$batch({chatId:0,chatType:"",userId:0}))},e.prototype.SetCompactMode=function(t){var e=this;webix.delay((function(){e.setParam("compact",t),e.refresh()}))},e.prototype.ShowSidebar=function(){this.SideMenu&&this.SideMenu.getRoot()||(this.SideMenu=this.ui(it));var t=this.$$("main").$view.getBoundingClientRect();this.SideMenu.Show(t)},e}(h),ot=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.init=function(){var t=this.app.getService("local").users();this.InitSelf(t)},e.prototype.SyncHandler=function(){var t=this;this.$$("list").data.filter((function(e){return e.id!=t.app.config.user})),this.$$("list").data.silent((function(){this.sort("name","asc")}))},e.prototype.SelectHandler=function(t){this.app.callEvent("showChat",["user",1*t])},e.prototype.ListTemplate=function(t){var e=this.app.getService("helpers");return e.listAvatar(t)+e.addTextMark(t.name,this.EscapedSearchText)},e}(X),st={JetView:h};st["chat/common/form"]=F,st["chat/common/people"]=B,st["chat/common/toolbar"]=z,st["chat/common/window"]=q,st["chat/info/form"]=G,st["chat/info"]=W,st["chat/info/info"]=J,st["chat/info/people"]=K,st["chat/members"]=Y,st["chat/new/form"]=Z,st["chat/new"]=Q,st.chats=tt,st["compact/sidemenu"]=it,st.list=X,st.messages=rt,st["messages/toolbar"]=nt,st.sidebar=et,st.top=at,st.users=ot;var ct=function(){function t(t){this.app=t,this._messages={},this._subs=[]}return t.prototype.users=function(){var t=this;if(!this._users){var e=this.app.getService("backend");this._users=new webix.DataCollection({}),e.users().then((function(e){return t._users.parse(e)})),this._subs.push(e.pubsub().attachEvent("users",(function(e){var i,n=e.op,r=e.user_id,a=e.data;switch(n){case"online":(i=t._users.getItem(r))&&i.status!=a&&t._users.updateItem(r,{status:a})}})))}return this._users},t.prototype.chats=function(){var t=this,e=this.app.getState();if(!this._chats){this._chats=new webix.DataCollection({scheme:{$change:function(e){if(e.date&&"string"==typeof e.date&&(e.date=new Date(e.date)),e.direct_id){var i=t.users().getItem(e.direct_id);e.name||(e.name="PM: "+i.name),e.avatar||(e.avatar=i.avatar)}},$sort:{by:"date",dir:"desc",as:"date"}}});var i=this.app.getService("backend");Promise.all([i.chats(),this.users().waitData]).then((function(e){t._chats.parse(e[0])})),this._subs.push(i.pubsub().attachEvent("chats",(function(e){var i,n=e.op,r=e.chat_id,a=e.data;switch(n){case"add":case"update":if(-1==a.users.indexOf(t.app.config.user))return void(t._chats.exists(r)&&(t.app.callEvent("removeChatMember",[r]),t._chats.remove(r)));t._chats.exists(r)?(i={name:a.name,avatar:a.avatar,users:a.users},a.direct_id||(i.direct_id=0),t._chats.updateItem(r,i)):t._chats.add(a,0);break;case"message":t._chats.updateItem(r,{message:a.message,date:new Date(a.date)})}}))),this._subs.push(i.pubsub().attachEvent("messages",(function(n){var r,a=n.op,o=n.msg;switch(a){case"add":(r=t._chats.getItem(o.chat_id))&&(e.chatId!=r.id?t._chats.updateItem(r.id,{message:o.text,unread_count:r.unread_count+1,date:o.date}):(t._chats.updateItem(r.id,{message:o.text,date:o.date}),i.resetCounter(r.id)),t._chats.getIndexById(r.id)&&t._chats.moveTop(r.id))}})))}return this._chats},t.prototype.messages=function(t){var e=this.app.getService("backend");return this._messages[t]=e.messages(t)},t}(),ut=function(){function t(t){var e=t.url,i=t.token;this._url=e,this._token=i,this._mode=1,this._seed=1,this._queue=[],this.data={},this.api={},this._events={}}return t.prototype.headers=function(){return{Accept:"application/json","Content-Type":"application/json","Remote-Token":this._token}},t.prototype.fetch=function(t,e){var i={credentials:"include",headers:this.headers()};return e&&(i.method="POST",i.body=e),fetch(t,i).then((function(t){return t.json()}))},t.prototype.load=function(t){var e=this;return t&&(this._url=t),this.fetch(this._url).then((function(t){return e.parse(t)}))},t.prototype.parse=function(t){var e=t.key,i=t.websocket;for(var n in e&&(this._token=t.key),t.data)this.data[n]=t.data[n];for(var r in t.api){var a=this.api[r]={},o=t.api[r];for(var s in o)a[s]=this._wrapper(r+"."+s)}return i&&this.connect(),this},t.prototype.connect=function(){var t=this,e=this._socket;e&&(this._socket=null,e.onclose=function(){},e.close()),this._mode=2,this._socket=function(e,i,n,r){var a=i;"/"===a[0]&&(a=document.location.protocol+"//"+document.location.host+i);var o=-1!=(a=a.replace(/^http(s|):/,"ws$1:")).indexOf("?")?"&":"?";a=""+a+o+"token="+n+"&ws=1";var s=new WebSocket(a);return s.onclose=function(){return setTimeout((function(){return e.connect()}),2e3)},s.onmessage=function(i){var n=JSON.parse(i.data);switch(n.action){case"result":e.result(n.body,[]);break;case"event":e.fire(n.body.name,n.body.value);break;case"start":t._mode=3,t._send(),t._resubscribe();break;default:e.onError(n.data)}},s}(this,this._url,this._token)},t.prototype._wrapper=function(t){return function(){var e=this,i=[].slice.call(arguments),n=null,r=new Promise((function(r,a){n={data:{id:e._uid(),name:t,args:i},status:1,resolve:r,reject:a},e._queue.push(n)}));return this.onCall(n,r),3===this._mode?this._send(n):setTimeout((function(){return e._send()}),1),r}.bind(this)},t.prototype._uid=function(){return(this._seed++).toString()},t.prototype._send=function(t){var e=this;if(2!=this._mode){var i=t?[t]:this._queue.filter((function(t){return 1===t.status}));if(i.length){var n=i.map((function(t){return t.status=2,t.data}));3!==this._mode?this.fetch(this._url,JSON.stringify(n)).catch((function(t){return e.onError(t)})).then((function(t){return e.result(t,n)})):this._socket.send(JSON.stringify({action:"call",body:n}))}}else setTimeout((function(){return e._send()}),100)},t.prototype.result=function(t,e){var i={};if(t)for(var n=0;n<t.length;n++)i[t[n].id]=t[n];else for(var r=0;r<e.length;r++)i[e[r].id]={id:e[r].id,error:"Network Error",data:null};for(var a=this._queue.length-1;a>=0;a--){var o=this._queue[a],s=i[o.data.id];s&&(this.onResponse(o,s),s.error?o.reject(s.error):o.resolve(s.data),this._queue.splice(a,1))}},t.prototype.on=function(t,e){var i=this._uid(),n=this._events[t],r=!!n;return r||(n=this._events[t]=[]),n.push({id:i,handler:e}),r||3!=this._mode||this._socket.send(JSON.stringify({action:"subscribe",name:t})),{name:t,id:i}},t.prototype._resubscribe=function(){if(3==this._mode)for(var t in this._events)this._socket.send(JSON.stringify({action:"subscribe",name:t}))},t.prototype.detach=function(t){if(t){var e=t.id,i=t.name,n=this._events[i];if(n){var r=n.filter((function(t){return t.id!=e}));r.length?this._events[i]=r:(delete this._events[i],3==this._mode&&this._socket.send(JSON.stringify({action:"unsubscribe",name:i})))}}else{if(3==this._mode)for(var a in this._events)this._socket.send(JSON.stringify({action:"unsubscribe",key:a}));this._events={}}},t.prototype.fire=function(t,e){var i=this._events[t];if(i)for(var n=0;n<i.length;n++)i[n].handler(e)},t.prototype.onError=function(t){return null},t.prototype.onCall=function(t,e){},t.prototype.onResponse=function(t,e){},t}(),ht=function(){function t(t){var e=this;this.app=t;var i=new ut({url:t.config.url,token:t.config.token});this._ready=i.load().then((function(i){e._api=i.api,e._data=i.data,e._pubsub={attachEvent:function(t,e){return i.on(t,e)},detachEvent:function(t){return i.detach(t)}};var n=t.config.user=e._data.user;e._data.users.forEach((function(t){t.id===n&&(t.status=2)}))}))}return t.prototype.ready=function(){return this._ready},t.prototype.users=function(){return Promise.resolve(this._data.users)},t.prototype.chats=function(){return Promise.resolve(this._data.chats)},t.prototype.addChat=function(t){return this._api.chat.AddDirect(1*t)},t.prototype.messages=function(t){return this._api.message.GetAll(1*t).then((function(t){return t.forEach((function(t){return t.date=new Date(t.date)})),t}))},t.prototype.addMessage=function(t,e,i){return this._api.message.Add(e,1*t,i.toString()).then((function(t){return t.date=new Date(t.date),t}))},t.prototype.removeMessage=function(t){return this._api.message.Remove(1*t)},t.prototype.updateMessage=function(t,e){return this._api.message.Update(1*t,e)},t.prototype.resetCounter=function(t){this._api.message.ResetCounter(1*t)},t.prototype.pubsub=function(){return this._pubsub},t.prototype.addGroupChat=function(t,e,i){return this._api.chat.AddGroup(t,e,i)},t.prototype.updateChat=function(t,e,i){return this._api.chat.Update(t,e,i)},t.prototype.leave=function(t,e){return this._api.chat.Leave(t,e)},t.prototype.setUsers=function(t,e){return this._api.chat.SetUsers(t,e)},t.prototype.avatarUploadUrl=function(){return this.app.config.url+"/chat/0/avatar"},t}(),pt=function(){function t(t){this._app=t,this._local=this._app.getService("local"),this._back=this._app.getService("backend")}return t.prototype.addChat=function(t){var e=this;return this._back.addChat(t).then((function(t){return e._local.chats().add(t,0),t.id}))},t.prototype.addMessage=function(t,e,i){var n=this._local.chats();return n.updateItem(t,{message:this._getMessageText(i),date:new Date}),n.getIndexById(t)&&n.moveTop(t),this._back.addMessage(t,i,e)},t.prototype.removeMessage=function(t){return this._back.removeMessage(t)},t.prototype.updateMessage=function(t,e){return this._back.updateMessage(t,e)},t.prototype._getMessageText=function(t){return t.substr(0,Math.min(t.length,80))},t.prototype.resetCounter=function(t){this._back.resetCounter(t);var e=this._local.chats();e.exists(t)&&e.updateItem(t,{unread_count:0})},t.prototype.addGroupChat=function(t,e,i){var n=this;return this._back.addGroupChat(t,e,i).then((function(t){return n._local.chats().add(t,0),t.id}))},t.prototype.updateChat=function(t,e,i){var n=this;return this._back.updateChat(t,e,i).then((function(e){n._local.chats().updateItem(t,e)}))},t.prototype.leaveChat=function(t){var e=this;return this._back.leave(t,this._app.config.user).then((function(){e._app.callEvent("leaveChat",[t]),e._local.chats().remove(t)}))},t.prototype.setUsers=function(t,e){var i=this;return this._back.setUsers(t,e).then((function(e){var n=i._local.chats();e.id==t?n.updateItem(t,e):(n.add(e,0),i._app.callEvent("showChat",[n,e.id]))}))},t}(),lt=function(){function t(t){this.app=t,this.initUploader()}return t.prototype.initUploader=function(){var t=this;this.uploader=webix.ui({view:"uploader",apiOnly:!0,accept:"image/*",autosend:!0,on:{onBeforeFileAdd:function(){return t.configUpload()}}})},t.prototype.config=function(t){webix.extend(this.uploader.config,t,!0)},t.prototype.getUploader=function(){return this.uploader},t.prototype.configUpload=function(){this.uploader.config.upload=this.app.getService("backend").avatarUploadUrl()},t.prototype.fileDialog=function(){this.uploader.fileDialog()},t}(),ft=function(){function t(){this.statusMap={1:"none",2:"active",3:"busy",4:"away"},this.checkedIcon="<span class='webix_icon wxi-checkbox-marked'></span>",this.notCheckedIcon="<span class='webix_icon wxi-checkbox-blank'></span>",this.dateMask="%d.%m.%Y",this.weekMask="%D",this.todayDateMask="%H:%i"}return t.prototype.status=function(t){return"<span class = 'webix_chat_status webix_chat_status_"+this.statusMap[t.status]+"'></span>"},t.prototype.listAvatar=function(t,e){var i="<div class='"+("string"==typeof e?e:"webix_chat_list_avatar")+"'>";return t.status&&(i+=this.status(t)),i+=this.avatar(t),i+="</div>"},t.prototype.initials=function(t){var e=t.match(/\b\w/g)||[];return((e.shift()||"")+(e.pop()||"")).toUpperCase()},t.prototype.avatar=function(t,e){var i="string"==typeof e?e:"webix_chat_avatar";return t.avatar?'<img alt="" class="'+i+'" src="'+t.avatar+'"/>':t.name?"<div class='"+i+"'>"+this.initials(t.name||"")+"</div>":"<div class='"+i+" webix_icon wxi-user'></div>"},t.prototype.formAvatar=function(t,e){var i="webix_chat_avatar";return t.avatar?'<img alt="" title="'+e+'" class="'+i+'" src="'+t.avatar+'"/>':"<div class='"+i+"  webix_icon chi-camera' title='"+e+"'</div>"},t.prototype.dateChatFormat=function(t){var e=this.dateMask,i=webix.Date.datePart(new Date,!0),n=webix.Date.datePart(t,!0);return webix.Date.equal(n,i)?e=this.todayDateMask:n>webix.Date.add(i,-7,"day")&&(e=this.weekMask),webix.Date.dateToStr(e)(t)},t.prototype.peopleList=function(t,e,i){var n=this,r="<ul class='webix_chat_peoplelist'>";return t.forEach((function(t){r+="<li class='webix_chat_peoplelist_item' data-id='"+t.id+"'><div class='webix_chat_peoplelist_avatar'>"+n.avatar(t)+(i&&i.indexOf(t.id)>=0?"<div class='webix_chat_group_user_marker'><span class='webix_icon wxi-check'></span></div>":"")+(e?"<div class='webix_chat_peoplelist_delete_icon'><span class='webix_icon wxi-close'></span></div>":"")+'</div><br/><span class="webix_chat_peoplelist_item_name">'+t.name+"</span></li>"})),r+="</ul>"},t.prototype.addTextMark=function(t,e){return e?t.replace(new RegExp("("+e+")","ig"),"<span class='webix_chat_search_mark'>$1</span>"):t},t}(),dt=function(t){function e(e){var i=this,r={state:N({chatId:0,chatType:null,userId:null,search:""})};e.compat&&(r.forceCompact=e.compact);var a={router:b,version:"8.0.5",debug:!0,start:"/top/messages",mode:"full",compactWidth:650,params:r};(i=t.call(this,n(n({},a),e))||this).config.debug&&(webix.Promise=window.Promise);var o=function(t){return i.config.override&&i.config.override.get(t)||t};return i.setService("local",new(o(ct))(i)),i.setService("backend",new(o(ht))(i)),i.setService("operations",new(o(pt))(i)),i.setService("upload",new(o(lt))(i)),i.setService("helpers",new(o(ft))(i)),i.use(R,i.config.locale||{lang:"en",webix:{en:"en-US"}}),i}return i(e,t),e.prototype.render=function(e){var i=this;this.getService("backend").ready().then((function(){return t.prototype.render.call(i,e)}))},e.prototype.require=function(t,e){return"jet-views"===t?st[e]:"jet-locales"===t?mt[e]:null},e.prototype.getState=function(){return this.config.params.state},e}(_);webix.protoUI({name:"chat",app:dt,getState:function(){return this.$app.getState()},getService:function(t){return this.$app.getService(t)},$init:function(){var t=this.$app.getState();for(var e in t)H(t,this.config,e)}},webix.ui.jetapp);var vt={Local:ct,Backend:ht,Operations:pt,Upload:lt,Helpers:ft},mt={en:{"Add members":"Add members","Are you sure to leave this chat?":"Are you sure to leave this chat?",Avatar:"Avatar","Are you sure to delete this member?":"Are you sure to delete this member?",Cancel:"Cancel","Change avatar":"Change avatar","Chat info":"Chat info","Chat name":"Chat name",Chats:"Chats","Create group":"Create group",Delete:"Delete","Delete member":"Delete member","Edit chat":"Edit chat",Leave:"Leave","Leave chat":"Leave chat",member:"member",members:"members",Members:"Members","New chat":"New chat","No people to add":"No people to add",People:"People",Save:"Save",Search:"Search","Show all members":"Show all members",Users:"Users",You:"You"}};t.App=dt,t.locales=mt,t.services=vt,t.views=st,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=chat.min.js.map
