/**
 * @license
 * Webix Pivot v.7.3.5
 * This software is covered by Webix Trial License.
 * Usage without proper license is prohibited.
 * (c) XB Software Ltd.
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t():"function"==typeof define&&define.amd?define(t):t()}(0,function(){"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}function formatFilterValues(e){e=e||[];for(var t=0;t<e.length;t++)e[t].fvalue=getFormattedValue(e[t].value)}function getFormattedValue(e){return e=e||"",webix.isDate(e)?e=e.valueOf().toString():"string"==typeof e&&e.trim&&(e=e.trim()),e}function processFilters(e){var t,i,o,n=e.config,r=n.structure.filters||[],a=[],s={};for(t=0;t<r.length;t++){i=r[t],webix.isUndefined(s[i.type])&&(s[i.type]=[]),s[i.type].push(t);var l="multiselect"===i.type?"multicombo":"select"===i.type?"richselect":i.type;if(o={value:webix.isUndefined(i.value)?"":i.value,point:!1,field:i.name,view:l,minWidth:n.filterMinWidth,maxWidth:n.filterWidth},n.filterPlaceholder&&("boolean"==typeof n.filterPlaceholder?(o.placeholder=o.label,o.label=""):o.placeholder=n.filterPlaceholder),"multicombo"==i.type&&(o.tagMode=!1),e.filters.isSelect(i.type)&&(o.options={},o.options.data=distinctValues(e,i.name,-1==i.type.indexOf("multi")),o.options.point=!1,"richselect"==l&&(o.options.css="webix_pivot_richselect_suggest"),"multicombo"==l&&(o.options.css="webix_pivot_multicombo_suggest")),n.separateLabel||(o.label=e._applyMap(i.name),o.labelAlign=n.filterLabelAlign,o.labelWidth=n.filterLabelWidth),e.callEvent("onFilterCreate",[i,o]))if(n.separateLabel){var u=e._applyMap(i.name);a.push({cols:[{view:"label",autowidth:!0,label:u},{width:10},o,{width:18}]})}else a.push(o)}return a}function distinctValues(e,t,i){var o,n=[],r=e.data.pull,a={};if(i&&n.push({value:"",id:"",$empty:!0}),e._pivotOptions&&e._pivotOptions[t])return n.concat(e._pivotOptions[t]);for(var s in r)o=r[s][t],webix.isUndefined(o)||!o&&0!==o||a[o]||(n.push({value:o.toString(),id:o.toString()}),a[o]=!0);var l=function(e){return!isNaN(parseFloat(e))};return n.sort(function(e,t){var i=e.value,o=t.value;return o?i?(l(i)&&l(o)||(i=i.toString().toLowerCase(),o=o.toString().toLowerCase()),o<i?1:i<o?-1:0):-1:1}),n}function showFilters(e,t){setEvents(e,t);var i={elements:t};e.callEvent("onViewInit",["filters",i]),i.elements&&e.getFilterView()&&(0<t.length?(e.getFilterView().show(),webix.ui(t,e.getFilterView())):e.getFilterView().hide())}function setEvents(t,e){for(var i=0;i<e.length;i++){var o,n=e[i];n.cols&&(n=n.cols[2]),o="text"==n.view?"onTimedKeyPress":"onChange",n.on={},n.on[o]=function(){var e=this.getValue();e&&this.config.separator&&!this.format_setter&&(e=e.split(this.config.separator)),changeFilterValue(t,this.config.field,e)}}}function changeFilterValue(e,t,i){for(var o=e.config.structure.filters,n=0;n<o.length;n++)if(o[n].name==t)return o[n].value=i,e.callEvent("onFilterChange",[t,i]),!0;return!1}webix.i18n.pivot=webix.extend(webix.i18n.pivot||{},{apply:"Apply",bar:"Bar",cancel:"Cancel",chart:"Chart",chartType:"Chart type",columns:"Columns",count:"count",date:"date",datepicker:"datepicker",fields:"Fields",filters:"Filters",groupBy:"Group By",line:"Line",logScale:"Logarithmic scale",max:"max",min:"min",multicombo:"multi-select",operationNotDefined:"Operation is not defined",layoutIncorrect:"pivotLayout should be an Array instance",pivotMessage:"Click to configure",popupHeader:"Pivot Settings",radar:"Radar",radarArea:"Area Radar",rows:"Rows",select:"select",settings:"Settings",stackedBar:"Stacked Bar",sum:"sum",text:"text",total:"Total",values:"Values",valuesNotDefined:"Values or Group field are not defined",windowTitle:"Pivot Configuration",
windowMessage:"move fields here"}),webix.protoUI({name:"webix_pivot_popup",_selected:null,defaults:{autoheight:!0,padding:0},$init:function(e){webix.extend(e,this._get_ui(e)),this.$ready.push(this._after_init)},_get_ui:function(e){return{body:{id:"list",view:"list",borderless:!0,autoheight:!0,template:"#title#",data:e.data}}},_after_init:function(){this.attachEvent("onItemClick",function(e){this._selected=this.$eventSource.getItem(e),this.hide()})},getSelected:function(){return this._selected}},webix.ui.popup,webix.IdSpace);var clickHandlers={add:function(e,r){var t=webix.$$(this.config.pivot),a=this.$$("values").getItem(r);a.operation.push(t.config.defaultOperation),this.$$("values").updateItem(r),webix.delay(function(){for(var e=a.operation.length-1,t=this.$$("values").getItemNode(r).childNodes,i=null,o=0;o<t.length;o++)if((i=t[o]).getAttribute){var n=i.getAttribute("webix_operation");if(!webix.isUndefined(n)&&n==e)break}null!==i&&clickHandlers.selector.call(this,i,r,i)},this)},"filter-selector":function(e,i,t){var o,n=webix.$$(this.config.pivot),r={view:"webix_pivot_popup",css:"webix_pivot_popup",autofit:!0,autoheight:!0,width:150,data:getFilterOptions(n.filters.get(),n._applyLocale)};(o=webix.ui(r)).show(t),o.attachEvent("onHide",webix.bind(function(){var e=o.getSelected();if(null!==e){var t=this.$$("filters").getItem(i);t.type=e.name,t.value="",this.$$("filters").updateItem(i)}o.close()},this))},"chart-selector":function(e,i,t){var o,n=webix.$$(this.config.pivot),r={view:"webix_pivot_popup",css:"webix_pivot_popup",autofit:!0,autoheight:!0,width:150,data:getFilterOptions(n.filters.get(),n._applyLocale)};(o=webix.ui(r)).show(t),o.attachEvent("onHide",webix.bind(function(){var e=o.getSelected();if(null!==e){var t=this.$$("filters").getItem(i);t.type=e.name,t.value="",this.$$("filters").updateItem(i)}o.close()},this))},selector:function(i,o,e){var t={view:"webix_pivot_popup",css:"webix_pivot_popup",autofit:!0,width:150,data:this.config.operations||[]},n=webix.ui(t);n.show(e),n.attachEvent("onHide",webix.bind(function(){var e=webix.html.locate(i,"webix_operation"),t=n.getSelected();null!==t&&(this.$$("values").getItem(o).operation[e]=t.name,this.$$("values").updateItem(o)),n.close()},this))},remove:function(e,t){var i=webix.$$(e),o=this.innerId(i.config.id),n=this.$$(o).getItem(t);if("values"==o){var r=webix.html.locate(e,"webix_operation");1<n.operation.length?(n.operation.splice(r,1),this.$$("values").updateItem(t)):this._removeListField("values",n)}else this._removeListField(o,n);return!1}};function getFilterOptions(e,t){var i,o,n=[];for(i=0;i<e.length;i++)o=e[i],n.push({name:o,title:t(o)});return n}function setStructure(e,a,s,t){var l=["rows","cols"],u=["head","body"],c=e,p=t.on?t.on.onViewInit:null,d=function(e,t){var i,o,n;for(i=0;i<u.length;i++)n=null,t[u[i]]&&("string"==typeof t[u[i]]&&(n=t[u[i]],t[u[i]]=s[n]),d(n,t[u[i]]));for(i=0;i<l.length;i++)if(t[l[i]]){var r=t[l[i]];for(o=0;o<r.length;o++)n=null,"string"==typeof r[o]&&(n=r[o],t[l[i]][o]=s[n]),d(n,t[l[i]][o])}e&&e!=a&&!t.id&&(t.id=e),e&&p&&p.apply(c,[e,t])};return d(a,s[a]),s[a]}var popupTemplates={header:function(e){return webix.i18n.pivot[e.value]},iconHeader:function(e){return e.icon?"<span class='webix_pivot_header_icon webix_pivot_icon pt-"+e.icon+"'></span>"+webix.i18n.pivot[e.value]:"<span class='webix_pivot_header_icon'>"+e.iconContent+"</span>"+webix.i18n.pivot[e.value]},tableValues:function(e){var t=webix.$$(this.config.pivot);e.operation=e.operation||[t.config.defaultOperation],webix.isArray(e.operation)||(e.operation=[e.operation]);for(var i=[],o=t._applyLocale,n=0;n<e.operation.length;n++){var r="<div class='webix_pivot_link' webix_operation='"+n+"'>";r+="<span>"+e.text+"</span>",r+="<span class='webix_link_selection'>"+o(e.operation[n])+"</span>",r+="<span class='webix_pivot_minus webix_icon webix_pivot_close'>&#10005;</span>",r+="</div>",i.push(r)}return i.join(" ")},chartValues:function(e){var t=webix.$$(this.config.pivot);e.operation=e.operation||[t.config.defaultOperation],e.color=e.color||[],webix.isArray(e.operation)||(e.operation=[
e.operation]);for(var i=[],o=t._applyLocale,n=0;n<e.operation.length;n++){e.color&&e.color[n]||(e.color[n]=t._getColor(this._valueLength),this._valueLength++);var r="<div class='webix_pivot_link' webix_operation='"+n+"'>";r+="<div class='webix_color_selection'><div style='background-color:"+o(e.color[n])+"'></div></div>",r+="<div class='webix_link_title'>"+e.text+"</div>",r+="<div class='webix_link_selection'>"+o(e.operation[n])+"</div>",r+="<span class='webix_pivot_minus webix_icon webix_pivot_close'>&#10005;</span>",r+="</div>",i.push(r)}return i.join(" ")},filters:function(e){var t=webix.$$(this.config.pivot);e.type=e.type||t.filters.getDefault();var i="<a class='webix_pivot_link'>"+e.text;return i+="<span class='webix_link_selection'>"+t._applyLocale(e.type)+"</span>",i+="</a> ",i+="<span class='webix_pivot_minus webix_icon webix_pivot_close'>&#10005;</span>"},rows:function(e){var t="<a class='webix_pivot_link'>"+e.text;return t+="</a> ",t+="<span class='webix_pivot_minus webix_icon webix_pivot_close'>&#10005;</span>"},columns:function(e){var t="<a class='webix_pivot_link'>"+e.text;return t+="</a> ",t+="<span class='webix_pivot_minus webix_icon webix_pivot_close'>&#10005;</span>"},groupBy:function(e){var t="<a class='webix_pivot_link'>"+e.text;return t+="</a> ",t+="<span class='webix_pivot_minus webix_icon webix_pivot_close'>&#10005;</span>"},listDrag:function(e){return"<a class='webix_pivot_link'>"+e.text+"</a> "}},seed;function getStructureMap(e,t){return{popup:{width:t.popupWidth,head:"toolbar",body:"body"},toolbar:{view:"toolbar",borderless:!0,padding:10,cols:["configTitle",{margin:6,cols:["cancel","apply"]}]},configTitle:{id:"configTitle",view:"label",label:webix.i18n.pivot.windowTitle||""},cancel:{view:"button",id:"cancel",label:webix.i18n.pivot.cancel,width:t.cancelButtonWidth},apply:{view:"button",id:"apply",type:"form",label:webix.i18n.pivot.apply,width:t.applyButtonWidth},body:{type:"wide",rows:[{css:"webix_pivot_fields_layout",type:"space",cols:["fieldsLayout",{type:"wide",rows:[{type:"wide",css:"webix_pivot_configuration",rows:[{type:"wide",cols:["filtersLayout","columnsLayout"]},{type:"wide",cols:["rowsLayout","valuesLayout"]}]}]}]}]},fieldsLayout:{width:t.fieldsColumnWidth,rows:["fieldsHeader","fields"]},filtersLayout:{rows:["filtersHeader","filters"]},columnsLayout:{rows:["columnsHeader","columns"]},rowsLayout:{rows:["rowsHeader","rows"]},valuesLayout:{rows:["valuesHeader","values"]},fieldsHeader:{id:"fieldsHeader",data:{value:"fields"},css:"webix_pivot_header_fields",template:popupTemplates.header,height:40},fields:{id:"fields",css:"webix_pivot_fields",view:"list",scroll:"auto",type:{height:"auto"},drag:!0,template:"<span class='webix_pivot_list_marker'></span>#text#<span class='webix_pivot_icon pt-list-drag'></span>",on:e._getListEvents()},filtersHeader:{id:"filtersHeader",data:{value:"filters",icon:"filter"},template:popupTemplates.iconHeader,css:"webix_pivot_popup_title",height:40},filters:{id:"filters",view:"list",drag:!0,scroll:"auto",template:webix.bind(popupTemplates.filters,e),type:{height:"auto"},onClick:{webix_link_selection:webix.bind(clickHandlers["filter-selector"],e),webix_pivot_minus:webix.bind(clickHandlers.remove,e)},on:e._getListEvents()},columnsHeader:{id:"columnsHeader",data:{value:"columns",icon:"columns"},template:popupTemplates.iconHeader,css:"webix_pivot_popup_title",height:40},columns:{id:"columns",view:"list",drag:!0,scroll:"auto",type:{height:"auto"},template:webix.bind(popupTemplates.columns,e),on:e._getListEvents(),onClick:{webix_pivot_minus:webix.bind(clickHandlers.remove,e)}},rowsHeader:{id:"rowsHeader",data:{value:"rows",icon:"list"},template:popupTemplates.iconHeader,css:"webix_pivot_popup_title",height:40},rows:{id:"rows",view:"list",drag:!0,scroll:"auto",template:webix.bind(popupTemplates.rows,e),type:{height:"auto"},on:e._getListEvents(),onClick:{webix_pivot_minus:webix.bind(clickHandlers.remove,e)}},valuesHeader:{id:"valuesHeader",data:{value:"values",icon:"values"},template:popupTemplates.iconHeader,css:"webix_pivot_popup_title",height:40},values:{id:"values",
view:"list",scroll:"auto",drag:!0,css:"webix_pivot_values",type:{height:"auto"},template:webix.bind(popupTemplates.tableValues,e),onClick:{webix_link_selection:webix.bind(clickHandlers.selector,e),webix_pivot_plus:webix.bind(clickHandlers.add,e),webix_pivot_minus:webix.bind(clickHandlers.remove,e)},on:e._getListEvents()}}}function freezeTotals(e){if(e.config.freezeTotal){var t,i=e.$$("data").config.columns,o=getWidth(i),n=getTotalCount(i);for(t=0;t<e.$$("data").config.leftSplit;t++)o-=i[t].width;for(t=i.length-1;t>i.length-n;t--)o-=i[t].width;100<o&&(e.$$("data").config.rightSplit=n,e.$$("data").refreshColumns())}}function getTotalCount(e){for(var t=0,i=e.length-1;!t&&0<=i;i--)e[i].header[0]&&"total"==e[i].header[0].name&&(t=e.length-i);return t}function getWidth(e){var t,i=0;for(t=0;t<e.length;t++)i+=e[t].width;return i}function isArray(e){return Array.isArray?Array.isArray(e):"[object Array]"===Object.prototype.toString.call(e)}function isUndefined(e){return void 0===e}function extend(e,t,i){for(var o in t)e[o]&&!i||(e[o]=t[o]);return e}function uid(){return seed||(seed=(new Date).valueOf()),++seed}function getTotalColumnId(e,t){return"$webixtotal"+e.$divider+t}function getValues(e,t){var i,o,n=[];for(i=0;i<t.length;i++)o=e[t[i]],isNaN(parseFloat(o))||n.push(o);return n}function addTotalColumns(e,t){var i,o,n,r,a,s,l,u=[];if((s=t[0].header.length)<2)return t;for(n in i=(o=getTotalGroups(e,t)).groups,e._pivotColumnGroups=i){for(r={id:getTotalColumnId(e,n),header:[],sort:"int",width:e.config.columnWidth,format:e.config.format},a=0;a<s-1;a++)a||u.length?r.header.push(""):r.header.push({name:"total",rowspan:s-1,colspan:o.count});l=n.split(e.$divider),r.header.push({name:n,operation:l[0],text:l[1]}),u.push(r)}return t.concat(u)}function getTotalGroups(e,t){var i,o,n,r,a,s={},l=0;for(o=0;o<t.length;o++)n=(a=t[o].id.split(e.$divider)).pop(),"sum"!=(r=a.pop())&&"sumOnly"==e.config.totalColumn||(s[i=r+e.$divider+n]||(l++,s[i]={operation:r,ids:[],format:t.format}),s[i].ids.push(t[o].id));return{groups:s,count:l}}function addTotalData(e,t){var i,o,n,r=e._pivotColumnGroups;if(r)for(n in r)for(o=r[n].ids,i=0;i<t.length;i++){var a=void 0,s=getTotalColumnId(e,n),l="",u=getValues(t[i],o);u.length&&(a=e._pivotOperations.getTotal(n.split(e.$divider)[0]))&&(l=a.call(e,u,s,t[i])),t[i][s]=l,t[i].data&&(t[i].data=addTotalData(e,t[i].data))}return t}webix.protoUI({name:"webix_pivot_config_common",$init:function(e){webix.extend(e,this.defaults),webix.extend(e,this._getUI(e),!0),this.$ready.push(this._afterInit)},defaults:{padding:8,height:500,width:700,cancelButtonWidth:100,applyButtonWidth:85,head:!1,modal:!0,move:!0},_getUI:function(){return{}},_afterInit:function(){},setStructure:function(e){this.define("structure",e),this.render()},getStructure:function(){return{}},_lists:[],_dndCorrection:{},data_setter:function(i){var e,t=(i=webix.copy(i)).fields,o=this._lists;for(t.forEach(function(t){o.forEach(function(e){i[e].forEach(function(e){e.name==t.name&&(t.$css=" webix_pivot_field_selected")})})}),this.$$("fields").clearAll(),this.$$("fields").parse(t),e=0;e<o.length;e++)this.$$(o[e]).clearAll(),this.$$(o[e]).parse(i[o[e]])},_dropField:function(e){var t,i=e.from,o=e.to;if(o&&o!=i)return t=webix.copy(i.getItem(e.start)),o==this.$$("fields")?this._removeListField(this.innerId(i.config.id),t):this._addListField(this.innerId(o.config.id),t,e.index),!1},_addListField:function(e,t,i){this._handlers[e].call(this,e,t,i)},_removeListField:function(e,t){this.$$(e).remove(t.id);for(var i=this._lists,o=!1,n=0;!o&&n<i.length;n++)this.$$(i[n]).data.each(function(e){e.name==t.name&&(o=e)});o||this._setPivotFieldCss(t.name,"")},_setPivotFieldCss:function(t,i){this.$$("fields").data.each(function(e){e.name==t&&(e.$css=" "+i,this.refresh(e.id))})},_handlers:{filters:function(e,t){var i=!1,o=t.name,n=this.$$(e);n.data.each(function(e){e.name==o&&(i=!0)}),i||(delete t.id,n.add(t),this._setPivotFieldCss(o,"webix_pivot_field_selected"),this._correctLists(o,e))},rows:function(e,t){var i=!1,o=t.name,n=this.$$(e);n.data.each(function(e){e.name==o&&(i=!0)}),i||(
delete t.id,n.add(t),this._setPivotFieldCss(o,"webix_pivot_field_selected"),this._correctLists(o,e))},columns:function(e,t){this._handlers.rows.call(this,e,t)},values:function(e,t,i){var o=null,n=this.$$(e);n.data.each(function(e){e.name==t.name&&(o=e)}),o?clickHandlers.add.call(this,{},o.id):(this._setPivotFieldCss(t.name,"webix_pivot_field_selected"),n.add(webix.copy(t),i)),this._correctLists(t.name,e)},groupBy:function(e,t){if(this.$$(e).data.order.length){var i=this.$$(e).getFirstId();this._removeListField(e,this.$$("groupBy").getItem(i))}this._setPivotFieldCss(t.name,"webix_pivot_field_selected"),delete t.id,this.$$(e).add(t),this._correctLists(t.name,e)}},_correctLists:function(t,e){var i,o,n=this._dndCorrection[e];for(i=0;n&&i<n.length;i++)o=null,this.$$(n[i]).data.each(function(e){e.name==t&&(o=e)}),o&&this.$$(n[i]).remove(o.id)},_setStructure:function(e,t){return setStructure(this,"popup",e,t)},_listDragHTML:function(e){if(e.start){var t=this.getItem(e.start);e.html=this.type.templateStart(t,this.type)+popupTemplates.listDrag(t)+this.type.templateEnd(t,this.type)}},_getListEvents:function(){return{onBeforeDrop:webix.bind(this._dropField,this),onBeforeDrag:this._listDragHTML,onBeforeDragIn:function(){webix.html.addCss(webix.DragControl.getNode(),"webix_pivot_drag_zone",!0)}}}},webix.ui.window,webix.IdSpace),webix.protoUI({name:"webix_pivot_config",defaults:{fieldsColumnWidth:230,popupWidth:890},$init:function(){this.$view.className+=" webix_popup webix_pivot"},_getUI:function(e){var t=webix.copy(getStructureMap(this,e));return this._setStructure(t,e)},_lists:["filters","columns","rows","values"],_dndCorrection:{rows:["columns","values"],columns:["rows"],values:["rows"]},_afterInit:function(){this.attachEvent("onItemClick",function(e){var t=this.innerId(e);if("cancel"==t||"apply"==t){var i=this.getStructure();webix.$$(this.config.pivot).callEvent("onBefore"+t,[i])&&(this.callEvent("on"+t,[i]),this.hide())}});for(var e=this.$view.querySelectorAll(".webix_pivot_configuration .webix_list"),t=0;t<e.length;t++)e[t].setAttribute("window-message",webix.i18n.pivot.windowMessage)},getStructure:function(){var t={rows:[],columns:[],values:[],filters:[]};this.$$("rows").data.each(function(e){t.rows.push(e.name)}),this.$$("columns").data.each(function(e){t.columns.push(e.name)}),this.$$("values").data.each(function(e){t.values.push(e)}),this.$$("filters").data.each(function(e){t.filters.push(e)});var e=webix.$$(this.config.pivot);return e.config.structure.columnSort&&(t.columnSort=e.config.structure.columnSort),t}},webix.ui.webix_pivot_config_common);var sortConfig={dir:1,as:function(e,t){return isNum(e)&&isNum(t)?sorting["int"](e,t):sorting.string(e,t)}},sorting={date:function(e,t){return(t-=0)<(e-=0)?1:e<t?-1:0},"int":function(e,t){return(t*=1)<(e*=1)?1:e<t?-1:0},string:function(e,t){return t?e?(e=e.toString().toLowerCase(),(t=t.toString().toLowerCase())<e?1:e<t?-1:0):-1:1}};function processHeader(e,t){var i,o,n,r,a=e.config.structure.values;for(t=getHeader(e,t=sortHeader(e.config.structure,t)),i=0;i<t.length;i++){var s=[];for(o=0;o<t[i].length;o++)s.push(t[i][o].name);r=null;var l=s[s.length-1].split(e.$divider);for(o=0;o<a.length&&!r;o++)if(a[o].operation)for(n=0;n<a[o].operation.length;n++)a[o].name==l[1]&&a[o].operation[n]==l[0]&&(r=a[o]);t[i]={id:s.join(e.$divider),header:t[i]},t[i].format=r&&r.format?r.format:"count"!=l[0]?e.config.format:null}return t.length&&e.view&&e.view.callEvent&&e.view.callEvent("onHeaderInit",[t]),e.config.totalColumn&&t.length&&(t=addTotalColumns(e,t)),t.splice(0,0,{id:"name",template:"{common.treetable()} #name#",header:{text:void 0}}),t}function isNum(e){return!isNaN(1*e)}function setSortConfig(e,t){var i=sortConfig;return e&&(e[t]?i=e[t]:e.$default&&(i=e.$default),i.dir&&(i._dir="desc"==i.dir?-1:1),extend(i,sortConfig)),i}function sortHeader(e,t,i){var o,n,r,a,s,l=[];if(Object.keys&&!1!==e.columnSort)for(i=i||0,o=e.columns[i],s=setSortConfig(e.columnSort,o),a=Object.keys(t),i<e.columns.length&&(a=a.sort(function(e,t){return s.as(e,t)*s._dir})),i++,n=0;n<a.length;n++)r=a[n],l.push({key:r,
data:sortHeader(e,t[r],i)});else for(r in t)l.push({key:r,data:sortHeader(e,t[r])});return l}function getHeader(e,t){var i,o,n,r,a,s=[];for(o=0;o<t.length;o++)if((n=t[o]).data.length){var l=getHeader(e,n.data);for(i=!1,r=0;r<l.length;r++)(a=l[r]).splice(0,0,{name:n.key}),i||(a[0].colspan=l.length,i=!0),s.push(a)}else{var u=t[o].key.split(e.$divider);s.push([{name:t[o].key,operation:u[0],text:u[1]}])}return s}function addFooter(e,t,i){var o,n,r,a;for(n=1;n<t.length;n++){o=null,a=(r=t[n].id.split(e.$divider))[r.length-2],"sumOnly"==e.config.footer&&"sum"!=a&&(o=" ");var s=e._pivotOperations.getTotal(a);if(!o&&s){var l=e._pivotOperations.getTotalOptions(a);o={$pivotValue:calculateColumn(i,t[n].id,s,l&&l.leavesOnly),$pivotOperation:a}}else o=" ";t[n].footer=o,"object"==_typeof(e.config.footer)&&extend(t[n].footer,e.config.footer,!0)}}function calculateColumn(e,t,i,o){var n,r,a=[],s=[];for(e=filterItems(e,o),n=0;n<e.length;n++)r=e[n][t],isNaN(parseFloat(r))||(s.push(1*r),a.push(e[n]));return i(s,t,a)}function filterItems(e,t,i){i||(i=[]);for(var o=0;o<e.length;o++)t&&e[o].data?filterItems(e[o].data,t,i):i.push(e[o]);return i}function calculateItem(e,t,i){var o,n,r,a,s,l,u,c=t.header;for(o=0;o<c.length;o++){if(s=(l=(r=c[o]).split(t.divider))[l.length-2],u=e[r],a=t.operations.getOption(s,"leavesOnly"),n=t.operations.getOption(s,"ids"),a&&e.data&&(u=[],getKeyLeaves(e.data,r,u)),u){for(var p=[],d=[],h=0;h<u.length;h++){var f=u[h],v=null;"object"==_typeof(f)&&(f=f.value,v=u[h].id),(f||"0"==f)&&(p.push(f),v&&d.push(v))}p.length?e[r]=t.operations.get(s)(p,r,e,n?d:null):e[r]=""}else e[r]="";i.count++}return e}function getKeyLeaves(e,t,i){var o;for(o=0;o<e.length;o++)e[o].data?getKeyLeaves(e[o].data,t,i):i.push(e[o][t])}function setMinMax(e,t){var i,o,n,r,a,s,l,u,c=t.header,p=t.max,d=t.min,h=t.values;if(!d&&!p)return e;for(e.$cellCss||(e.$cellCss={}),i=0;i<h.length;i++){for(u=h[i],r=[],a=-99999999,s=[],l=99999999,o=0;o<c.length;o++)n=c[o],isNaN(e[n])||-1!==n.indexOf(u.name)&&(p&&e[n]>a?(r=[n],a=e[n]):e[n]==a&&r.push(n),d&&e[n]<l?(s=[n],l=e[n]):e[n]==l&&s.push(n));for(o=0;o<s.length;o++)e.$cellCss[s[o]]="webix_min";for(o=0;o<r.length;o++)e.$cellCss[r[o]]="webix_max"}return e}function numHelper(e,t,i){if("object"==_typeof(e)){for(var o=0;o<e.length;o++)if(e[o]=parseFloat(e[o]),isNaN(e[o]))return!0}else if(e=parseFloat(e),isNaN(e))return!0;return!isNaN(t)&&i(e,t)}var rules={contains:function(e,t){return 0<=t.toLowerCase().indexOf(e.toString().toLowerCase())},equal:function(e,t){return numHelper(e,t,function(e,t){return e==t})},not_equal:function(e,t){return numHelper(e,t,function(e,t){return e!=t})},less:function(e,t){return numHelper(e,t,function(e,t){return t<e})},less_equal:function(e,t){return numHelper(e,t,function(e,t){return t<=e})},more:function(e,t){return numHelper(e,t,function(e,t){return e<t})},more_equal:function(e,t){return numHelper(e,t,function(e,t){return e<=t})},multi:function(e,t){"string"==typeof e&&(e=e.split(","));for(var i=0;i<e.length;i++)if(t==e[i])return!0;return!1},range:function(e,t){return numHelper(e,t,function(e,t){return t<e[1]&&t>=e[0]})},range_inc:function(e,t){return numHelper(e,t,function(e,t){return t<=e[1]&&t>=e[0]})}};function setFilterValues(e){e=e||[];for(var t=0;t<e.length;t++){var i=e[t],o=i.fvalue;"function"==typeof o?i.func=o:"select"==i.type||"richselect"==i.type?(i.func=function(e,t){return e==t},o=o||""):-1<i.type.indexOf("multi")?i.func=rules.multi:"object"===_typeof(o)?i.func=rules.range:"="==o.substr(0,1)?(i.func=rules.equal,o=o.substr(1)):"<>"==o.substr(0,2)?(i.func=rules.not_equal,o=o.substr(2)):">="==o.substr(0,2)?(i.func=rules.more_equal,o=o.substr(2)):">"==o.substr(0,1)?(i.func=rules.more,o=o.substr(1)):"<="==o.substr(0,2)?(i.func=rules.less_equal,o=o.substr(2)):"<"==o.substr(0,1)?(i.func=rules.less,o=o.substr(1)):0<o.indexOf("...")?(i.func=rules.range,o=o.split("...")):0<o.indexOf("..")?(i.func=rules.range_inc,o=o.split("..")):"datepicker"==i.type?i.func=function(e,t){return e==t}:i.func=rules.contains,i.fvalue=o}}function formatFilterValues$1(e){var t,i;for(e=e||[],
t=0;t<e.length;t++)"string"==typeof(i=e[t].fvalue||e[t].value||"")&&i.trim&&(i=i.trim()),e[t].fvalue=i}function filterItem(e,t,i){var o,n;if(e)for(o=0;o<e.length;o++)if((n=e[o]).fvalue){var r=i&&i[n.name]?i[n.name]:n.name;if(isUndefined(t[r]))return!1;var a=t[r];if(0!==!a&&!a)return!1;var s=a.toString();if(!n.func(n.fvalue,s))return!1}return!0}var Data=function(){function i(e,t){_classCallCheck(this,i),this.master=e,this.config=t,this.count=0}return _createClass(i,[{key:"process",value:function(e,t){var i,o,n,r,a;this.watch=new Date;var s=this.structure;for(s._header=[],s._header_hash={},formatFilterValues$1(s.filters),setFilterValues(s.filters),r=0;r<s.values.length;r++)s.values[r].operation=s.values[r].operation||[this.config.defaultOperation],isArray(s.values[r].operation)||(s.values[r].operation=[s.values[r].operation]);for(i=[],r=0;r<s.columns.length;r++)i[r]="object"==_typeof(s.columns[r])?s.columns[r].id||r:s.columns[r];return o=s.rows.concat(i),a=this.group(e,t,o),n={},a=0<s.rows.length?this.processRows(a,s.rows,s,n,""):(this.processColumns(a,i,s,n),[]),n=processHeader(this.master,n),a=addTotalData(this.master,a),this.config.footer&&addFooter(this.master,n,a),delete s._header,delete s._header_hash,{header:n,data:a}}},{key:"processColumns",value:function(e,t,i,o,n,r){var a;if(n=n||{$source:[]},0<t.length)for(var s in r=r||"",e)o[s]||(o[s]={}),e[s]=this.processColumns(e[s],t.slice(1),i,o[s],n,(0<r.length?r+this.divider:"")+s);else{var l=i.values;for(var u in e){n.$source.push(u);for(var c=0;c<l.length;c++)for(var p=0;p<l[c].operation.length;p++)a=void 0!==r?r+this.divider+l[c].operation[p]+this.divider+l[c].name:l[c].operation[p]+this.divider+l[c].name,i._header_hash[a]||(i._header.push(a),i._header_hash[a]=!0),isUndefined(n[a])&&(n[a]=[],o[l[c].operation[p]+this.divider+l[c].name]={}),n[a].push({value:e[u][l[c].name],id:u})}}return n}},{key:"processRows",value:function(e,t,i,o,n){var r,a,s,l,u,c=[];if(1<t.length){for(r in e)e[r]=this.processRows(e[r],t.slice(1),i,o,n+"_"+r);var p=i._header;for(r in e){for(a={data:e[r]},s=0;s<a.data.length;s++)for(l=0;l<p.length;l++)isUndefined(a[u=p[l]])&&(a[u]=[]),a[u].push(a.data[s][u]);this.setItemValues(a),this.master.config.stableRowId&&(a.id=n+"_"+r),a.name=r,a.open=!0,c.push(a)}}else for(r in e)(a=this.processColumns(e[r],i.columns,i,o)).name=r,this.master.config.stableRowId&&(a.id=n+"_"+r),this.setItemValues(a),c.push(a);return c}},{key:"setItemValues",value:function(e){return e=setMinMax(e=calculateItem(e,{header:this.structure._header,divider:this.divider,operations:this.operations},this),{header:this.structure._header,max:this.config.max,min:this.config.min,values:this.structure.values}),5e4<this.count&&(this.count=0,this.config.ping&&this.config.ping.call(this,this.watch)),e}},{key:"group",value:function(e,t,i){var o,n,r={};for(o=0;o<t.length;o++)(n=e[t[o]])&&filterItem(this.structure.filters,n,this.config.filterMap)&&this.groupItem(r,n,i);return r}},{key:"groupItem",value:function(e,t,i){if(i.length){var o=t[i[0]];if(void 0===o)return null;isUndefined(e[o])&&(e[o]={}),this.groupItem(e[o],t,i.slice(1))}else e[t.id]=t}},{key:"filterItem",value:function(e){for(var t=this.structure.filters||[],i=0;i<t.length;i++){var o=t[i];if(o.fvalue){if(isUndefined(e[o.name]))return!1;var n=e[o.name].toString().toLowerCase();if(!o.func(o.fvalue,n))return!1}}return!0}},{key:"operations",get:function(){return this.master._pivotOperations}},{key:"divider",get:function(){return this.master.$divider}},{key:"structure",get:function(){return this.config.structure}}]),i}(),operations={sum:function(e){for(var t=0,i=0;i<e.length;i++){var o=e[i];o=parseFloat(o,10),isNaN(o)||(t+=o)}return t},count:function(e,t,i){var o=0;if(i.data)for(var n=0;n<i.data.length;n++)o+=i.data[n][t]||0;else o=e.length;return o},max:function(e){return 1==e.length?e[0]:Math.max.apply(this,e)},min:function(e){return 1==e.length?e[0]:Math.min.apply(this,e)}},totalOperations={sum:function(e){var t,i=0;for(t=0;t<e.length;t++)i+=e[t];return i},min:function(e){return 1==e.length?e[0]:Math.min.apply(null,e)},max:function(e){
return 1==e.length?e[0]:Math.max.apply(null,e)},count:function(e){var t=totalOperations.sum.call(this,e);return t?parseInt(t,10):""}},Operations=function(){function Operations(){_classCallCheck(this,Operations),this.pull=extend({},operations),this.options={},this.pullTotal=extend({},totalOperations),this.totalOptions={}}return _createClass(Operations,[{key:"serialize",value:function(){var e={};for(var t in this.pull)e[t]=this.pull[t].toString();return e}},{key:"parse",value:function parse(str){for(var key in str)eval("this.temp = "+str[key]),this.pull[key]=this.temp}},{key:"add",value:function(e,t,i){this.pull[e]=t,i&&(this.options[e]=i)}},{key:"addTotal",value:function(e,t,i){this.pullTotal[e]=t,i&&(this.totalOptions[e]=i)}},{key:"get",value:function(e){return this.pull[e]||null}},{key:"getOptions",value:function(e){return this.options[e]||null}},{key:"getOption",value:function(e,t){return this.options[e]?this.options[e][t]:null}},{key:"getTotal",value:function(e){return this.pullTotal[e]||this.pull[e]||null}},{key:"getTotalOptions",value:function(e){return this.pullTotal[e]?this.totalOptions[e]||null:this.options[e]||null}},{key:"getTotalOption",value:function(e,t){var i=this.getTotalOptions(e);return i?i[e][t]:null}}]),Operations}(),divider="_'_";function _Pivot(e,t){this.$divider=divider,this._initOperations(),this.config=e,this.view=t,e.webWorker&&"undefined"!==!("undefined"==typeof Worker||_typeof(Worker))&&t?this._initWorker(e,t):this._pivotData=new Data(this,this.config),this.config.structure||(this.config.structure={}),extend(this.config.structure,{rows:[],columns:[],values:[],filters:[]})}function WebixPivot(e,t){_Pivot.call(this,e,t)}_Pivot.prototype={_initWorker:function(e,t){this._result=null,this._pivotWorker=new Worker(e.webWorker),this._pivotWorker.onmessage=function(e){"ping"===e.data.type?t._runPing(e.data.watch,t):t._result&&!t.$destructed&&(t.callEvent("onWebWorkerEnd",[]),e.data.id&&e.data.id!==t._result_id||(t._result(e.data.data),t._result=null))}},_runPing:function(e,t){try{this.config.ping(e)}catch(i){this._pivotWorker.terminate(),this._initWorker(this.config,t),t.callEvent("onWebWorkerEnd",[])}},_getPivotData:function(e,t,i){if(!this._pivotWorker){var o=this._pivotData.process(e,t);return i&&i(o),o}var n=this._result_id=webix.uid();this._result=i;var r=[],a=this.config.structure,s=this.config.footer,l=this._pivotOperations.serialize();if(a&&(a.rows.length||a.columns.length))for(var u=t.length-1;0<=u;u--)r[u]=e[t[u]];this.callEvent("onWebWorkerStart",[]);var c=this.config.format;if("function"==typeof c){var p="x"+webix.uid();webix.i18n[p]=c,c=p}var d=!!this.config.ping;this._pivotWorker.postMessage({footer:s,structure:a,data:r,id:n,operations:l,ping:d,format:c})},_initOperations:function(){var e=this._pivotOperations=new Operations;this.operations=e.pull},addOperation:function(e,t,i){this._pivotOperations.add(e,t,i)},addTotalOperation:function(e,t,i){this._pivotOperations.addTotal(e,t,i)}},WebixPivot.prototype=extend({getData:function(e){var t,i,o,n,r=[],a={},s=this.config.structure.filters,l={},u={},c={},p=this.operations,d=[],h={};for(t=0;t<s.length;t++)-1!=s[t].type.indexOf("select")&&(u[s[t].name]=[],c[s[t].name]={});for(t=0;t<e.length;t++){if(l[i=e[t].id=e[t].id||uid()]=e[t],d.push(i),t<5)for(n in e[t])a[n]||(r.push(n),a[n]=uid());for(o in u){var f=e[t][o];isUndefined(f)||c[o][f]||(c[o][f]=1,u[o].push(f))}}for(i in h.options=u,h.fields=r,h.data=this._getPivotData(l,d),h.operations=[],p)h.operations.push(i);return h}},_Pivot.prototype);var defaults={fieldMap:{},yScaleWidth:300,columnWidth:150,defaultOperation:"sum",filterLabelAlign:"right",filterPlaceholder:!1,filterWidth:200,filterMinWidth:150,filterLabelWidth:100,separateLabel:!0,headerTemplate:function(e){return this._applyMap(e.text||e.name)+"<span class='webix_pivot_operation'> "+this._applyLocale(e.operation)+"</span>"},format:function(e){return e&&"0"!=e?parseFloat(e).toFixed(3):e}};function setColumns(e,t){for(var i=e.config.format,o=0;o<t.length;o++)if(o){webix.extend(t[o],{format:i,sort:"int",width:e.config.columnWidth});for(
var n=t[o].header,r=0;r<n.length;r++){var a=n[r];a&&(r||"total"!=a.name?r==n.length-1?a.text=e.config.headerTemplate.call(e,a):a.text=a.name:a.text=e._applyLocale("total"))}var s=t[o].footer,l=t[o].format;if(s){"string"==typeof s&&(s={text:s}),"string"==typeof l&&(l=webix.i18n[l]||window[l]);var u=webix.isUndefined(s.$pivotValue)?s.text:s.$pivotValue;s.text=!l||"count"==s.$pivotOperation&&l==i?u:l(u)}}else setFirstColumn(e,t[o])}function setFirstColumn(e,t){var i="";i=e.config.readonly?e.config.readonlyTitle||"":"<div class='webix_pivot_config_msg'><div class='webix_pivot_icon pt-settings'></div>"+webix.i18n.pivot.pivotMessage+"</div>",t.header=i,t.width=e.config.yScaleWidth,t.exportAsTree=!0,e.config.footer&&(t.footer=e._applyLocale("total"))}function init(e){webix.extend(e,extRender,!0),e.attachEvent("onFilterChange",function(){formatFilterValues(this.config.structure.filters),this._loadResults(!0)})}var extRender={render:function(e){this.data.silent(function(){var e=this.url;this.clearAll(),this.url=e}),formatFilterValues(this.config.structure.filters),e?this._setData(e):this._loadResults()},$onLoad:function(e){if(e.fields&&(this._pivotFields=e.fields),e.options&&(this._pivotOptions=e.options),e.structure&&(this.config.structure=e.structure),e.operations){this.operations={};for(var t=0;t<e.operations.length;t++)this.operations[e.operations[t]]=1}e.data.columns&&(e.data.header=e.data.columns),e.data&&this.render(e.data)},url_setter:function(e){var t=this.config.structure;if(!t||!t.rows.length&&!t.columns.length)return webix.AtomDataLoader.url_setter.call(this,e);this.data.url=e,this._loadResults()},_loadResults:function(){var e=this.config.structure,t=this.data.url;t&&(t.load?t.load(this,{success:function(e){this.parse(JSON.parse(e))}},{structure:e}):"string"==typeof t&&this.load("post->"+t,"json",{structure:e}))}},Filters=function(){function e(){_classCallCheck(this,e),this._filters=["multicombo","select","text","datepicker"],this._selects={multicombo:1,multiselect:1,select:1,richselect:1}}return _createClass(e,[{key:"add",value:function(e,t){this._filters.push(e),webix.isUndefined(t)||(this._selects[e]=t)}},{key:"isSelect",value:function(e){return this._selects[e]}},{key:"clear",value:function(){this._filters=[]}},{key:"remove",value:function(e){var t=this.getIndex(e);0<=t&&this._filters.splice(t,1)}},{key:"getIndex",value:function(e){for(var t=0;t<this._filters.length;t++)if(this._filters[t]==e)return t;return-1}},{key:"getDefault",value:function(){return-1!=this.getIndex("select")?"select":this._filters[0]}},{key:"get",value:function(){return this._filters}}]),e}();webix.protoUI({name:"pivot",version:"{{version}}",defaults:defaults,$init:function(e){!1===e.separateLabel&&(e.filterWidth=e.filterWidth||300),this.$view.className+=" webix_pivot",this.data.provideApi(this,!0),this._setConfig(e),this._initDataStore(e),this.$separator=this.$divider,this.filters=new Filters},$divider:"_'_",_initDataStore:function(e){e.externalProcessing?init(this,e):(this.data.attachEvent("onStoreUpdated",webix.bind(function(){this.$$("data")&&this.render()},this)),this.attachEvent("onFilterChange",function(){this.render(!0)}),this.$ready.push(this.render))},_setConfig:function(e){e.structure||(e.structure={}),webix.extend(e.structure,{rows:[],columns:[],values:[],filters:[]}),webix.extend(e,this._getUI(e))},_getUI:function(e){var t=webix.skin.$active,i={view:"treetable",id:"data",css:"webix_data_border",select:"row",navigation:!0,leftSplit:1,resizeColumn:!0,rowHeight:t.rowHeight+8,rowLineHeight:t.rowHeight+8,headerRowHeight:t.barHeight+4,on:{onHeaderClick:function(e){var t=this.getTopParentView();0!==this.getColumnIndex(e.column)||t.config.readonly||t.configure()}},columns:[]};return e.datatable&&"object"==_typeof(e.datatable)&&(delete e.datatable.id,webix.extend(i,e.datatable,!0)),{rows:[{id:"filters",view:"toolbar",css:"webix_pivot_configure_toolbar",borderless:!0,hidden:!0,padding:10,cols:[{}]},i]}},configure:function(){this._configPopup||this._createPopup();var e=[];for(var t in this.operations)e.push({name:t,title:this._applyLocale(t
)});this._configPopup.define("operations",e);var i=webix.html.offset(this.$$("data").getNode());this._configPopup.setPosition(i.x+10,i.y+10),this._configPopup.define("data",this.getFields()),this._configPopup.show()},_createPopup:function(){var e={view:"webix_pivot_config",operations:[],pivot:this.config.id};webix.extend(e,this.config.popup||{}),this._configPopup=webix.ui(e),this.callEvent("onPopup",[this._configPopup]),this._configPopup.attachEvent("onApply",webix.bind(this.setStructure,this))},destructor:function(){this._configPopup&&(this._configPopup.destructor(),this._configPopup=null),webix.Destruction.destructor.call(this)},getFilterView:function(){return this.$$("filters")},render:function(t){var i=this;if(webix.debug_pivot&&window.console.time("pivot:full-processing"),!this._getPivotData){var e=new _Pivot(this.config,this);webix.extend(this,e)}formatFilterValues(this.config.structure.filters),this._getPivotData(this.data.pull,this.data.order,function(e){i._setData(e,t),webix.debug_pivot&&webix.delay(function(){window.console.timeEnd("pivot:full-processing"),window.console.timeEnd("pivot:rendering")})})},_setData:function(e,t){setColumns(this,e.header),t||(e.filters=processFilters(this)),this.callEvent("onBeforeRender",[e]),e.filters&&showFilters(this,e.filters),this.config.readonly&&(this.$$("data").$view.className+=" webix_pivot_readonly"),this.config.totalColumn&&this.$$("data").define("math",!0),this.config.footer&&this.$$("data").define("footer",!0),webix.debug_pivot&&window.console.time("pivot:rendering"),this.$$("data").clearAll(),this.$$("data").config.rightSplit=0,this.$$("data").refreshColumns(e.header),this.$$("data").parse(e.data),freezeTotals(this)},$exportView:function(e){if(e.flatTree){"object"!==_typeof(e.flatTree)&&(e.flatTree={});var t=e.flatTree;if(t.id=this.$$("data").config.columns[0].id,!t.columns){var i=this.config.structure.rows;t.columns=[];for(var o=0;o<i.length;o++)t.columns.push({header:this._applyMap(i[o])})}}return this.$$("data").$exportView(e)},_applyLocale:function(e){return webix.i18n.pivot[e]||e},_applyMap:function(e){return this.config.fieldMap[e]||e},getFields:function(){var e,t,i,o=[],n={},r={},a=this.config.structure,s={fields:[],rows:[],columns:[],values:[],filters:[]},l={};if(this._pivotFields)for(o=this._pivotFields,e=0;e<o.length;e++)n[o[e]]=webix.uid();else for(e=0;e<Math.min(this.data.count()||5);e++)for(t in this.data.getItem(this.data.getIdByIndex(e)))"id"===t||0===t.indexOf("$")||n[t]||(o.push(t),n[t]=webix.uid());for(e=0;e<(a.filters||[]).length;e++)t=a.filters[e],webix.isUndefined(n[t.name])||(i=this._applyMap(t.name),s.filters.push({name:t.name,text:i,type:t.type,value:t.value,id:n[t.name]}));for(e=0;e<a.rows.length;e++)t=a.rows[e],webix.isUndefined(n[t])||(s.rows.push({name:t,text:this._applyMap(t),id:n[t]}),r[t]=!0);for(e=0;e<a.columns.length;e++)t="object"==_typeof(a.columns[e])?a.columns[e].id||e:a.columns[e],!webix.isUndefined(n[t])&&webix.isUndefined(r[t])&&s.columns.push({name:t,text:this._applyMap(t),id:n[t]});for(e=0;e<a.values.length;e++)if(t=a.values[e],!webix.isUndefined(n[t.name]))if(webix.isUndefined(l[t.name])){l[t.name]=e,i=this._applyMap(t.name);var u={name:t.name,text:i,id:n[t.name],operation:webix.isArray(t.operation)?t.operation:[t.operation]};s.values.push(u)}else{var c=l[t.name];s.values[c].operation.push(t.operation)}for(o.sort(),e=0;e<o.length;e++)t=o[e],webix.isUndefined(n[t])||s.fields.push({name:t,text:this._applyMap(t),id:n[t]});return s},setStructure:function(e){this.define("structure",e),this.render()},getStructure:function(){return this.config.structure},getConfigWindow:function(){return this._configPopup},profile_setter:function(e){var t=window.console;e&&(this.attachEvent("onBeforeLoad",function(){t.time("data loading")}),this.data.attachEvent("onParse",function(){t.timeEnd("data loading"),t.time("data parsing")}),this.data.attachEvent("onStoreLoad",function(){t.timeEnd("data parsing"),t.time("data processing")}),this.$ready.push(function(){this.$$("data").attachEvent("onBeforeRender",function(){this.count()&&(t.timeEnd(
"data processing"),t.time("data rendering"))}),this.$$("data").attachEvent("onAfterRender",function(){this.count()&&webix.delay(function(){t.timeEnd("data rendering")})})}))}},webix.IdSpace,webix.ui.layout,webix.DataLoader,webix.EventSystem,webix.Settings);var clickHandlers$1=webix.extend({color:function(i,o,e){var t={view:"colorboard",borderless:!0};webix.$$(this.config.pivot).config.colorboard?webix.extend(t,webix.$$(this.config.pivot).config.colorboard):webix.extend(t,{width:150,height:150,palette:webix.$$(this.config.pivot).config.palette});var n=webix.ui({view:"popup",id:"colorsPopup",body:t});return n.show(e),n.getBody().attachEvent("onSelect",function(){n.hide()}),n.attachEvent("onHide",webix.bind(function(){var e=webix.html.locate(i,"webix_operation"),t=n.getBody().getValue();t&&(this.$$("values").getItem(o).color[e]=t,this.$$("values").updateItem(o)),n.close()},this)),!1}},clickHandlers);function getStructureMap$1(e,t){var r=[],i=webix.$$(t.pivot),o=i.chartMap;for(var n in o)r.push({id:n,title:i._applyLocale(n).toLowerCase()});var a=i.config.chartType;return{popup:{width:t.popupWidth,head:"toolbar",body:"body"},toolbar:{view:"toolbar",borderless:!0,padding:10,cols:["configTitle",{margin:6,cols:["cancel","apply"]}]},configTitle:{id:"configTitle",view:"label",label:webix.i18n.pivot.windowTitle||""},cancel:{view:"button",id:"cancel",label:i._applyLocale("cancel"),width:t.cancelButtonWidth},apply:{view:"button",id:"apply",type:"form",css:"webix_pivot_apply",label:i._applyLocale("apply"),width:t.applyButtonWidth},body:{type:"wide",rows:[{css:"webix_pivot_fields_layout",type:"space",cols:["fieldsLayout",{type:"wide",rows:[{type:"wide",css:"webix_pivot_configuration",rows:[{type:"wide",cols:["filtersLayout","groupLayout"]},{type:"wide",cols:["valuesLayout","chartLayout"]}]}]}]}]},fieldsLayout:{width:t.fieldsColumnWidth,rows:["fieldsHeader","fields"]},fieldsHeader:{id:"fieldsHeader",data:{value:"fields"},css:"webix_pivot_header_fields",template:popupTemplates.header,height:40},fields:{view:"list",type:{height:"auto"},css:"webix_pivot_fields",drag:!0,template:"<span class='webix_pivot_list_marker'></span>#text#<span class='webix_pivot_icon pt-list-drag'></span>",on:e._getListEvents()},filtersLayout:{rows:["filtersHeader","filters"]},filtersHeader:{data:{value:"filters",icon:"filter"},template:popupTemplates.iconHeader,css:"webix_pivot_popup_title",height:40},filters:{view:"list",scroll:"auto",type:{height:"auto"},drag:!0,template:webix.bind(popupTemplates.filters,e),onClick:{webix_link_selection:webix.bind(clickHandlers$1["filter-selector"],e),webix_pivot_minus:webix.bind(clickHandlers.remove,e)},on:e._getListEvents()},valuesLayout:{rows:["valuesHeader","values"]},valuesHeader:{id:"valuesHeader",data:{value:"values",icon:"values-chart"},template:popupTemplates.iconHeader,css:"webix_pivot_popup_title",height:40},values:{view:"list",scroll:"auto",drag:!0,css:"webix_pivot_chart_values",type:{height:"auto"},template:webix.bind(popupTemplates.chartValues,e),onClick:{webix_link_title:webix.bind(clickHandlers$1.selector,e),webix_link_selection:webix.bind(clickHandlers$1.selector,e),webix_color_selection:webix.bind(clickHandlers$1.color,e),webix_pivot_minus:webix.bind(clickHandlers$1.remove,e)},on:e._getListEvents()},groupLayout:{rows:["groupHeader","groupBy"]},groupHeader:{data:{value:"groupBy",icon:"group"},template:popupTemplates.iconHeader,css:"webix_pivot_popup_title",height:40},groupBy:{view:"list",scroll:!1,drag:!0,type:{height:"auto"},template:webix.bind(popupTemplates.groupBy,e),on:e._getListEvents(),onClick:{webix_pivot_minus:webix.bind(clickHandlers.remove,e)}},chartLayout:{css:"webix_pivot_popup_chart",rows:["chartHeader","chartBody"]},chartHeader:{data:{value:"chart",icon:"chart"},template:popupTemplates.iconHeader,css:"webix_pivot_popup_title",height:40},chartBody:{view:"list",scroll:!1,drag:!1,type:{height:"auto",markCheckbox:function(e){return"undefined"==typeof e.markCheckbox&&(i.config.chart.scale&&"logarithmic"==i.config.chart.scale?e.markCheckbox=1:e.markCheckbox=0),"<span class='webix_icon wxi-checkbox-"+(
e.markCheckbox?"marked":"blank")+"'></span>"},getType:function(e){return e.chartType=a}},onClick:{webix_link_selection:function(e,t,i){var o,n={view:"webix_pivot_popup",css:"webix_pivot_popup",autofit:!0,autoheight:!0,width:150,data:r};(o=webix.ui(n)).show(i),o.attachEvent("onHide",webix.bind(function(){var e=o.getSelected();null!==e&&(a=e.id,this.refresh()),o.close()},this))},webix_chart_checkbox:function(e,t){var i=this.getItem(t);i.markCheckbox=i.markCheckbox?0:1,this.updateItem(t,i)}},template:function(e,t){return"logScale"===e.id?"<div class='webix_chart_checkbox'>"+t.markCheckbox(e,t)+"<span>"+e.title.toLowerCase()+"</span></div>":"<span class='webix_pivot_icon pt-bar-chart'></span><span>"+webix.i18n.pivot.chartType.toLowerCase()+"</span><span class='webix_link_selection'>"+webix.i18n.pivot[t.getType(e,t)]+"</span>"},data:[{title:webix.i18n.pivot.logScale,id:"logScale"},{title:webix.i18n.pivot.chartType,id:"chartType",chartType:a}]}}}webix.protoUI({name:"webix_pivot_chart_config",$init:function(){this.$view.className+=" webix_pivot_chart_popup webix_pivot"},defaults:{chartTypeLabelWidth:100,chartTypeWidth:302,logScaleLabelWidth:125,fieldsColumnWidth:240,popupWidth:890},_getUI:function(e){var t=webix.copy(getStructureMap$1(this,e));return this._setStructure(t,e)},_lists:["filters","values","groupBy"],_dndCorrection:{values:["groupBy"],groupBy:["values"]},_hidePopups:function(){webix.callEvent("onClick",[])},_afterInit:function(){this.attachEvent("onItemClick",function(e){if("button"==this.$eventSource.name){var t=this.innerId(e),i=this.getStructure();"apply"!=t||i.values.length&&i.groupBy?webix.$$(this.config.pivot).callEvent("onBefore"+t,[i])&&(this.callEvent("on"+t,[i]),this.hide()):webix.alert(webix.i18n.pivot.valuesNotDefined)}});for(var e=this.$view.querySelectorAll(".webix_pivot_configuration .webix_list"),t=0;t<e.length;t++)e[t].setAttribute("window-message",webix.i18n.pivot.windowMessage)},getStructure:function(){var i,o={groupBy:"",values:[],filters:[]},e=this.$$("groupBy");return e.count()&&(o.groupBy=e.getItem(e.getFirstId()).name),this.$$("values").data.each(webix.bind(function(e){for(var t=0;t<e.operation.length;t++)i=webix.copy(e),webix.extend(i,{operation:e.operation[t],color:e.color[t]||webix.$$(this.config.pivot).config.color},!0),o.values.push(i)},this)),this.$$("filters").data.each(function(e){o.filters.push(e)}),o}},webix.ui.webix_pivot_config_common);var defaults$1={fieldMap:{},rows:[],defaultOperation:"sum",filterLabelAlign:"right",filterWidth:200,filterMinWidth:180,editButtonWidth:110,filterLabelWidth:100,filterPlaceholder:!1,separateLabel:!0,chartType:"bar",color:"#36abee",chart:{},singleLegendItem:1,palette:[["#e33fc7","#a244ea","#476cee","#36abee","#58dccd","#a7ee70"],["#d3ee36","#eed236","#ee9336","#ee4339","#595959","#b85981"],["#c670b8","#9984ce","#b9b9e2","#b0cdfa","#a0e4eb","#7faf1b"],["#b4d9a4","#f2f79a","#ffaa7d","#d6806f","#939393","#d9b0d1"],["#780e3b","#684da9","#242464","#205793","#5199a4","#065c27"],["#54b15a","#ecf125","#c65000","#990001","#363636","#800f3e"]]};webix.protoUI({name:"pivot-chart",version:"{{version}}",defaults:defaults$1,templates:{groupNameToStr:function(e,t){return e+"_"+t},groupNameToObject:function(e){var t=e.split("_");return{name:t[0],operation:t[1]}},seriesTitle:function(e,t){var i=this.config.fieldMap[e.name]||this._capitalize(e.name),o=webix.isArray(e.operation)?e.operation[t]:e.operation;return i+" ( "+(webix.i18n.pivot[o]||o)+")"}},templates_setter:function(e){"object"==_typeof(e)&&webix.extend(this.templates,e)},chartMap:{bar:function(e){return{border:0,alpha:1,radius:0,color:e}},line:function(e){return{alpha:1,item:{borderColor:e,color:e},line:{color:e,width:2}}},radar:function(e){return{alpha:1,fill:!1,disableItems:!0,item:{borderColor:e,color:e},line:{color:e,width:2}}}},chartMap_setter:function(e){"object"==_typeof(e)&&webix.extend(this.chartMap,e,!0)},$init:function(e){!1===e.separateLabel&&(e.filterWidth=e.filterWidth||300),this.data.provideApi(this,!0),e.structure||(e.structure={}),webix.extend(e.structure,{groupBy:"",values:[],filters:[]}),
this.$view.className+=" webix_pivot webix_pivot_chart",webix.extend(e,{editButtonWidth:this.defaults.editButtonWidth}),webix.extend(e,this.getUI(e)),this.$ready.push(webix.bind(function(){webix.delay(this.render,this)},this)),this.data.attachEvent("onStoreUpdated",webix.bind(function(){this.$$("chart")&&this.render()},this)),this.attachEvent("onFilterChange",function(){this.render(!0)}),this.filters=new Filters},getUI:function(){return{rows:[{view:"toolbar",id:"filters",hidden:!0,paddingY:10,paddingX:5,borderless:!0,margin:10,cols:[]},{id:"bodyLayout",type:"line",margin:10,cols:[{id:"chart",view:"chart"}]}]}},configure:function(){if(!this._pivotPopup){var e={view:"webix_pivot_chart_config",operations:[],pivot:this.config.id};webix.extend(e,this.config.popup||{}),this._pivotPopup=webix.ui(e),this.callEvent("onPopup",[this._pivotPopup]),this._pivotPopup.attachEvent("onApply",webix.bind(function(e){this.config.chartType=this._pivotPopup.$$("chartBody")?this._pivotPopup.$$("chartBody").getItem("chartType").chartType:"bar",this.config.chart.scale=this._pivotPopup.$$("chartBody").getItem("logScale").markCheckbox?"logarithmic":"linear",webix.extend(this.config.structure,e,!0),this.render()},this))}var t=[];for(var i in this.operations)t.push({name:i,title:this._applyLocale(i)});this._pivotPopup._valueLength=this._valueLength||0,this._pivotPopup.define("operations",t);var o=webix.html.offset(this.$$("chart").getNode());this._pivotPopup.setPosition(o.x+10,o.y+10),this._pivotPopup.define("data",this.getFields()),this._pivotPopup.show()},destructor:function(){this._pivotPopup&&(this._eventId&&webix.eventRemove(this._eventId),this._pivotPopup.destructor(),this._pivotPopup=null),webix.Destruction.destructor.call(this)},render:function(e){e||showFilters(this,processFilters(this));this._valueLength=0;var t=this.config.structure;t&&t.groupBy&&t.values&&t.values.length?(this._setChartConfig(),this._loadFilteredData()):(this.config.structure={values:[]},this._setChartConfig())},_setChartConfig:function(){for(var e=this.config,t=e.structure.values,i=0;i<t.length;i++)t[i].operation=t[i].operation||[e.defaultOperation],webix.isArray(t[i].operation)||(t[i].operation=[t[i].operation]);var o=e.chartType||"bar",n=this.chartMap[o],r={type:n&&n("").type?n("").type:o,xAxis:webix.extend({template:"#id#"},e.chart.xAxis||{},!0),yAxis:webix.extend({},e.chart.yAxis||{})};webix.extend(r,e.chart),r.padding||(r.padding={top:17});var a=this._getSeries();for(var s in r.series=a.series,r.legend=!1,(e.singleLegendItem||1<this._valueLength)&&(r.legend=a.legend),r.scheme={$group:this._pivot_group,$sort:{by:"id"}},this.$$("chart").removeAllSeries(),r)this.$$("chart").define(s,r[s]);if(this.$$("chart")&&!e.readonly){var l=document.createElement("div");l.className="webix_pivot_configure",l.title=this._applyLocale("settings"),l.style.width=r.legend.width+"px",l.style.top=r.padding.top+"px",l.innerHTML="<span class='webix_pivot_icon pt-settings'></span><span class='webix_pivot_configure_label'>"+webix.i18n.pivot.pivotMessage+"</span>",this.$$("chart").$view.insertBefore(l,this.$$("chart").$view.querySelector("canvas")),this._eventId=webix.event(this.$$("chart").$view.querySelector(".webix_pivot_configure"),"click",function(){this.configure()}.bind(this))}},_applyLocale:function(e){return webix.i18n.pivot[e]||e},_capitalize:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},_applyMap:function(e,t){return this.config.fieldMap[e]||(t?this._capitalize(e):e)},_loadFilteredData:function(){var i=this.config.structure.filters;formatFilterValues(i),setFilterValues(i),this.data.silent(function(){var t=this;this.data.filter(function(e){return filterItem(i,e,t.config.filterMap)})},this),this.$$("chart").data.silent(function(){this.$$("chart").clearAll()},this),this.$$("chart").parse(this.data.getRange()),this.data.silent(function(){this.data.filter("")},this)},groupNameToStr:function(e){return e.name+"_"+e.operation},groupNameToObject:function(e){var t=e.split("_");return{name:t[0],operation:t[1]}},_getSeries:function(){var e,t,i,o,n,r={},a=[],
s=this.config.structure.values;for(i={valign:"middle",align:"right",width:220,layout:"y"},webix.extend(i,this.config.chart.legend||{},!0),i.values=[],i.marker||(i.marker={}),i.marker.type="line"==this.config.chartType?"item":"s",this.series_names=[],e=this._valueLength=0;e<s.length;e++)for(webix.isArray(s[e].operation)||(s[e].operation=[s[e].operation]),webix.isArray(s[e].color)||(s[e].color=[s[e].color||this._getColor(this._valueLength)]),t=0;t<s[e].operation.length;t++){o=this.templates.groupNameToStr(s[e].name,s[e].operation[t]),this.series_names.push(o),s[e].color[t]||(s[e].color[t]=this._getColor(this._valueLength));var l=s[e].color[t],u=this.chartMap[this.config.chartType](l)||{};u.value="#"+o+"#",u.tooltip={template:webix.bind(function(e){return e[this].toFixed(3)},o)},a.push(u),n=this.templates.seriesTitle.call(this,s[e],t),i.values.push({text:n,color:l}),r[o]=[s[e].name,s[e].operation[t]],this._valueLength++}return this._pivot_group={},s.length&&(this._pivot_group=webix.copy({by:this.config.structure.groupBy,map:r})),{series:a,legend:i}},_getColor:function(e){var t=this.config.palette,i=e/t[0].length;i=i>t.length?0:parseInt(i,10);var o=e%t[0].length;return t[i][o]},operations:{sum:1,count:1,max:1,min:1},addGroupMethod:function(e,t){this.operations[e]=1,t&&(webix.GroupMethods[e]=t)},removeGroupMethod:function(e){delete this.operations[e]},groupMethods_setter:function(e){for(var t in e)e.hasOwnProperty(t)&&this.addGroupMethod(t,e[t])},getFields:function(){var e,t=[],i={};for(e=0;e<Math.min(this.data.count()||5);e++){var o=this.data.getItem(this.data.getIdByIndex(e));for(var n in o)i[n]||(t.push(n),i[n]=webix.uid())}var r=this.config.structure,a={fields:[],groupBy:[],values:[],filters:[]},s="object"==_typeof(r.groupBy)?r.groupBy[0]:r.groupBy;webix.isUndefined(i[s])||a.groupBy.push({name:s,text:this._applyMap(s),id:i[s]});var l,u={};for(e=0;e<r.values.length;e++)if(s=r.values[e],!webix.isUndefined(i[s.name]))if(l=this._applyMap(s.name),webix.isUndefined(u[s.name]))u[s.name]=a.values.length,a.values.push({name:s.name,text:l,operation:s.operation,color:s.color||[this._getColor(e)],id:i[s.name]});else{var c=a.values[u[s.name]];c.operation=c.operation.concat(s.operation),c.color=c.color.concat(s.color||[this._getColor(e)])}for(e=0;e<(r.filters||[]).length;e++)s=r.filters[e],webix.isUndefined(i[s.name])||(l=this._applyMap(s.name),a.filters.push({name:s.name,text:l,type:s.type,value:s.value,id:i[s]}));for(t.sort(),e=0;e<t.length;e++)s=t[e],webix.isUndefined(i[s])||a.fields.push({name:s,text:this._applyMap(s),id:i[s]});return a},setStructure:function(e){this.define("structure",e),this.render()},getStructure:function(){return this.config.structure},getConfigWindow:function(){return this._pivotPopup},getFilterView:function(){return this.$$("filters")},$exportView:function(e){return webix.extend(e,{ignore:{$group:!0,$row:!0}}),this.$$("chart")}},webix.IdSpace,webix.ui.layout,webix.DataLoader,webix.EventSystem,webix.Settings)});
//# sourceMappingURL=pivot.js.map
