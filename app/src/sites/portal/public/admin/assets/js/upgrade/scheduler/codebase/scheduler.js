/*
@license
Webix <%= pkg.productName %> v.<%= pkg.version %>
This software is covered by Webix Trial License.
Usage without proper license is prohibited.
(c) XB Software Ltd.
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).scheduler={})}(this,(function(t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,i)};function i(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}var n=function(){return(n=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var r in e=arguments[i])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function r(){for(var t=0,e=0,i=arguments.length;e<i;e++)t+=arguments[e].length;var n=Array(t),r=0;for(e=0;e<i;e++)for(var a=arguments[e],o=0,s=a.length;o<s;o++,r++)n[r]=a[o];return n}var a=function(){},o=function(){function t(t,e){this.webixJet=!0,this.webix=t,this._events=[],this._subs={},this._data={},e&&e.params&&t.extend(this._data,e.params)}return t.prototype.getRoot=function(){return this._root},t.prototype.destructor=function(){this._detachEvents(),this._destroySubs(),this._events=this._container=this.app=this._parent=this._root=null},t.prototype.setParam=function(t,e,i){if(this._data[t]!==e&&(this._data[t]=e,this._segment.update(t,e,0),i))return this.show(null)},t.prototype.getParam=function(t,e){var i=this._data[t];if(void 0!==i||!e)return i;var n=this.getParentView();return n?n.getParam(t,e):void 0},t.prototype.getUrl=function(){return this._segment.suburl()},t.prototype.getUrlString=function(){return this._segment.toString()},t.prototype.getParentView=function(){return this._parent},t.prototype.$$=function(t){if("string"==typeof t){var e=this.getRoot();return e.queryView((function(i){return(i.config.id===t||i.config.localId===t)&&i.$scope===e.$scope}),"self")}return t},t.prototype.on=function(t,e,i){var n=t.attachEvent(e,i);return this._events.push({obj:t,id:n}),n},t.prototype.contains=function(t){for(var e in this._subs){var i=this._subs[e].view;if(i===t||i.contains(t))return!0}return!1},t.prototype.getSubView=function(t){var e=this.getSubViewInfo(t);if(e)return e.subview.view},t.prototype.getSubViewInfo=function(t){var e=this._subs[t||"default"];return e?{subview:e,parent:this}:"_top"===t?(this._subs[t]={url:"",id:null,popup:!0},this.getSubViewInfo(t)):this._parent?this._parent.getSubViewInfo(t):null},t.prototype._detachEvents=function(){for(var t=this._events,e=t.length-1;e>=0;e--)t[e].obj.detachEvent(t[e].id)},t.prototype._destroySubs=function(){for(var t in this._subs){var e=this._subs[t].view;e&&e.destructor()}this._subs={}},t.prototype._init_url_data=function(){var t=this._segment.current();this._data={},this.webix.extend(this._data,t.params,!0)},t.prototype._getDefaultSub=function(){if(this._subs.default)return this._subs.default;for(var t in this._subs){var e=this._subs[t];if(!e.branch&&e.view&&"_top"!==t){var i=e.view._getDefaultSub();if(i)return i}}},t.prototype._routed_view=function(){var t=this.getParentView();if(!t)return!0;var e=t._getDefaultSub();return!(!e&&e!==this)&&t._routed_view()},t}();function s(t){"/"===t[0]&&(t=t.substr(1));for(var e=t.split("/"),i=[],n=0;n<e.length;n++){var r=e[n],a={},o=r.indexOf(":");if(-1===o&&(o=r.indexOf("?")),-1!==o)for(var s=0,u=r.substr(o+1).split(/[\:\?\&]/g);s<u.length;s++){var c=u[s].split("=");a[c[0]]=decodeURIComponent(c[1])}i[n]={page:o>-1?r.substr(0,o):r,params:a,isNew:!0}}return i}function u(t){for(var e=[],i=0,n=t;i<n.length;i++){var r=n[i];e.push("/"+r.page);var a=c(r.params);a&&e.push("?"+a)}return e.join("")}function c(t){var e=[];for(var i in t)"object"!=typeof t[i]&&(e.length&&e.push("&"),e.push(i+"="+encodeURIComponent(t[i])));return e.join("")}var h=function(){function t(t,e){this._next=1,this.route="string"==typeof t?{url:s(t),path:t}:t,this.index=e}return t.prototype.current=function(){return this.route.url[this.index]},t.prototype.next=function(){return this.route.url[this.index+this._next]},t.prototype.suburl=function(){return this.route.url.slice(this.index)},t.prototype.shift=function(e){var i=new t(this.route,this.index+this._next);return i.setParams(i.route.url,e,i.index),i},t.prototype.setParams=function(t,e,i){if(e){var n=t[i].params;for(var r in e)n[r]=e[r]}},t.prototype.refresh=function(){for(var t=this.route.url,e=this.index+1;e<t.length;e++)t[e].isNew=!0},t.prototype.toString=function(){var t=u(this.suburl());return t?t.substr(1):""},t.prototype._join=function(t,e){var i=this.route.url;if(null===t)return i;var n=this.route.url,r=!0;if(i=n.slice(0,this.index+(e?this._next:0)),t){i=i.concat(s(t));for(var a=0;a<i.length;a++)n[a]&&(i[a].view=n[a].view),r&&n[a]&&i[a].page===n[a].page?i[a].isNew=!1:i[a].isNew&&(r=!1)}return i},t.prototype.append=function(t){var e=this._join(t,!0);return this.route.path=u(e),this.route.url=e,this.route.path},t.prototype.show=function(t,e,i){var n=this,r=this._join(t.url,i);return this.setParams(r,t.params,this.index+(i?this._next:0)),new Promise((function(t,i){var o=u(r),s={url:r,redirect:o,confirm:Promise.resolve()},c=e?e.app:null;if(c&&!c.callEvent("app:guard",[s.redirect,e,s]))return void i(new a);s.confirm.catch((function(t){return i(t)})).then((function(){if(null!==s.redirect){if(s.redirect!==o)return c.show(s.redirect),void i(new a);n.route.path=o,n.route.url=r,t()}else i(new a)}))}))},t.prototype.size=function(t){this._next=t},t.prototype.split=function(){var e={url:this.route.url.slice(this.index+1),path:""};return e.url.length&&(e.path=u(e.url)),new t(e,0)},t.prototype.update=function(t,e,i){var n=this.route.url[this.index+(i||0)];if(!n)return this.route.url.push({page:"",params:{}}),this.update(t,e,i);""===t?n.page=e:n.params[t]=e,this.route.path=u(this.route.url)},t}(),l=function(t){function e(e,i){var n=t.call(this,e.webix)||this;return n.app=e,n._children=[],n}return i(e,t),e.prototype.ui=function(t,e){var i=(e=e||{}).container||t.container,n=this.app.createView(t);return this._children.push(n),n.render(i,this._segment,this),"object"!=typeof t||t instanceof o?n:n.getRoot()},e.prototype.show=function(t,e){if(e=e||{},"object"==typeof t){for(var i in t)this.setParam(i,t[i]);t=null}else{if("/"===t.substr(0,1))return this.app.show(t,e);if(0===t.indexOf("./")&&(t=t.substr(2)),0===t.indexOf("../")){var n=this.getParentView();return n?n.show(t.substr(3),e):this.app.show("/"+t.substr(3))}var r=this.getSubViewInfo(e.target);if(r){if(r.parent!==this)return r.parent.show(t,e);if(e.target&&"default"!==e.target)return this._renderFrameLock(e.target,r.subview,{url:t,params:e.params})}else if(t)return this.app.show("/"+t,e)}return this._show(this._segment,{url:t,params:e.params},this)},e.prototype._show=function(t,e,i){var n=this;return t.show(e,i,!0).then((function(){return n._init_url_data(),n._urlChange()})).then((function(){t.route.linkRouter&&(n.app.getRouter().set(t.route.path,{silent:!0}),n.app.callEvent("app:route",[t.route.path]))}))},e.prototype.init=function(t,e){},e.prototype.ready=function(t,e){},e.prototype.config=function(){this.app.webix.message("View:Config is not implemented")},e.prototype.urlChange=function(t,e){},e.prototype.destroy=function(){},e.prototype.destructor=function(){this.destroy(),this._destroyKids(),this._root&&(this._root.destructor(),t.prototype.destructor.call(this))},e.prototype.use=function(t,e){t(this.app,this,e)},e.prototype.refresh=function(){this.getUrl();return this.destroy(),this._destroyKids(),this._destroySubs(),this._detachEvents(),this._container.tagName&&this._root.destructor(),this._segment.refresh(),this._render(this._segment)},e.prototype.render=function(t,e,i){var n=this;"string"==typeof e&&(e=new h(e,0)),this._segment=e,this._parent=i,this._init_url_data();var r="string"==typeof(t=t||document.body)?this.webix.toNode(t):t;return this._container!==r?(this._container=r,this._render(e)):this._urlChange().then((function(){return n.getRoot()}))},e.prototype._render=function(t){var e=this,i=this.config();return i.then?i.then((function(i){return e._render_final(i,t)})):this._render_final(i,t)},e.prototype._render_final=function(t,e){var i,n=this,r=null,a=null,o=!1;if(this._container.tagName?a=this._container:(r=this._container).popup?(a=document.body,o=!0):a=this.webix.$$(r.id),!this.app||!a)return Promise.reject(null);var s=this._segment.current(),u={ui:{}};this.app.copyConfig(t,u.ui,this._subs),this.app.callEvent("app:render",[this,e,u]),u.ui.$scope=this,!r&&s.isNew&&s.view&&s.view.destructor();try{if(r&&!o){var c=a,h=c.getParentView();h&&"multiview"===h.name&&!u.ui.id&&(u.ui.id=c.config.id)}this._root=this.app.webix.ui(u.ui,a);var l=this._root;o&&l.setPosition&&!l.isVisible()&&l.show(),r&&(r.view&&r.view!==this&&r.view!==this.app&&r.view.destructor(),r.id=this._root.config.id,this.getParentView()||!this.app.app?r.view=this:r.view=this.app),s.isNew&&(s.view=this,s.isNew=!1),i=Promise.resolve(this._init(this._root,e)).then((function(){return n._urlChange().then((function(){return n._initUrl=null,n.ready(n._root,e.suburl())}))}))}catch(t){i=Promise.reject(t)}return i.catch((function(t){return n._initError(n,t)}))},e.prototype._init=function(t,e){return this.init(t,e.suburl())},e.prototype._urlChange=function(){var t=this;this.app.callEvent("app:urlchange",[this,this._segment]);var e=[];for(var i in this._subs){var n=this._subs[i],r=this._renderFrameLock(i,n,null);r&&e.push(r)}return Promise.all(e).then((function(){return t.urlChange(t._root,t._segment.suburl())}))},e.prototype._renderFrameLock=function(t,e,i){if(!e.lock){var n=this._renderFrame(t,e,i);n&&(e.lock=n.then((function(){return e.lock=null}),(function(){return e.lock=null})))}return e.lock},e.prototype._renderFrame=function(t,e,i){var n=this;if("default"===t){if(this._segment.next()){var r=i?i.params:null;return e.params&&(r=this.webix.extend(r||{},e.params)),this._createSubView(e,this._segment.shift(r))}e.view&&e.popup&&(e.view.destructor(),e.view=null)}if(null!==i&&(e.url=i.url,e.params&&(i.params=this.webix.extend(i.params||{},e.params))),e.route){if(null!==i)return e.route.show(i,e.view).then((function(){return n._createSubView(e,e.route)}));if(e.branch)return}var a=e.view;if(!a&&e.url){if("string"==typeof e.url)return e.route=new h(e.url,0),i&&e.route.setParams(e.route.route.url,i.params,0),e.params&&e.route.setParams(e.route.route.url,e.params,0),this._createSubView(e,e.route);"function"!=typeof e.url||a instanceof e.url||(a=new(this.app._override(e.url))(this.app,"")),a||(a=e.url)}if(a)return a.render(e,e.route||this._segment,this)},e.prototype._initError=function(t,e){return this.app&&this.app.error("app:error:initview",[e,t]),!0},e.prototype._createSubView=function(t,e){var i=this;return this.app.createFromURL(e.current()).then((function(n){return n.render(t,e,i)}))},e.prototype._destroyKids=function(){for(var t=this._children,e=t.length-1;e>=0;e--)t[e]&&t[e].destructor&&t[e].destructor();this._children=[]},e}(o),d=function(t){function e(e,i){var n=t.call(this,e,i)||this;return n._ui=i.ui,n}return i(e,t),e.prototype.config=function(){return this._ui},e}(l),p=function(){function t(t,e,i){this.path="",this.app=i}return t.prototype.set=function(t,e){this.path=t;var i=this.app;i.app.getRouter().set(i._segment.append(this.path),{silent:!0})},t.prototype.get=function(){return this.path},t}(),f=!0,v=function(t){function e(e){var i=this,n=(e||{}).webix||window.webix;return e=n.extend({name:"App",version:"1.0",start:"/home"},e,!0),(i=t.call(this,n,e)||this).config=e,i.app=i.config.app,i.ready=Promise.resolve(),i._services={},i.webix.extend(i,i.webix.EventSystem),i}return i(e,t),e.prototype.getUrl=function(){return this._subSegment.suburl()},e.prototype.getUrlString=function(){return this._subSegment.toString()},e.prototype.getService=function(t){var e=this._services[t];return"function"==typeof e&&(e=this._services[t]=e(this)),e},e.prototype.setService=function(t,e){this._services[t]=e},e.prototype.destructor=function(){this.getSubView().destructor(),t.prototype.destructor.call(this)},e.prototype.copyConfig=function(t,e,i){if((t instanceof o||"function"==typeof t&&t.prototype instanceof o)&&(t={$subview:t}),void 0!==t.$subview)return this.addSubView(t,e,i);var n=t instanceof Array;for(var r in e=e||(n?[]:{}),t){var a=t[r];if("function"==typeof a&&a.prototype instanceof o&&(a={$subview:a}),!a||"object"!=typeof a||a instanceof this.webix.DataCollection||a instanceof RegExp||a instanceof Map)e[r]=a;else if(a instanceof Date)e[r]=new Date(a);else{var s=this.copyConfig(a,a instanceof Array?[]:{},i);null!==s&&(n?e.push(s):e[r]=s)}}return e},e.prototype.getRouter=function(){return this.$router},e.prototype.clickHandler=function(t,e){if(t&&(e=e||t.target||t.srcElement)&&e.getAttribute){var i=e.getAttribute("trigger");if(i)return this._forView(e,(function(t){return t.app.trigger(i)})),t.cancelBubble=!0,t.preventDefault();var n=e.getAttribute("route");if(n)return this._forView(e,(function(t){return t.show(n)})),t.cancelBubble=!0,t.preventDefault()}var r=e.parentNode;r&&this.clickHandler(t,r)},e.prototype.getRoot=function(){return this.getSubView().getRoot()},e.prototype.refresh=function(){var t=this;return this._subSegment?this.getSubView().refresh().then((function(e){return t.callEvent("app:route",[t.getUrl()]),e})):Promise.resolve(null)},e.prototype.loadView=function(t){var e=this,i=this.config.views,n=null;if(""===t)return Promise.resolve(this._loadError("",new Error("Webix Jet: Empty url segment")));try{i&&"string"==typeof(n="function"==typeof i?i(t):i[t])&&(t=n,n=null),n||("_hidden"===t?n={hidden:!0}:"_blank"===t?n={}:(t=t.replace(/\./g,"/"),n=this.require("jet-views",t)))}catch(e){n=this._loadError(t,e)}return n.then||(n=Promise.resolve(n)),n=n.then((function(t){return t.__esModule?t.default:t})).catch((function(i){return e._loadError(t,i)}))},e.prototype._forView=function(t,e){var i=this.webix.$$(t);i&&e(i.$scope)},e.prototype._loadViewDynamic=function(t){return null},e.prototype.createFromURL=function(t){var e=this;return t.isNew||!t.view?this.loadView(t.page).then((function(i){return e.createView(i,name,t.params)})):Promise.resolve(t.view)},e.prototype._override=function(t){var e=this.config.override;if(e){for(var i=void 0;t;)i=t,t=e.get(t);return i}return t},e.prototype.createView=function(t,i,n){if("function"==typeof(t=this._override(t))){if(t.prototype instanceof e)return new t({app:this,name:i,params:n,router:p});if(t.prototype instanceof o)return new t(this,{name:i,params:n});t=t(this)}return t instanceof o?t:new d(this,{name:i,ui:t})},e.prototype.show=function(t,e){return t&&this.app&&0==t.indexOf("//")?this.app.show(t.substr(1),e):this.render(this._container,t||this.config.start,e)},e.prototype.trigger=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];this.apply(t,e)},e.prototype.apply=function(t,e){this.callEvent(t,e)},e.prototype.action=function(t){return this.webix.bind((function(){for(var e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];this.apply(t,e)}),this)},e.prototype.on=function(t,e){this.attachEvent(t,e)},e.prototype.use=function(t,e){t(this,null,e)},e.prototype.error=function(t,e){if(this.callEvent(t,e),this.callEvent("app:error",e),this.config.debug)for(var i=0;i<e.length;i++)if(console.error(e[i]),e[i]instanceof Error){var n=e[i].message;0===n.indexOf("Module build failed")?(n=n.replace(/\x1b\[[0-9;]*m/g,""),document.body.innerHTML="<pre style='font-size:16px; background-color: #ec6873; color: #000; padding:10px;'>"+n+"</pre>"):(n+="<br><br>Check console for more details",this.webix.message({type:"error",text:n,expire:-1}))}},e.prototype.render=function(t,e,i){var n=this;this._container="string"==typeof t?this.webix.toNode(t):t||document.body;var r=null;!this.$router?(f&&"tagName"in this._container&&(this.webix.event(document.body,"click",(function(t){return n.clickHandler(t)})),f=!1),"string"==typeof e&&(e=new h(e,0)),this._subSegment=this._first_start(e),this._subSegment.route.linkRouter=!0):r="string"==typeof e?e:this.app?e.split().route.path||this.config.start:e.toString();var a=i?i.params:this.config.params||null,o=this.getSubView(),s=this._subSegment,u=s.show({url:r,params:a},o).then((function(){return n.createFromURL(s.current())})).then((function(e){return e.render(t,s)})).then((function(t){return n.$router.set(s.route.path,{silent:!0}),n.callEvent("app:route",[n.getUrl()]),t}));return this.ready=this.ready.then((function(){return u})),u},e.prototype.getSubView=function(){if(this._subSegment){var t=this._subSegment.current().view;if(t)return t}return new l(this,{})},e.prototype.require=function(t,e){return null},e.prototype._first_start=function(t){var e=this;this._segment=t;if(this.$router=new this.config.router((function(t){return setTimeout((function(){e.show(t).catch((function(t){if(!(t instanceof a))throw t}))}),1)}),this.config,this),this._container===document.body&&!1!==this.config.animation){var i=this._container;this.webix.html.addCss(i,"webixappstart"),setTimeout((function(){e.webix.html.removeCss(i,"webixappstart"),e.webix.html.addCss(i,"webixapp")}),10)}if(t){if(this.app){var n=t.current().view;t.current().view=this,t.next()?(t.refresh(),t=t.split()):t=new h(this.config.start,0),t.current().view=n}}else{var r=this.$router.get();r||(r=this.config.start,this.$router.set(r,{silent:!0})),t=new h(r,0)}return t},e.prototype._loadError=function(t,e){return this.error("app:error:resolve",[e,t]),{template:" "}},e.prototype.addSubView=function(t,e,i){var n=!0!==t.$subview?t.$subview:null,r=t.name||(n?this.webix.uid():"default");return e.id=t.id||"s"+this.webix.uid(),(i[r]={id:e.id,url:n,branch:t.branch,popup:t.popup,params:t.params}).popup?null:e},e}(o),g=function(){function t(t,e){var i=this;this.config=e||{},this._detectPrefix(),this.cb=t,window.onpopstate=function(){return i.cb(i.get())}}return t.prototype.set=function(t,e){var i=this;if(this.config.routes){var n=t.split("?",2);for(var r in this.config.routes)if(this.config.routes[r]===n[0]){t=r+(n.length>1?"?"+n[1]:"");break}}this.get()!==t&&window.history.pushState(null,null,this.prefix+this.sufix+t),e&&e.silent||setTimeout((function(){return i.cb(t)}),1)},t.prototype.get=function(){var t=this._getRaw().replace(this.prefix,"").replace(this.sufix,"");if(t="/"!==t&&"#"!==t?t:"",this.config.routes){var e=t.split("?",2),i=this.config.routes[e[0]];i&&(t=i+(e.length>1?"?"+e[1]:""))}return t},t.prototype._detectPrefix=function(){var t=this.config.routerPrefix;this.sufix="#"+(void 0===t?"!":t),this.prefix=document.location.href.split("#",2)[0]},t.prototype._getRaw=function(){return document.location.href},t}(),y=!1;function m(t){if(!y&&t){y=!0;var e=window;e.Promise||(e.Promise=t.promise);var i=t.version.split(".");10*i[0]+1*i[1]<53&&(t.ui.freeze=function(e){var i=e();return i&&i.then?i.then((function(e){return t.ui.$freeze=!1,t.ui.resize(),e})):(t.ui.$freeze=!1,t.ui.resize()),i});var n=t.ui.baselayout.prototype.addView,r=t.ui.baselayout.prototype.removeView,a={addView:function(t,e){if(this.$scope&&this.$scope.webixJet&&!t.queryView){var i=this.$scope,r={};t=i.app.copyConfig(t,{},r),n.apply(this,[t,e]);var a=function(t){i._renderFrame(t,r[t],null).then((function(){i._subs[t]=r[t]}))};for(var o in r)a(o);return t.id}return n.apply(this,arguments)},removeView:function(){if(r.apply(this,arguments),this.$scope&&this.$scope.webixJet){var e=this.$scope._subs;for(var i in e){var n=e[i];t.$$(n.id)||(n.view.destructor(),delete e[i])}}}};t.extend(t.ui.layout.prototype,a,!0),t.extend(t.ui.baselayout.prototype,a,!0),t.protoUI({name:"jetapp",$init:function(e){this.$app=new this.app(e);var i=t.uid().toString();e.body={id:i},this.$ready.push((function(){this.callEvent("onInit",[this.$app]),this.$app.render({id:i})}))}},t.ui.proxy,t.EventSystem)}}var w=function(t){function e(e){var i;return e.router=e.router||g,m((i=t.call(this,e)||this).webix),i}return i(e,t),e.prototype.require=function(t,e){return require(t+"/"+e)},e}(v),_=(function(t){function e(){return null!==t&&t.apply(this,arguments)||this}i(e,t),e.prototype._detectPrefix=function(){this.prefix="",this.sufix=this.config.routerPrefix||""},e.prototype._getRaw=function(){return document.location.pathname+(document.location.search||"")}}(g),function(){function t(t,e){this.path="",this.cb=t}return t.prototype.set=function(t,e){var i=this;this.path=t,e&&e.silent||setTimeout((function(){return i.cb(t)}),1)},t.prototype.get=function(){return this.path},t}());function b(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function x(t,e,i){for(var n in t)b(t,n)&&e.call(i||t,t[n],n,t)}function S(t){t="Warning: "+t,"undefined"!=typeof console&&console.error(t);try{throw new Error(t)}catch(t){}}var D=String.prototype.replace,E=String.prototype.split,$=function(t){var e=t%10;return 11!==t&&1===e?0:2<=e&&e<=4&&!(t>=12&&t<=14)?1:2},C={arabic:function(t){if(t<3)return t;var e=t%100;return e>=3&&e<=10?3:e>=11?4:5},bosnian_serbian:$,chinese:function(){return 0},croatian:$,french:function(t){return t>1?1:0},german:function(t){return 1!==t?1:0},russian:$,lithuanian:function(t){return t%10==1&&t%100!=11?0:t%10>=2&&t%10<=9&&(t%100<11||t%100>19)?1:2},czech:function(t){return 1===t?0:t>=2&&t<=4?1:2},polish:function(t){if(1===t)return 0;var e=t%10;return 2<=e&&e<=4&&(t%100<10||t%100>=20)?1:2},icelandic:function(t){return t%10!=1||t%100==11?1:0},slovenian:function(t){var e=t%100;return 1===e?0:2===e?1:3===e||4===e?2:3}},T={arabic:["ar"],bosnian_serbian:["bs-Latn-BA","bs-Cyrl-BA","srl-RS","sr-RS"],chinese:["id","id-ID","ja","ko","ko-KR","lo","ms","th","th-TH","zh"],croatian:["hr","hr-HR"],german:["fa","da","de","en","es","fi","el","he","hi-IN","hu","hu-HU","it","nl","no","pt","sv","tr"],french:["fr","tl","pt-br"],russian:["ru","ru-RU"],lithuanian:["lt"],czech:["cs","cs-CZ","sk"],polish:["pl"],icelandic:["is"],slovenian:["sl-SL"]};function k(t){var e,i=(e={},x(T,(function(t,i){x(t,(function(t){e[t]=i}))})),e);return i[t]||i[E.call(t,/-/,1)[0]]||i.en}function L(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}var I=/\$/g,A=/%\{(.*?)\}/g;function P(t,e,i,n){if("string"!=typeof t)throw new TypeError("Polyglot.transformPhrase expects argument #1 to be string");if(null==e)return t;var r=t,a=n||A,o="number"==typeof e?{smart_count:e}:e;if(null!=o.smart_count&&r){var s=E.call(r,"||||");r=(s[function(t,e){return C[k(t)](e)}(i||"en",o.smart_count)]||s[0]).replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}return r=D.call(r,a,(function(t,e){return b(o,e)&&null!=o[e]?D.call(o[e],I,"$$"):t}))}function N(t){var e=t||{};this.phrases={},this.extend(e.phrases||{}),this.currentLocale=e.locale||"en";var i=e.allowMissing?P:null;this.onMissingKey="function"==typeof e.onMissingKey?e.onMissingKey:i,this.warn=e.warn||S,this.tokenRegex=function(t){var e=t&&t.prefix||"%{",i=t&&t.suffix||"}";if("||||"===e||"||||"===i)throw new RangeError('"||||" token is reserved for pluralization');return new RegExp(L(e)+"(.*?)"+L(i),"g")}(e.interpolation)}N.prototype.locale=function(t){return t&&(this.currentLocale=t),this.currentLocale},N.prototype.extend=function(t,e){x(t,(function(t,i){var n=e?e+"."+i:i;"object"==typeof t?this.extend(t,n):this.phrases[n]=t}),this)},N.prototype.unset=function(t,e){"string"==typeof t?delete this.phrases[t]:x(t,(function(t,i){var n=e?e+"."+i:i;"object"==typeof t?this.unset(t,n):delete this.phrases[n]}),this)},N.prototype.clear=function(){this.phrases={}},N.prototype.replace=function(t){this.clear(),this.extend(t)},N.prototype.t=function(t,e){var i,n,r=null==e?{}:e;if("string"==typeof this.phrases[t])i=this.phrases[t];else if("string"==typeof r._)i=r._;else if(this.onMissingKey){n=(0,this.onMissingKey)(t,r,this.currentLocale,this.tokenRegex)}else this.warn('Missing translation for key: "'+t+'"'),n=t;return"string"==typeof i&&(n=P(i,r,this.currentLocale,this.tokenRegex)),n},N.prototype.has=function(t){return b(this.phrases,t)},N.transformPhrase=function(t,e,i){return P(t,e,i)};var O=N;var R=window.webix;R&&m(R);var Y=function(t,e,i){var n=(i=i||{}).storage,r=n?n.get("lang")||"en":i.lang||"en";function a(e,a,o){a.__esModule&&(a=a.default);var u={phrases:a};i.polyglot&&t.webix.extend(u,i.polyglot);var c=s.polyglot=new O(u);if(c.locale(e),s._=t.webix.bind(c.t,c),r=e,n&&n.put("lang",r),i.webix){var h=i.webix[e];h&&t.webix.i18n.setLocale(h)}return o?Promise.resolve():t.refresh()}function o(e,n){if(!1!==i.path){var r=(i.path?i.path+"/":"")+e;a(e,t.require("jet-locales",r),n)}}var s={getLang:function(){return r},setLang:o,setLangData:a,_:null,polyglot:null};t.setService("locale",s),o(r,!0)},M=window;M.Promise||(M.Promise=M.webix.promise);var F=1;function B(t,e,i){Object.defineProperty(e,i,{get:function(){return t[i]},set:function(e){return t[i]=e}})}function H(t,e){e=e||{};var i={},n={},r=function(t,e){var r=F++;return i[r]={mask:t,handler:e},e("*"===t?n:n[t],void 0,t),r},a=[],o=!1,s=function(t,e,n,r){if(o)a.push([t,e,n,r]);else for(var s=Object.keys(i),u=0;u<s.length;u++){var c=i[s[u]];c&&("*"!==c.mask&&c.mask!==t||c.handler(n,e,t,r))}};return Object.defineProperty(n,"$changes",{value:{attachEvent:r,detachEvent:function(t){delete i[t]}},enumerable:!1,configurable:!1}),Object.defineProperty(n,"$observe",{value:r,enumerable:!1,configurable:!1}),Object.defineProperty(n,"$batch",{value:function(t){if("function"!=typeof t){var e=t;t=function(){for(var t in e)n[t]=e[t]}}for(o=!0,t(n),o=!1;a.length;){var i=a.shift();s.apply(this,i)}},enumerable:!1,configurable:!1}),Object.defineProperty(n,"$extend",{value:function(t,i){for(var r in i=i||e,t)if(t.hasOwnProperty(r)){var a=t[r];i.nested&&"object"==typeof a&&a?n[r]=H(a,i):U(n,a,r,s)}},enumerable:!1,configurable:!1}),n.$extend(t,e),n}function U(t,e,i,n){Object.defineProperty(t,i,{get:function(){return e},set:function(t){if(null===e||null===t?e!==t:e.valueOf()!=t.valueOf()){var r=e;e=t,n(i,r,t,null)}},enumerable:!0,configurable:!1})}var V=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._,i=this.getParam("compact",!0),n=this.app.config.calendars;return{view:"align",body:{view:i?"icon":"button",type:"icon",icon:"wxi-plus",css:"webix_primary",label:e("Create"),width:i?50:n?185:100,height:i?50:webix.skin.$active.inputHeight,on:{onItemClick:function(){return t.AddEvent()}}},align:"middle"}},e.prototype.AddEvent=function(){this.app.getState().selected={id:"0"}},e}(l),j=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this;return{cols:[{view:"icon",icon:"wxi-angle-left",tooltip:function(){return t.NavLabel(-1)},align:"left",on:{onItemClick:function(){return t.ChangeDate(-1)}}},{view:"label",localId:"title",align:"center",width:160},{view:"icon",icon:"wxi-angle-right",tooltip:function(){return t.NavLabel(1)},align:"right",on:{onItemClick:function(){return t.ChangeDate(1)}}}]}},e.prototype.init=function(){var t=this;this.State=this.app.getState(),this.on(this.State.$changes,"date",(function(){return t.DateLabel()})),this.on(this.State.$changes,"mode",(function(){return t.DateLabel()}))},e.prototype.ChangeDate=function(t){var e=this.State,i="agenda"==e.mode?"month":e.mode,n=webix.Date.add(e.date,t,i,!0);if("month"===e.mode){var r=Math.abs(e.date.getMonth()-n.getMonth());1!=r&&r<6&&n.setDate(0)}e.$batch({date:n,selected:null})},e.prototype.DateLabel=function(){var t=this.State.date,e="day"==this.State.mode?webix.i18n.longDateFormatStr(t):webix.Date.dateToStr("%F %Y")(t);this.$$("title").setHTML(e)},e.prototype.NavLabel=function(t){var e=this.app.getService("locale")._,i=this.State.mode;return e((t=t>0?"Next":"Previous")+(i=-1!==["month","week","day"].indexOf(i)?" "+i:""))},e}(l),W=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._,i=this.getParam("compact",!0),n={hidden:i,view:"tabbar",bottomOffset:0,localId:"buttons",borderless:!0,width:320,optionWidth:80,options:[{id:"day",value:e("Day")},{id:"week",value:e("Week")},{id:"month",value:e("Month")},{id:"agenda",value:e("Agenda")}]};return i||(n.on={onChange:function(e){return t.SetMode(e)}}),n},e.prototype.init=function(){var t=this;this.State=this.app.getState(),this.on(this.State.$changes,"mode",(function(e){t.$$("buttons").setValue(e)}))},e.prototype.SetMode=function(t){this.State.$batch({mode:t,selected:null})},e}(l);function G(){var t=webix.skin.$active;return{view:"colorboard",css:"webix_scheduler_palette",height:3*t.optionHeight+4,width:7*t.optionHeight+4,palette:[["#61AEE6","#01C2A5","#E88DD9","#D2FB9E","#6BA8CB","#61BBA5","#CF89D5"],["#EF9C80","#8289EE","#74B1A7","#DD89AF","#E48882","#997CEB","#ADD579"],["#F68896","#FFE999","#6D4BCE","#99CA58","#D352BE","#F7CC34","#DA5C53"]]}}var z=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.getParam("compact",!0),i=this.app.getService("locale")._,n={view:"button",value:i("Save"),align:"right",inputWidth:100,css:"webix_primary",click:function(){return t.Save()}},r=webix.skin.$active,a={view:"toolbar",padding:{left:r.layoutPadding.form-(r.inputHeight-20)/2,right:r.layoutPadding.form},elements:[{view:"icon",icon:"wxi-close",click:function(){return t.getRoot().hide()}},{},n]},o=[{view:"button",localId:"removeBtn",value:i("Delete"),css:"webix_danger webix_scheduler_danger",hidden:!0,align:e?"center":"left",inputWidth:e?330:100,click:function(){return t.Delete()}}];e||o.push(n);var s={view:"window",width:400,modal:!0,close:!0,position:"center",borderless:e,fullscreen:e,css:"webix_scheduler_cal_popup",head:e?a:i("Edit calendar"),body:{view:"form",localId:"calendars:form",elements:[{view:"text",label:i("Title"),name:"text"},{view:"colorpicker",label:i("Color"),name:"color",suggest:{type:"colorboard",padding:3,body:G()}},{view:"checkbox",label:i("Active"),name:"active"},{cols:o}]},on:{onHide:function(){t.Form.clear(),t.$$("removeBtn").hide()}}};return e&&s.body.elements.splice(3,0,{}),s},e.prototype.init=function(){this.Cals=this.app.getService("local").calendars(!0),this.Ops=this.app.getService("operations"),this.Form=this.$$("calendars:form")},e.prototype.Show=function(t){if(t){var e=this.Cals.getItem(t);this.Form.setValues(e),this.$$("removeBtn").show()}else this.Form.setValues({color:"#997CEB",active:1});this.getRoot().show(),this.Form.focus()},e.prototype.Save=function(){var t=this.Form.getValues();t.id?this.Ops.updateCalendar(t.id,t):this.Ops.addCalendar(t),this.getRoot().hide()},e.prototype.Delete=function(){var t=this,e=this.Form.getValues(),i=this.app.getService("locale")._;webix.confirm(i("Do you really want to remove this calendar?")).then((function(){t.Ops.removeCalendar(e.id),t.getRoot().hide()}))},e}(l),Q=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._;return{view:"popup",relative:"right",body:{rows:[webix.extend(G(),{localId:"colors",on:{onItemClick:function(e){return t.UpdateColor(e)}}}),{css:"webix_scheduler_settings",template:e("Settings"),height:webix.skin.$active.inputHeight,onClick:{webix_template:function(){return t.ShowEditor()}}}]},on:{onHide:function(){return t.app.callEvent("side:popup:hide",[])}}}},e.prototype.init=function(){this.Editor=this.ui(z)},e.prototype.Show=function(t,e,i){this.Cid=t,this.getRoot().show(e),this.$$("colors").setValue(i)},e.prototype.ShowEditor=function(){this.Editor.Show(this.Cid),this.getRoot().hide()},e.prototype.UpdateColor=function(t){this.app.getService("operations").updateCalendar(this.Cid,{color:t}),this.getRoot().hide()},e.prototype.Hide=function(){this.getRoot().hide()},e}(l),q=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this;this.Compact=this.getParam("compact",!0);var e=this.app.getService("locale")._,i=this.app.getState(),n={view:"calendar",localId:"calendar",height:276,monthSelect:!1,on:{onDateSelect:function(t){i.date=webix.Date.dayStart(t)}}},r={view:"list",localId:"calendars",type:this.ListType(e,i),borderless:!0,autoheight:!0,yCount:5,editable:!0,editValue:"text",editaction:"custom",editor:"text",css:"webix_scheduler_cal_list",tooltip:function(){return""},onClick:{webix_scheduler_cal_edit:function(e,i){return t.ShowPopup(e,i)},webix_scheduler_cal_title:function(e,i){return t.ToggleCalendar(i)},webix_scheduler_active:function(e,i){return t.ToggleCalendar(i)}},on:{onBeforeEditStop:function(e,i){return t.SetTitle(i.id,e.value)}}},a={type:"form",padding:{top:8},rows:[{maxHeight:100},r,{view:"button",localId:"add",value:e("Add calendar"),hidden:!i.readonly,inputWidth:190,align:"center",click:function(){return t.AddCalendar()}},{}]};return this.Compact||(r.on.onAfterScroll=function(){return t.Popup.Hide()},a={view:"scrollview",body:{type:"clean",rows:[n,a]}}),a},e.prototype.init=function(){var t=this;this.Cals=this.$$("calendars"),this.Data=this.app.getService("local"),this.Ops=this.app.getService("operations"),this.Popup=this.Compact?this.ui(z):this.ui(Q),webix.extend(this.Cals,webix.EditAbility),this.Data.calendars().then((function(e){return t.Cals.parse(e)}));var e=this.app.getState();this.Compact||(this.on(e.$changes,"date",(function(e){t.$$("calendar").setValue(e)})),this.on(this.app,"side:popup:hide",(function(){t.Cals.unselectAll()}))),this.on(e.$changes,"readonly",(function(e){return t.ToggleState(e)}))},e.prototype.ListType=function(t,e){return{checkbox:function(t){var e=1*t.active?"wxi-checkbox-marked":"wxi-checkbox-blank";return'<span style="color:'+t.color+';" \n\t\t\t\t\trole="checkbox" tabindex="-1" \n\t\t\t\t\taria-checked="'+(t.active?"true":"false")+'" \n\t\t\t\t\tclass="webix_icon webix_scheduler_active '+e+'">\n\t\t\t\t</span>'},template:function(i,n){var r='\n\t\t\t\t\t<span\n\t\t\t\t\t\twebix_tooltip="'+t("Edit calendar")+'" \n\t\t\t\t\t\tclass="webix_icon wxi-dots webix_scheduler_cal_edit \n\t\t\t\t\t\t\t'+(webix.env.touch?" webix_scheduler_cal_visible":"")+'\n\t\t\t\t\t\t">\n\t\t\t\t\t</span>\n\t\t\t\t';return"\n\t\t\t\t\t"+n.checkbox(i)+'\n\t\t\t\t\t<span class="webix_scheduler_cal_title">'+(i.text||t("(no title)"))+"</span>\n\t\t\t\t\t"+(e.readonly?"":r)+"\n\t\t\t\t"}}},e.prototype.AddCalendar=function(){var t=this,e=this.app.getService("locale")._;this.Ops.addCalendar().then((function(i){t.Cals.edit(i),t.Cals.getEditor().getInputNode().setAttribute("placeholder",e("(no title)"))}))},e.prototype.ShowPopup=function(t,e){if(this.Compact)this.Popup.Show(e);else{this.Cals.select(e);var i=this.Cals.getItem(e).color;this.Popup.Show(e,this.Cals.getItemNode(e),i)}},e.prototype.ToggleCalendar=function(t){var e=this.Cals.getItem(t);this.Ops.updateCalendar(t,{active:1^e.active})},e.prototype.ToggleState=function(t){var e=this.$$("add");t?e.hide():e.show(),this.Cals.refresh()},e.prototype.SetTitle=function(t,e){var i=this;return this.Ops.updateCalendar(t,{text:e}).then((function(){return i.EditStopSilent()}),(function(){return i.EditStopSilent(!0)})),!1},e.prototype.EditStopSilent=function(t){this.Cals.blockEvent(),t?this.Cals.editCancel():this.Cals.editStop(),this.Cals.unblockEvent()},e}(l),X=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._,i={view:"list",css:"webix_scheduler_navlist",localId:"modes",autoheight:!0,data:[{id:"day",value:e("Day"),icon:"shi-day"},{id:"week",value:e("Week"),icon:"shi-week"},{id:"month",value:e("Month"),icon:"shi-month"},{id:"agenda",value:e("Agenda"),icon:"shi-agenda"}],on:{onItemClick:function(e){return t.SetMode(e)}}},n={view:"sidemenu",borderless:!0,css:"webix_scheduler_sidemenu",width:300,state:function(t){var e=webix.skin.$active.tabbarHeight+10;t.top=e+2,t.height-=e-2},body:i};return this.app.config.calendars&&(n.body={view:"scrollview",body:{type:"clean",rows:[i,q]}}),n},e.prototype.init=function(){this.State=this.app.getState()},e.prototype.Show=function(){var t=this.getRoot();t.isVisible()||(this.$$("modes").select(this.State.mode),t.show())},e.prototype.SetMode=function(t){var e=this;this.getRoot().hide(),setTimeout((function(){return e.State.$batch({mode:t,selected:null})}),500)},e}(l),K=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._;this.Compact=this.getParam("compact",!0);var i={view:"icon",icon:"wxi-calendar",batch:"compact",tooltip:e("Today"),click:function(){return t.SetToday()}},n={view:"align",align:"middle",batch:"full",body:{width:80,view:"button",css:"webix_transparent",value:e("Today"),click:function(){return t.SetToday()}}};return{view:"toolbar",css:"webix_scheduler_toolbar webix_dark",responsive:!0,paddingY:0,paddingX:4,height:webix.skin.$active.tabbarHeight+10,visibleBatch:this.Compact?"compact":"full",cols:[{view:"icon",icon:"shi-menu",click:function(){return t.ShowNav()},hidden:!this.Compact&&!this.app.config.calendars,responsiveCell:!1},{view:"proxy",localId:"add",borderless:!0,body:V,batch:"full",responsiveCell:!1},{},{view:"proxy",borderless:!0,body:j,responsiveCell:!1},{},n,W,i]}},e.prototype.init=function(){var t=this;this.State=this.app.getState(),this.Compact&&(this.NavPopup=this.ui(X)),this.on(this.State.$changes,"readonly",(function(e){t.ToggleAdd(e)}))},e.prototype.SetToday=function(){this.State.date=webix.Date.dayStart(new Date)},e.prototype.ShowNav=function(){this.Compact?this.NavPopup.Show():this.app.callEvent("show:panel")},e.prototype.ToggleAdd=function(t){var e=this.$$("add");t?e.hide():this.Compact||e.show()},e}(l),J=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._;return{view:"popup",body:{view:"menu",layout:"y",width:220,autoheight:!0,data:[{id:"this",value:e("This event")},{id:"next",value:e("This event and the following")},{id:"all",value:e("All events")}],on:{onMenuItemClick:function(e){t.Result&&t.Result.resolve(e),t.Result=null}}},on:{onHide:function(){t.Result&&t.Result.reject(),t.Result=null}}}},e.prototype.init=function(t){this.Root=t},e.prototype.Show=function(t,e){this.Result=e,this.Root.show(t)},e}(l),Z=webix.Date.dateToStr("%Y%m%dT000000Z");function tt(t){return new Date(1*t.substr(0,4),1*t.substr(4,2)-1,1*t.substr(6,2))}function et(t){var e=[];for(var i in t){var n=t[i];"UNTIL"===i&&(n=Z(n)),"EXDATE"===i&&(n=(n=n.map((function(t){return Z(t)}))).join(",")),n&&e.push(i+"="+n)}return e.join(";")}var it=["SU","MO","TU","WE","TH","FR","SA"],nt={DAILY:"day",WEEKLY:"week",MONTHLY:"month",YEARLY:"year"};function rt(t,e){if(!t)return!1;for(var i=0;i<t.length;++i)if(webix.Date.equal(webix.Date.dayStart(e),t[i]))return!0;return!1}function at(t,e){if(t.BYDAY)for(var i=e.wdays=[0,0,0,0,0,0,0],n=t.BYDAY.split(",").map((function(t){return it.indexOf(t)})).sort(),r=0;r<n.length;r++)for(var a=n[r],o=n[r+1]||n[0]+7,s=a;s<o;s++)i[s%7]=o-s}function ot(t,e,i){var n,r,a=1*(e.INTERVAL||1);switch("YEARLY"==e.FREQ&&(a*=12),e.FREQ){case"DAILY":t.setDate(t.getDate()+a);break;case"WEEKLY":n=t.getDay(),(r=i.wdays?i.wdays[n]:7)+n>6&&a>1&&(r+=7*(a-1)),t.setDate(t.getDate()+r);break;case"YEARLY":case"MONTHLY":if(n=t.getMonth(),t.setDate(1),t.setMonth(n+a),e.BYMONTHDAY)t.setDate(e.BYMONTHDAY),(n+a)%12!=t.getMonth()&&t.setDate(0);else if(e.BYSETPOS){t.setDate(0);for(var o=0;o<e.BYSETPOS;o++)r=i.wdays[t.getDay()],t.setDate(t.getDate()+r)}}return t}function st(t,e){var i=new Date(t),n=e.BYDAY.split(","),r=it[i.getDay()];return{result:n.includes(r),start:i,days:n,oldDay:r}}function ut(t,e){var i=st(t,e),n=i.result,r=i.days,a=i.oldDay;return n?e.BYDAY:("WEEKLY"===e.FREQ?r.splice(it.indexOf(r[0]),0,a):r=[a],r.join(","))}function ct(t){return{id:t.$id||t.id,date:t.$recurring?t.id:null}}function ht(t){return webix.Date.dayStart(t.getDate?t:new Date(1*t.split("_")[0]))}function lt(t,e,i){var n=ht(t);return(!i||!e.$recurring.UNTIL||e.$recurring.UNTIL>n)&&(e.$recurring.UNTIL=n),e.$recurring.COUNT&&delete e.$recurring.COUNT,e.$recurring.EXDATE&&(e.$recurring.EXDATE=e.$recurring.EXDATE.filter((function(t){return t<n}))),et(e.$recurring)}function dt(t,e){var i=ht(t);return e.$recurring.EXDATE||(e.$recurring.EXDATE=[]),e.$recurring.EXDATE.push(i),et(e.$recurring)}function pt(t,e){var i="string"==typeof e?new Date(1*e.split("_")[0]):new Date(e),n=(t.end_date-t.start_date)/1e3/60;return{start_date:i,end_date:webix.Date.add(i,n,"minute",!0)}}function ft(t,e){return!!t&&(t.getDate?t:new Date(1*t.split("_")[0]))<=e}function vt(t,e){return t.origin_id&&t.recurring?this.app.getService("local").isLastPart(t)&&(e=""):e="all",e}function gt(t,e,i){var n=webix.Date.dayStart(e.start_date)-webix.Date.dayStart(i.start_date);if(n&&(n/=864e5),t.UNTIL&&n&&(t.UNTIL=webix.Date.add(t.UNTIL,n,"day",!0)),t.BYDAY&&n&&((n%=7)<0&&(n+=7),t.BYDAY=t.BYDAY.split(",").map((function(t){return it[(it.indexOf(t)+n)%7]})).join(",")),t.BYMONTHDAY&&n){var r=e.start_date.getDate();r!=t.BYMONTHDAY&&(t.BYMONTHDAY=r)}if(t.BYSETPOS){var a=function(t){var e=t.getDate();return Math.floor(e/7)+(e%7?1:0)}(e.start_date);t.BYSETPOS!=a&&(t.BYSETPOS=a)}if(t.BYMONTH){var o=e.start_date.getMonth()+1;o!=t.BYMONTH&&(t.BYMONTH=o)}return t}var yt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._,i=this.getParam("compact",!0),n=webix.skin.$active,r={view:"form",localId:"recurringForm",hidden:!0,elementsConfig:{labelPosition:"left"},padding:{top:n.layoutPadding.form,bottom:0,left:i?n.layoutPadding.form:0,right:i?14:0},borderless:!0,rows:[this.CreateIntervalControls(e),{localId:"customRecControls",hidden:!0,rows:[this.CreateCheckboxes(e),this.CreateSelect()]},this.CreateRadio(e)]};return i||(r.on={onChange:function(){return t.UpdateEvent()}}),r},e.prototype.init=function(){this.State=this.app.getState(),this.Form=this.$$("recurringForm"),this.Events=this.app.getService("local").events(!0),this.CheckBoxContainer=this.$$("weekly"),this.Checkboxes=this.CheckBoxContainer.getChildViews().slice(1),this.Checkboxes.pop(),this.PatternSelect=this.$$("patternSelect"),this.UntilDateContainer=this.$$("untilDate"),this.UntilDateCalendar=this.Form.elements.untilDate.getPopup().getBody(),this.UntilNumContainer=this.$$("untilCount"),this.UntilNum=this.UntilNumContainer.getBody(),this.CustomRecControls=this.$$("customRecControls")},e.prototype.CreateIntervalControls=function(t){var e=this;return{margin:8,cols:[{view:"counter",label:t("Every"),labelWidth:50,min:1,name:"INTERVAL",css:"webix_scheduler_counter"},{view:"richselect",name:"FREQ",options:[{id:"DAILY",value:t("day")},{id:"WEEKLY",value:t("week")},{id:"MONTHLY",value:t("month")},{id:"YEARLY",value:t("year")}],on:{onChange:function(t){return e.ChangeControls(t)}}}]}},e.prototype.ChangeControls=function(t){this._freq=t,"DAILY"===t?this.CustomRecControls.hide():(this.CustomRecControls.show(),"WEEKLY"===t?(this.CheckBoxContainer.show(),this.PatternSelect.hide()):(this.CheckBoxContainer.hide(),this.PatternSelect.show(),this.PatternSelect.refresh()))},e.prototype.CreateCheckboxes=function(t){for(var e=[],i=0;i<7;++i)e.push({view:"checkbox",label:webix.i18n.calendar.dayShort[i],labelPosition:"top",labelAlign:"center",css:"webix_scheduler_day_checkbox",inputWidth:26,width:45,align:"center",name:it[i],on:{onChange:function(t,e){webix.isUndefined(e)||t||this.$scope.GetBYDAY()||this.$scope.SetSilently(this,1)}}});return{localId:"weekly",cols:r([{view:"label",label:t("on"),width:45}],e,[{gravity:1e-5}])}},e.prototype.SetBYDAY=function(t){var e=t.BYDAY.split(",");this.Checkboxes.forEach((function(i){t[i.config.name]=!!e.find((function(t){return t==i.config.name}))}))},e.prototype.GetBYDAY=function(){var t=[];return this.Checkboxes.forEach((function(e){e.getValue()&&t.push(e.config.name)})),t.join(",")},e.prototype.CreateSelect=function(){var t=this,e=this.app.getService("locale")._;return{view:"richselect",localId:"patternSelect",name:"rec_pattern",suggest:{data:[],body:{template:function(i){var n=[];return i.BYDAY&&i.BYDAY.forEach((function(t){return n.push(webix.i18n.calendar.dayFull[t])})),e("Every")+" "+(i.BYMONTHDAY||i.BYSETPOS)+" "+(i.BYDAY?n.join(", "):"")+" "+("YEARLY"===t._freq?webix.i18n.calendar.monthFull[i.BYMONTH-1]:"")}}}}},e.prototype.SetPatternOptions=function(t,e){var i;i=t.BYDAY?t.BYDAY.split(",").map((function(t){return it.indexOf(t)})):[e.weekday],this.PatternSelect.getList().parse([{id:1,BYMONTH:t.BYMONTH||e.month+1,BYMONTHDAY:t.BYMONTHDAY||e.day},{id:2,BYSETPOS:t.BYSETPOS||e.weekNum,BYDAY:i,BYMONTH:t.BYMONTH||e.month+1}]),this._freq=t.FREQ,t.rec_pattern=t.BYSETPOS?2:1},e.prototype.GetRecPattern=function(t){var e=webix.copy(this.PatternSelect.getList().getItem(t.rec_pattern));return"MONTHLY"===this._freq&&delete e.BYMONTH,e.BYDAY&&(e.BYDAY=e.BYDAY.map((function(t){return it[t]}))),delete e.id,e},e.prototype.CreateRadio=function(t){var e=this;return{rows:[{view:"label",label:t("End repeat")},{cols:[{view:"radio",name:"until",localId:"until",vertical:!0,gravity:1.5,options:[{id:1,value:t("never")},{id:2,value:t("date")},{id:3,value:t("after several occurrences")}],on:{onChange:function(t){return e.ChangeSelectors(t)}}},{rows:[{localId:"untilDate",align:"middle",view:"align",body:{view:"datepicker",name:"untilDate",icons:!1}},{localId:"untilCount",view:"align",align:"bottom",body:{name:"untilCount",view:"counter",css:"webix_scheduler_counter",min:1}}]}]}]}},e.prototype.ChangeSelectors=function(t){this.UntilDateContainer["2"===t?"show":"hide"](),this.UntilNumContainer["3"===t?"show":"hide"]()},e.prototype.SetUNTIL=function(t,e){e.until=e.COUNT?3:e.UNTIL?2:1,e.untilDate=e.UNTIL||webix.Date.add(t,1,"year",!0),e.untilCount=e.COUNT||this.CountNum(t,e),this.UntilDateCalendar.define({minDate:t})},e.prototype.CountNum=function(t,e){var i=0;if(e.UNTIL){var n={};at(e,n);for(var r=webix.Date.copy(t);r<=e.UNTIL;)r=ot(r,e,n),i++}else i=3;return i},e.prototype.SetValues=function(t,e,i){this._StartDate=t.start_date;var n=t.$recurring;n||(n={FREQ:"DAILY"}),n.INTERVAL||(n.INTERVAL=1),n.BYDAY||(n.BYDAY=it[e.weekday]),n.EXDATE||(n.EXDATE=[]),this.SetUNTIL(t.start_date,n),this.SetBYDAY(n),this.SetPatternOptions(n,e),this.Form.setValues(n,!0),i&&this.Form.setDirty()},e.prototype.GetValues=function(){var t=this.Form.getValues(),e={FREQ:t.FREQ,INTERVAL:t.INTERVAL,UNTIL:2==t.until?t.untilDate:null,COUNT:3==t.until?t.untilCount:null,EXDATE:t.EXDATE||[]};return"WEEKLY"===t.FREQ?e.BYDAY=this.GetBYDAY(t):"MONTHLY"!==t.FREQ&&"YEARLY"!==t.FREQ||(e=webix.extend(e,this.GetRecPattern(t))),this.Form.setDirty(),e},e.prototype.UpdateEvent=function(){if(this.IsDirty()){var t=this.GetValues();this.app.callEvent("form:update:recurring",[{$recurring:t}]),this.Form.setDirty()}},e.prototype.IsDirty=function(){return this.Form.isDirty()},e.prototype.Show=function(){this.getRoot().show()},e.prototype.Hide=function(){this.getRoot().hide()},e.prototype.SetSilently=function(t,e){t.blockEvent(),t.setValue(e),t.unblockEvent()},e.prototype.UpdateSilently=function(t){this.Form.blockEvent(),this.Form.setValues(t,!0),this.Form.unblockEvent()},e}(l);function mt(t,e,i,n){return t&&"next"===t&&ft(n,i)&&(t=vt.call(this,e,t)),t}function wt(t,e,i,n){for(var r=t.origin_id||t.$id||t.id,a=n.find((function(t){return r==t.origin_id&&i<t.start_date})).sort((function(t,e){return t.start_date>e.start_date?-1:t.start_date<e.start_date?1:0})),o=webix.copy(t.$recurring),s=0,u=void 0;s<a.length;++s)if((u=a[s]).$recurring){if(!u.$recurring.COUNT){o.UNTIL=u.$recurring.UNTIL;break}if(!o.COUNT||t.$id==u.id){o.UNTIL=bt(u);break}o.COUNT=1*o.COUNT+1*u.$recurring.COUNT}return"next"!==e||a.length||(o.COUNT?o.COUNT=function(t,e){var i=ht(e),n={};at(t.$recurring,n);var r=webix.Date.dayStart(t.start_date),a=0;for(;r<i;)a++,r=ot(r,t.$recurring,n);return t.$recurring.COUNT-a}(t,i):o.UNTIL&&t.start_date>=o.UNTIL&&(o.UNTIL=webix.Date.add(webix.Date.dayStart(t.start_date),1,nt[o.FREQ],!0))),o}function _t(t){if(!t.recurring)return!0;if(!t.$recurring.UNTIL)return!1;var e=webix.Date.dayStart(webix.Date.add(t.end_date,1,"day",!0));return webix.Date.equal(e,t.$recurring.UNTIL)}function bt(t){var e=t.$recurring,i=1*e.COUNT;return"WEEKLY"===e.FREQ&&(i=Math.floor(e.BYDAY.split(",").length/7*e.COUNT)),webix.Date.add(t.start_date,i,nt[e.FREQ],!0)}function xt(t){t.ChangeMode=mt,t.CorrectCountUntil=wt,t.HasOneOccurrence=_t}var St=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._;this.Compact=this.getParam("compact",!0);var i=webix.skin.$active,n={view:"toolbar",borderless:!0,padding:{left:i.layoutPadding.form-(i.inputHeight-20)/2,right:14},elements:[{view:"icon",icon:"wxi-close",tooltip:e("Close"),hotkey:"esc",click:function(){return t.Close()}},{view:"label",label:e("Edit event")},{view:"button",width:130,css:"webix_primary",value:e("Done"),hotkey:"Ctrl+Enter",click:function(){return t.Done()}}]},r={view:"form",localId:"form",scroll:!0,borderless:!0,padding:{right:14},elementsConfig:{labelPosition:"top"},elements:[{view:"text",label:e("Event"),name:"text"},{margin:8,rows:[this.GetDateTime("start",e,i),this.GetDateTime("end",e,i)]},{view:"checkbox",name:"all_day",labelPosition:"left",labelWidth:0,labelRight:e("labelAllday"),on:{onChange:function(e){return t.ToggleTimeControls(e)}}},this.CreateCalendarColor(e),{view:"textarea",label:e("Notes"),name:"details",height:150},{}],on:{}};return this.app.config.recurring&&r.elements.splice(3,0,this.CreateRepeat(e,i)),this.Compact||(r.on.onChange=function(e,i){t.Wait((function(){return t.UpdateEvent(t.Form.getDirtyValues(),i)}))}),{view:"proxy",body:{margin:0,rows:[n,r]}}},e.prototype.init=function(){var t=this;this.State=this.app.getState(),this.Form=this.$$("form"),this.Local=this.app.getService("local").events(!0),this.Ops=this.app.getService("operations"),xt(this),this.RecurringOptions=this.$$("recOption"),this.StartTime=this.$$("startTime"),this.EndTime=this.$$("endTime"),this.on(this.State.$changes,"readonly",(function(e,i){webix.isUndefined(i)||t.Close()})),this.on(this.app,"form:update:recurring",(function(e){t.UpdateEvent(e)})),this.app.config.calendars&&(this.Calendars=this.app.getService("local").calendars(!0),this.$$("calendar").getList().parse(this.Calendars))},e.prototype.ready=function(){var t=this;this.SubForm=this.getSubView("recurringForm"),this.on(this.State.$changes,"selected",(function(e){e&&(t.ClearTempEvent(),t.Wait((function(){return t.FillForm(e)})))}))},e.prototype.destroy=function(){this.ClearTempEvent()},e.prototype.CreateRepeat=function(t,e){var i=this,n=[{view:"label",label:t("Repeat"),height:e.labelTopHeight},{margin:4,cols:[{view:"richselect",localId:"recOption",name:"rec_option",suggest:{data:[{id:"none",value:t("never")},{id:"daily",value:t("daily")},{id:"weekly"},{id:"monthly"},{id:"yearly"},{id:"work",value:t("every working day")},{id:"custom",value:t("custom")}]},on:{onChange:function(t,e){return i.ToggleSubform(t,e)}}}]}];return this.Compact&&n[1].cols.push({localId:"editCustomRec",view:"icon",icon:"wxi-pencil",tooltip:t("Change recurring pattern"),hidden:!0,click:function(){return i.ShowSubForm()}}),n.push({$subview:yt,name:"recurringForm"}),{localId:"repeatControls",rows:n}},e.prototype.ToggleTimeControls=function(t){1==t?(this.StartTime.hide(),this.EndTime.hide()):(this.StartTime.show(),this.EndTime.show())},e.prototype.ToggleSubform=function(t,e){"custom"===t?this.Compact?(this.$$("editCustomRec").show(),e&&this.ShowSubForm()):this.SubForm.Show():(this.SubForm.Hide(),this.Compact&&this.$$("editCustomRec").hide())},e.prototype.CreateCalendarColor=function(t){var e={margin:8,cols:[{view:"colorpicker",label:t("Color"),name:"color",value:"#1abc9c",suggest:{type:"colorboard",padding:3,body:G()}}]};return this.app.config.calendars&&e.cols.unshift({view:"richselect",localId:"calendar",label:t("Calendar"),name:"calendar",css:"webix_scheduler_cal_color",options:{css:"webix_scheduler_cal_color_suggest",data:[],body:{tooltip:function(){return""},template:function(e){var i=1*e.active,n=i?"":"class='webix_scheduler_cal_disabled'";return'<div style="overflow: hidden;" '+(i?"":'webix_tooltip="'+t("Inactive calendar")+'"')+" "+n+">"+(e.text||t("(no title)"))+'\n\t\t\t\t\t\t\t\t<span class="webix_scheduler_cal_marker" style="background-color:'+e.color+';">\n\t\t\t\t\t\t\t</span></div>'}}}}),e},e.prototype.GetDateTime=function(t,e,i){return{rows:[{view:"label",height:i.labelTopHeight,label:e("start"===t?"Start":"End")},{margin:8,cols:[{view:"datepicker",name:t+"_date",suggest:{type:"calendar",icons:!1}},{view:"datepicker",localId:t+"Time",name:t+"_time",type:"time",format:"%H:%i"}]}]}},e.prototype.FillForm=function(t){var e,i=this;if(this.Form.focus(),this.Id=t.id,this.Form.focus(),this.Date=t.date,"string"==typeof this.Date&&(this.Date=new Date(1*this.Date.slice(0,this.Date.indexOf("_")))),"0"==t.id){if((e=this.NewEvent()).then)return e.then((function(e){i.Local.add(n({id:t.id},webix.copy(e))),i.FillFormContinue(e)}));this.Local.add(n({id:t.id},webix.copy(e)))}else{e=webix.copy(this.Local.getItem(t.id));var r=this.getParam("mode",!0);r&&(e=this.AdaptObjToMode(r,e))}this.FillFormContinue(e)},e.prototype.AdaptObjToMode=function(t,e){return t=this.ChangeMode(t,e,e.recurring?e.start_date:this.Local.getItem(e.origin_id).start_date,e.recurring?this.State.selected.date:e.start_date),this.setParam("mode",t,!0),"all"!==t&&"next"!==t||("all"===t&&e.origin_id&&(e=webix.copy(this.Local.getItem(e.origin_id))),e.$recurring||(e.$recurring=webix.copy(this.Local.getItem(e.origin_id).$recurring)),(e.$recurring.COUNT||e.$recurring.UNTIL)&&(e.$recurring=this.CorrectCountUntil(e,t,e.start_date,this.Local))),"this"!==t&&"next"!==t||(this.State.selected.date&&(e=n(n({},e),pt(e,this.State.selected.date))),"this"===t&&(e.$recurring=null,e.recurring="",this.$$("repeatControls").hide())),e},e.prototype.FillFormContinue=function(t){t.start_time=webix.Date.copy(t.start_date),t.end_time=webix.Date.copy(t.end_date),t.start_date=webix.Date.datePart(t.start_date),t.end_date=webix.Date.datePart(t.end_date),this.app.config.recurring&&this.SetRecurring(t),this.Form.setValues(t)},e.prototype.GetFromStartDate=function(t){var e={weekday:t.getDay(),day:t.getDate(),month:t.getMonth()};return e.weekNum=Math.floor(e.day/7)+(e.day%7?1:0),e},e.prototype.SetRecurring=function(t){var e=this.GetFromStartDate(t.start_date),i=this.ResetRecurringOptions(e);this.RecurringOptions.getList().parse(i),this.SubForm.SetValues(webix.copy(t),e,!0);var n=this.app.getService("locale")._;t.$recurring?"MO,TU,WE,TH,FR"===t.$recurring.BYDAY?t.rec_option="work":t.$recurring.UNTIL||t.$recurring.COUNT||t.$recurring.INTERVAL&&1!=t.$recurring.INTERVAL||!("DAILY"===t.$recurring.FREQ||"WEEKLY"===t.$recurring.FREQ&&t.$recurring.BYDAY==it[e.weekday]||"MONTHLY"===t.$recurring.FREQ&&t.$recurring.BYSETPOS&&t.$recurring.BYSETPOS==e.weekNum&&t.$recurring.BYDAY==it[e.weekday]||"YEARLY"===t.$recurring.FREQ&&t.$recurring.BYMONTH==e.month+1&&t.$recurring.BYMONTHDAY==e.day)?t.rec_option=n("custom"):t.rec_option=n(t.$recurring.FREQ.toLowerCase()):t.rec_option=n("none")},e.prototype.ResetRecurringOptions=function(t){var e=this.app.getService("locale")._;return[{id:"weekly",value:e("weekly, every")+" "+webix.i18n.calendar.dayFull[t.weekday]},{id:"monthly",value:e("monthly, every")+" "+t.weekNum+" "+e("week on")+" "+webix.i18n.calendar.dayFull[t.weekday]},{id:"yearly",value:e("yearly, every")+" "+webix.i18n.calendar.monthFull[t.month]+" "+t.day}]},e.prototype.Join=function(t,e){return webix.Date.add(t,webix.Date.timePart(e)/60,"minute",!0)},e.prototype.NewEvent=function(){var t=this,e=this.GetStartDate(),i={start_date:e,end_date:webix.Date.add(e,1,"hour",!0),text:""};if(this.app.config.recurring&&(i.recurring=""),this.app.config.calendars){var n=this.State.active[0];if(!n){var r=this.Calendars.getFirstId();return(r?this.Ops.updateCalendar(r,{active:1}):this.Ops.addCalendar()).then((function(){return i.calendar=t.State.active[0],i.$color=t.Calendars.getItem(i.calendar).color,i}))}i.calendar=n,i.$color=this.Calendars.getItem(i.calendar).color}else i.$color="#01C2A5";return i},e.prototype.GetStartDate=function(){if(this.Date)return webix.Date.copy(this.Date);var t=new Date,e=30*Math.ceil(t.getMinutes()/30),i=webix.Date.copy(this.State.date);return i.setHours(t.getHours(),e),i},e.prototype.UpdateEvent=function(t,e){var i=this;Object.keys(t).length&&this.PrepareChange(t,this.Form.getValues(),e),this.Form.setDirty();var n=this.Id;if("0"===n)this._inProgress=this.Ops.addEvent(this.PrepareOut(t),n);else if(Object.keys(t).length){var r=this.getParam("mode",!0),a=this.Local.getItem(n);if("this"===r&&!this.HasOneOccurrence(a)||"next"===r){t.origin_id=a.origin_id||a.id;var o=this.PrepareOut(t),s="";if("this"===r)s=dt(this.State.selected.date,a);else{var u=void 0;a.recurring?u=[this.State.selected.date,a]:(n=a.origin_id,u=[o.start_date,this.Local.getItem(n)]),s=lt.apply(void 0,u)}this._inProgress=this.Ops.updateEvent(n,{recurring:s},"next"===r?"next":"common",webix.Date.dayStart(o.start_date)).then((function(){return"none"===t.rec_option&&(i.State.selected.date=null),i.Ops.addEvent(o)}))}else{if("all"===r){var c=this.Form.getValues().$recurring;c&&webix.isUndefined(t.recurring)&&(delete c.EXDATE,t.recurring=et(c),this.SetFormSilently({$recurring:c,recurring:t.recurring}),this.SubForm.UpdateSilently({EXDATE:null})),a.origin_id&&(this.Id=this.State.selected.id=a.origin_id)}this._inProgress=this.Ops.updateEvent(this.Id,t,"all"===r?"unite":"common").then((function(){"none"===t.rec_option&&(i.State.selected.date=null)}))}}return this._inProgress&&(this.app.callEvent("backend:operation",[this._inProgress]),this._inProgress.then((function(n){n&&(i.State.selected.id=i.Id=n),n&&!t.recurring||i.ChangeDate(t,i.Form.getValues(),e),i.setParam("mode","",!0)})).finally((function(){i._inProgress=null}))),this._inProgress||webix.promise.resolve()},e.prototype.PrepareChange=function(t,e,i){var r;if(t.rec_option&&("custom"===t.rec_option?(e.$recurring&&this.SubForm.SetValues(n(n({},e),t),this.GetFromStartDate(e.start_date)),t.$recurring=this.SubForm.GetValues(),e.$recurring||this.SetFormSilently({$recurring:t.$recurring})):this.GetRecurring(t.rec_option,t,e),delete t.rec_option),!webix.isUndefined(t.$recurring)){if(t.$recurring){var a=et(t.$recurring),o=this.Local.getItem(e.id);if(!o||a!==o.recurring){t.recurring=a;var s=function(t,e,i){if("WEEKLY"===i.FREQ){var n=st(t,i),r=n.result,a=n.start,o=n.days;if(r)return[null,null];var s=it.indexOf(o[0])-a.getDay();a.setDate(a.getDate()+s);var u=new Date(e);return u.setDate(u.getDate()+s),[a,u]}return[null,null]}(e.start_date,e.end_date,t.$recurring),u=s[0],c=s[1];u&&c&&(r=[u,c],t.start_date=r[0],t.end_date=r[1]),this.SetFormSilently(t)}}delete t.$recurring}t.start_date||t.end_date||t.start_time||t.end_time?this.SumupDateTime(t,e):1==t.all_day?(t.start_date=e.start_date,t.end_date=e.end_date):0==t.all_day&&(t.start_date=this.Join(e.start_date,e.start_time),t.end_date=this.Join(e.end_date,e.end_time)),(t.start_date||t.end_date)&&(this.CorrectDateTime(t,e),t.start_time&&delete t.start_time,t.end_time&&delete t.end_time,this.ApplyDatechangeToRecurring(t,e)),this.ProcessText(t,"text",i),this.ProcessText(t,"details",i)},e.prototype.ProcessText=function(t,e,i){t[e]&&(t[e]=webix.template.escape(t[e].trim()),i||(i=this.Local.getItem(this.State.selected.id)[e]),t[e]===i.trim()&&delete t[e])},e.prototype.ApplyDatechangeToRecurring=function(t,e){if(this.app.config.recurring&&t.start_date){var i=this.GetFromStartDate(t.start_date);if(!t.recurring)if("custom"===e.rec_option){var r=e.$recurring;if(r.BYMONTH&&(r.BYMONTH=i.month+1),r.BYMONTHDAY&&(r.BYMONTHDAY=i.day),r.BYSETPOS&&(r.BYSETPOS=i.weekNum),r.BYDAY&&(r.BYDAY=ut(t.start_date,e.$recurring)),r.UNTIL&&r.UNTIL<t.start_date){var a=this.Local.getItem(this.State.selected.id).start_date,o=(e.$recurring.UNTIL-a)/1e3/60;r.UNTIL=webix.Date.add(t.start_date,o,"minute",!0)}t.recurring=et(r),this.SubForm.SetValues(n(n({},e),t),i)}else this.GetRecurring(e.rec_option,t,e),delete t.$recurring;this.RecurringOptions.getList().parse(this.ResetRecurringOptions(i)),this.RecurringOptions.refresh()}},e.prototype.ChangeDate=function(t,e,i){if(t.start_date&&!e.$recurring||""===t.recurring)this.UpdateStateDate(webix.Date.datePart(t.start_date||e.start_date,!0));else if(t.start_date||t.recurring){if(t.recurring&&(("WEEKLY"===e.$recurring.FREQ||"DAILY"===e.$recurring.FREQ)&&(!e.$recurring.INTERVAL||1==e.$recurring.INTERVAL)||this.Date&&webix.Date.equal(this.Date,this.Join(e.start_date,e.start_time)))){var n=(this.Date||e.start_date).getDay();if(!e.$recurring.BYDAY||e.$recurring.BYDAY.split(",").includes(it[n]))return void("none"===i&&(this.State.selected.date=this.Join(e.start_date,e.start_time).valueOf()+"_"+this.State.selected.id))}var r={};at(e.$recurring,r);for(var a=webix.Date.copy(t.start_date||this.Join(e.start_date,e.start_time)),o=this.GetModeBounds().end;a>=o;)o=webix.Date.add(o,1,this.State.mode,!0);var s=void 0,u=new Date(1*this.State.selected.date.split("_")[0]);for(e.$recurring.UNTIL&&e.$recurring.UNTIL<o&&(o=e.$recurring.UNTIL);a<o&&(s=webix.Date.copy(a),!webix.Date.equal(s,u));)a=ot(a,e.$recurring,r);this.State.selected.date=s.valueOf()+"_"+this.State.selected.id,this.UpdateStateDate(s)}},e.prototype.UpdateStateDate=function(t){var e=this.State;if("day"===e.mode){var i=webix.Date.datePart(e.date,!0);webix.Date.equal(t,i)||(e.date=webix.Date.dayStart(t))}else if("week"===e.mode||"month"===e.mode){var n=this.GetModeBounds(),r=n.start,a=n.end;(t<r||t>=a)&&(e.date=webix.Date.dayStart(t))}},e.prototype.GetModeBounds=function(){var t=this.State,e=webix.Date[t.mode+"Start"](t.date);return{start:e,end:webix.Date.add(e,1,t.mode,!0)}},e.prototype.GetRecurring=function(t,e,i){var n=it[i.start_date.getDay()],r=i.start_date.getDate(),a=null;switch(t){case"daily":a={FREQ:"DAILY",INTERVAL:1};break;case"weekly":a={FREQ:"WEEKLY",INTERVAL:1,BYDAY:n};break;case"work":a={FREQ:"WEEKLY",INTERVAL:1,BYDAY:"MO,TU,WE,TH,FR"};break;case"monthly":a={FREQ:"MONTHLY",INTERVAL:1,BYSETPOS:Math.floor(r/7)+(r%7?1:0),BYDAY:n};break;case"yearly":a={FREQ:"YEARLY",INTERVAL:1,BYMONTH:i.start_date.getMonth()+1,BYMONTHDAY:r}}if("work"===t&&e.start_date){var o=ut(e.start_date,a);a.BYDAY!==o&&(a.BYDAY=o,t="custom")}var s=a?et(a):"",u=this.Local.getItem(i.id);u&&s===u.recurring||(e.$recurring=a,e.recurring=s,this.SetFormSilently({$recurring:e.$recurring,recurring:s,rec_option:t}))},e.prototype.PrepareOut=function(t){var e=this.Form.getValues();return e.all_day||(e.start_date=this.Join(e.start_date,e.start_time),e.end_date=this.Join(e.end_date,e.end_time)),e=webix.extend(e,t||{},!0),t&&t.recurring||!e.$recurring||(e.$recurring.EXDATE=[],e.recurring=et(e.$recurring)),{origin_id:e.origin_id||0,text:webix.template.escape(e.text),start_date:e.start_date,end_date:e.end_date,all_day:e.all_day,calendar:e.calendar,color:e.color,details:webix.template.escape(e.details),recurring:e.recurring}},e.prototype.SumupDateTime=function(t,e){var i=t.start_date||t.start_time?"start":"end",n=i+"_date",r=i+"_time";t[n]=this.Join(t[n]||e[n],t[r]||e[r])},e.prototype.CorrectDateTime=function(t,e){var i=this.Local.getItem(this.State.selected.id),n=(i.end_date-i.start_date)/1e3/60,r=t.start_date?"start":"end",a="start"===r?"end":"start";(t.start_date>=i.end_date&&!e.all_day||t.start_date>i.end_date||i.start_date>=t.end_date&&!e.all_day||i.start_date>t.end_date)&&(t[a+"_date"]=webix.Date.add(t[r+"_date"],("start"===r?1:-1)*(n||60),"minute",!0),this.SetFormSilently({start_date:webix.Date.datePart(t.start_date,!0),end_date:webix.Date.datePart(t.end_date,!0),start_time:t.start_time||webix.Date.copy(t.start_date),end_time:t.end_time||webix.Date.copy(t.end_date)}))},e.prototype.SetFormSilently=function(t){this.Form.blockEvent(),this.Form.setValues(t,!0),this.Form.unblockEvent()},e.prototype.ClearTempEvent=function(){var t=this.Id;"0"===t&&this.Local.exists(t)&&this.Local.remove(t)},e.prototype.Back=function(t){if(this.Form.clear(),t||"0"===this.State.selected.id)this.State.selected=null;else{var e=this.Compact?"event.formpopup/":"../";this.show(e+"event.info",{target:"edit"})}},e.prototype.Close=function(){var t=this;if(this._inProgress)this._inProgress.then((function(){t.Back(!0)}));else{var e=this.Form.isDirty()||this.Subform&&this.SubForm.IsDirty();if(this.Compact&&e){var i=this.app.getService("locale")._;webix.confirm({text:i("Save changes?")}).then((function(){return t.Done(!0)})).catch((function(){return t.Back(!0)}))}else this.Back(!0)}},e.prototype.Done=function(t){var e=this;if(this._inProgress)this._inProgress.then((function(){e.Back()}));else if("0"===this.State.selected.id||this.Compact){var i={};this.Compact&&(i=this.Form.getDirtyValues(),this.SubForm.IsDirty()&&(i.$recurring=this.SubForm.GetValues(),delete i.rec_option)),this.UpdateEvent(i).then((function(){return e.Back(t)}))}else this.Back()},e.prototype.Wait=function(t){this._inProgress?this._inProgress.then(t):t.call()},e.prototype.ShowSubForm=function(){var t=this;this.SubForm.Show();var e=this.app.getService("locale")._,i=this.SubForm.getRoot(),n=webix.skin.$active;webix.fullscreen.set(i,{head:{view:"toolbar",padding:{left:n.layoutPadding.form-(n.inputHeight-20)/2,right:14},elements:[{view:"icon",icon:"shi-back",click:function(){return t.HideSubPop()}},{view:"label",label:e("Change recurring pattern")},{view:"button",value:e("Done"),width:130,css:"webix_primary",click:function(){return t.HideSubPop()}}]}}),i.getTopParentView().define({css:"webix_scheduler_subform_popup"})},e.prototype.HideSubPop=function(){this.SubForm.Hide(),webix.fullscreen.exit()},e}(l),Dt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){return{view:"window",fullscreen:!0,head:!1,body:{$subview:!0}}},e}(l),Et=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._,i=webix.skin.$active;return{view:"proxy",body:{margin:0,rows:[{view:"toolbar",borderless:!0,padding:{left:i.layoutPadding.form-(i.inputHeight-20)/2,right:14},elements:[{view:"icon",icon:"wxi-close",hotkey:"esc",click:function(){return t.Back()}},{},{width:130,view:"button",localId:"edit",label:e("Edit"),css:"webix_primary",click:function(){this.$scope.StartAction("Edit",this.$view)}}]},{type:"form",padding:{right:16},borderless:!0,rows:[{localId:"text",view:"template",css:"webix_scheduler_info",template:function(e){return e.start_date?t.InfoTemplate(e):""},borderless:!0},{view:"button",localId:"remove",label:e("Delete event"),css:"webix_danger webix_scheduler_danger",align:"center",inputWidth:330,click:function(){this.$scope.StartAction("Delete",this.$view)}}]}]}}},e.prototype.init=function(){var t=this;this.State=this.app.getState(),this.on(this.State.$changes,"readonly",(function(e){var i=e?"hide":"show";t.$$("edit")[i](),t.$$("remove")[i]()})),this.on(this.State.$changes,"selected",(function(e){e&&(t.EventObj=t.app.getService("local").events(!0).getItem(e.id),t.$$("text").setValues(t.EventObj))})),this.Menu=this.ui(J)},e.prototype.StartAction=function(t,e){var i=this;this.app.config.recurring&&("string"==typeof this.State.selected.date||this.EventObj.origin_id)?(this._waitMenu=webix.promise.defer(),this._waitMenu.then((function(e){return"Delete"===t?i.DeleteEvent(e):i.EditEvent(e)})).finally((function(){return i._waitMenu=null})),this.Menu.Show(e,this._waitMenu)):"Delete"===t?this.DeleteEvent():this.EditEvent()},e.prototype.EditEvent=function(t){var e=this.getParam("compact",!0)?"event.formpopup/":"../";this.show(e+"event.form",{target:"edit",params:{mode:t}})},e.prototype.DeleteEvent=function(t){var e=this,i=this.app.getService("locale")._;webix.confirm({title:i("Delete event"),text:i("The event will be deleted permanently, are you sure?")}).then((function(){e.app.getService("operations").removeEvent(t,e.EventObj),e.Back()}))},e.prototype.Back=function(){this.State.selected=null},e.prototype.InfoTemplate=function(t){var e=this.app.getService("locale")._;this.app.config.recurring&&this.State.selected.date&&(t=n(n({},t),pt(t,this.State.selected.date)));var i=[t.start_date,t.end_date],r=i[0],a=i[1],o=webix.Date.equal(webix.Date.datePart(r,!0),webix.Date.datePart(a,!0)),s=webix.Date.equal(webix.Date.datePart(r,!0),r)&&webix.Date.equal(webix.Date.datePart(a,!0),a)&&t.all_day,u=webix.i18n.timeFormatStr,c=webix.i18n.longDateFormatStr,h='<div class="webix_scheduler_event_title">'+(t.text||e("(No title)"))+"</div>",l=c(r),d=c(a),p=""+u(r),f=""+u(a),v="";v=o?'<div class="webix_scheduler_event_text">'+l+'</div><div class="webix_scheduler_event_text">'+e("from")+" "+p+" "+e("to")+" "+f+"</div>":'<div class="webix_scheduler_event_text">'+e("from")+" "+(s?"":p)+" "+l+'</div><div class="webix_scheduler_event_text">'+e("to")+" "+(s?"":f)+" "+d+"</div>";var g="";if(t.recurring){var y=t.$recurring.INTERVAL&&t.$recurring.INTERVAL>1?t.$recurring.INTERVAL:"",m=(t.$recurring.BYDAY?" "+e("on")+" "+t.$recurring.BYDAY.split(",").map((function(t){return webix.i18n.calendar.dayFull[it.indexOf(t)]})).join(", "):"")+(t.$recurring.BYMONTHDAY?" "+e("on")+" ":"")+(t.$recurring.BYMONTH?" "+webix.i18n.calendar.monthFull[t.$recurring.BYMONTH-1]:"")+(t.$recurring.BYMONTHDAY?" "+t.$recurring.BYMONTHDAY:"");g=e("Repeats each")+" "+y+" "+e(nt[t.$recurring.FREQ]+(y?"s":""))+" "+m+(t.$recurring.COUNT?", "+t.$recurring.COUNT+" "+e("times"):t.$recurring.UNTIL?" "+e("till")+" "+c(t.$recurring.UNTIL):"")}var w="";return t.details&&(w='<div class="webix_scheduler_event_details_title">'+e("Notes")+'</div>\n\t\t\t\t<div class="webix_scheduler_event_text">'+t.details.replace(/(?:\r\n|\r|\n)/g,"<br>")+"</div>"),h+"\n\t\t\t<div class='webix_scheduler_event_from_to'>"+v+"</div>\n\t\t\t<div class='webix_scheduler_event_recurring_pattern'>"+g+"</div>"+w},e}(l),$t=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._,i={margin:webix.skin.$active.layoutMargin.form,cols:[{view:"button",value:e("Cancel"),hotkey:"esc",click:function(){return t.Cancel()}},{view:"button",value:e("Apply"),css:"webix_primary",hotkey:"enter",click:function(){return t.Done()}}]};return{view:"window",modal:!0,head:e("Edit recurring event"),position:"center",autoheight:!0,css:"webix_scheduler_action_popup",body:{type:"form",padding:{top:0},width:340,rows:[{view:"radio",localId:"option",vertical:!0,options:[{id:"this",value:e("This event")},{id:"next",value:e("This event and the following")},{id:"all",value:e("All events")}]},i]},on:{onHide:function(){return t.Result=null}}}},e.prototype.init=function(t){this.Root=t},e.prototype.Show=function(t){this.Result=t,this.$$("option").setValue("this"),this.Root.show()},e.prototype.Done=function(){var t=this.$$("option").getValue();this.Result&&this.Result.resolve(t),this.Root.hide()},e.prototype.Cancel=function(){this.Result&&this.Result.reject(),this.Root.hide()},e}(l);webix.protoUI({name:"r-layout",sizeTrigger:function(t,e,i){this._compactValue=i,this._compactWidth=t,this._compactHandler=e,this._checkTrigger(this.$view.width,i)},_checkTrigger:function(t,e){return!this._compactWidth||!(t<=this._compactWidth&&!e||t>this._compactWidth&&e)||(this._compactWidth=null,this._compactHandler(!e),!1)},$setSize:function(t,e){if(this._checkTrigger(t,this._compactValue))return webix.ui.layout.prototype.$setSize.call(this,t,e)}},webix.ui.layout);var Ct=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){this.fCompact=this.getParam("forceCompact"),webix.isUndefined(this.fCompact)||this.setParam("compact",this.fCompact),this.Compact=this.getParam("compact"),this.Calendars=!this.Compact&&this.app.config.calendars;var t=[K,{view:webix.isUndefined(this.fCompact)?"r-layout":"layout",localId:"main",cols:[{$subview:!0}]}];return this.Compact?t.push({$subview:!0,name:"edit",popup:!0}):t[1].cols.push({view:"proxy",width:400,localId:"edit",css:"webix_shadow_medium",borderless:!0,hidden:!0,body:{$subview:!0,name:"edit"}}),this.Calendars&&t[1].cols.unshift({view:"proxy",localId:"side",borderless:!0,body:q,hidden:!0}),{css:"webix_scheduler",view:"abslayout",cells:[{relative:!0,margin:0,rows:t},{view:"proxy",css:"webix_scheduler_absbutton",body:V,localId:"add",borderless:!0,right:20,bottom:20,hidden:!this.Compact}]}},e.prototype.init=function(t){var e=this;this.fCompact||this.$$("main").sizeTrigger(this.app.config.compactWidth,(function(t){return e.SetCompactMode(t)}),!!this.Compact),webix.extend(t,webix.ProgressBar),this.on(this.app,"backend:operation",(function(e){t.showProgress({type:"top",delay:2e3}),e.finally((function(){t.hideProgress()}))})),this.Calendars&&this.$$("side").show();var i=this.app.getState();this.on(i.$changes,"mode",(function(t){e.show("./modes."+t)})),this.on(i.$changes,"readonly",(function(t){e.ToggleAdd(t)})),this.on(i.$changes,"selected",(function(t,i){return e.ToggleEvent(t,i)})),this.on(this.app,"show:panel",(function(){return e.ToggleSidePanel()})),this.app._dndActionPopup=this.ui($t)},e.prototype.ToggleEvent=function(t,e){t?this.ShowEvent(t,e):e&&this.HideEvent()},e.prototype.ShowEvent=function(t,e){var i=e&&e.id==t.id,n=this.getSubView("edit"),r=n&&i?n.getUrl()[0].page:"event."+("0"===t.id?"form":"info");this.Compact?this.show("event.formpopup/"+r,{target:"edit"}):(this.ToggleSidePanel("hide"),this.$$("edit").show(),this.show(r,{target:"edit"}))},e.prototype.HideEvent=function(){this.show("_blank",{target:"edit"}),this.Compact||(this.$$("edit").hide(),this.ToggleSidePanel("show"))},e.prototype.SetCompactMode=function(t){var e=this;webix.delay((function(){e.setParam("compact",t),t||webix.fullscreen.exit(),e.refresh()}))},e.prototype.ToggleSidePanel=function(t){var e=this.$$("side");e&&("show"!==t&&e.isVisible()?(this._sidePanel="hide"===t,e.hide()):(!t||this._sidePanel&&"hide"!==t)&&(e.show(),this._sidePanel=!1))},e.prototype.ToggleAdd=function(t){var e=this.$$("add");t?e.hide():this.Compact&&e.show()},e}(l);function Tt(t){return'<div class="webix_event_marker"><div class="webix_event_marker_inner" style="background-color:'+(t.color||t.$color)+';"></div></div>'}function kt(t){return function(e,i){return'<div class="webix_event_overall"><div class="webix_event_time">'+i.timeStart(e)+"</div>"+Tt(e)+'<div class="webix_event_text">'+(e.text||t("(No title)"))+"</div></div>"}}function Lt(t){return"border-color:"+t.$color+"; background-color:"+(t.color||t.$color)+"; color:"+t.$textColor+";"}function It(t,e){return'<div class="start">'+webix.i18n.timeFormatStr(t)+'</div><div class="end">'+webix.i18n.timeFormatStr(e)+"</div>"}function At(t,e,i){var n=e.master;return n["$"+i]-(n.config["width"==i?"xCount":"yCount"]-1)*e[i]}function Pt(t,e,i){var n=e.width,r=e.height;return t.right&&(n=At(0,e,"width")),t.bottom&&(r=At(0,e,"height")),'<div webix_l_id="'+t.id+'" class="'+e.classname(t,e,i)+'" '+e.aria(t,e,i)+' style="width:'+n+"px; height:"+r+'px; float:left; overflow:hidden;">'}function Nt(t,e){return function(i){var n=i.start_date<=t,r=i.end_date>=e;if(n||r){var a=webix.copy(i);return n&&(a.start_date=t),r&&(a.end_date=e),a}return i}}function Ot(t){return webix.Date.equal(webix.Date.datePart(t),webix.Date.datePart(new Date))}function Rt(t){return t.all_day||t.start_date.getDate()!=t.end_date.getDate()&&t.end_date-t.start_date>=864e5}function Yt(t,e){return Math.round((webix.Date.dayStart(e)-webix.Date.dayStart(t))/864e5)}var Mt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this;return{view:"unitlist",localId:"list",uniteBy:function(){return"custom"},type:{template:kt(this.app.getService("locale")._),templateHeader:function(e){return t.TemplateHeader(e)},timeStart:function(e){return t.TimeStart(e)},height:50},on:{onUnits:function(){return t.SetUnits()},onItemClick:function(e,i){return t.ShowEvent(e,i)}}}},e.prototype.init=function(){this.State=this.app.getState(),this.List=this.$$("list"),webix.extend(this.List,webix.OverlayBox)},e.prototype.ShowEvent=function(t,e){var i=ct(this.List.getItem(t));i.node=e,this.State.selected=i},e.prototype.ToggleOverlay=function(){if(this.List.count())this.List.hideOverlay();else{var t=this.app.getService("locale")._;this.List.showOverlay(t("No Events"))}},e.prototype.SetUnits=function(){var t=this.List.units,e=this.data.all;if(Object.keys(t).length){this.List.units={};for(var i=this.data.start,n=this.data.end,r=function(){var t=webix.Date.add(i,1,"day",!0),n=e.filter((function(e){return e.start_date<t&&(e.end_date>i||e.end_date>=i&&e.all_day)})).map((function(t){return t.id}));n.length&&(a.List.units[i.valueOf()]=n),i=webix.Date.add(i,1,"day",!0)},a=this;i<n;)r()}},e.prototype.TimeStart=function(t){var e=this.app.getService("locale")._;return Rt(t)?e("All Day"):It(t.start_date,t.end_date)},e}(l),Ft=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var e=this,i=this.getParam("compact",!0),n=t.prototype.config.call(this);return n.css="webix_scheduler_agenda",webix.extend(n.type,{height:"auto",headerHeight:50,classname:function(t){return e.TemplateCss(t)}},!0),webix.extend(n.on,{onItemRender:function(t){t.$unit&&(e.CurrentUnit=t.$unit)},onItemClick:function(t,n,r){r=r.firstChild,e.ShowEvent(t,r),i||e.SelectEvent(r)}},!0),n},e.prototype.init=function(){var e=this;t.prototype.init.call(this),this.Data=this.app.getService("local");var i=this.Data.events(!0);this.on(this.State.$changes,"date",(function(){return e.RefreshData()})),this.on(this.State.$changes,"active",(function(){return e.RefreshData()})),this.on(this.State.$changes,"selected",(function(t){t||e.SelectEvent()})),this.on(this.app,"events:refresh",(function(){return e.RefreshData()})),this.on(i.data,"onStoreUpdated",(function(t,i,n){return n&&e.RefreshData()}))},e.prototype.RefreshData=function(){var t=this,e=webix.Date.monthStart(this.State.date),i=webix.Date.add(e,1,"month",!0);this.Data.getEvents(e,i).then((function(n){t.data={all:n,start:e,end:i},t.app&&(t.List.clearAll(),t.List.parse(n.map(Nt(e,i))),t.ToggleOverlay())}))},e.prototype.SelectEvent=function(t){if(t!=this._selected){var e="webix_agenda_selected";this._selected&&webix.html.removeCss(this._selected,e),t&&webix.html.addCss(t,e),this._selected=t}},e.prototype.TemplateHeader=function(t){var e=new Date(1*t),i="%F <span class='webix_scheduler_monthday"+(Ot(e)?" webix_scheduler_today":"")+"'>%j</span><br><span class='webix_scheduler_dayofweek'>%l</span>";return webix.Date.dateToStr(i)(e)},e.prototype.TemplateCss=function(t){var e=this.List.getUnitList(this.CurrentUnit),i="webix_list_item";return t.id==e[e.length-1]&&(i+=" webix_event_last"),t.id==e[0]&&(i+=" webix_event_first"),i},e}(Mt),Bt=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this;return{view:"list",borderless:!0,localId:"scale",css:"webix_scheduler_scale",type:{height:42,heightSize:function(e,i){var n=t.List.getIndexById(e.id);return i.height-(0===n?17:0)+"px"}},scroll:!1,autoheight:!0,width:51,template:function(e){return t.HourScaleItem(e)}}},e.prototype.init=function(){this.List=this.$$("scale"),this.ParseHours()},e.prototype.ParseHours=function(){for(var t=[],e=0;e<24;e++)t.push({id:e+""});this.List.parse(t)},e.prototype.HourScaleItem=function(t){return 0===this.List.getIndexById(t.id)?"":(t.id<10?"0":"")+t.id+":00"},e}(l),Ht=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this;return{cols:[{view:"template",localId:"more",width:50,css:"webix_scheduler_multi_space",tooltip:function(){return""},onClick:{"wxi-angle-down":function(){return t.ExpandData()},"wxi-angle-up":function(){return t.WrapData()}}},{}]}},e.prototype.init=function(){this.List=this.$$("multiDayList"),this.MoreIcon=this.$$("more"),this._expandState="down",this.maxVisibleLines=3},e.prototype.SetMoreIcon=function(t){if(t){var e="up"===t?"Collapse":"Expand",i=this.app.getService("locale")._;this.MoreIcon.setHTML('<div class="webix_scheduler_more_icon webix_icon wxi-angle-'+t+'" webix_tooltip="'+i(e+" all-day events")+'"><div>')}else this.MoreIcon.setHTML("")},e.prototype.Animate=function(t,e,i){var n=this;this.List.$view.style.transition="height 150ms",e&&(this.List.$view.style.height=e+"px"),setTimeout((function(){i&&i(),n.List.$view.style.transition="",n._inAnimation=!1,n.SetMoreIcon(t)}),150)},e}(l);function Ut(t,e){var i=this.LocateSelected(t);if(i)for(var n=0;n<i.length;n++)e(i[n],"webix_scheduler_event_selected")}function Vt(t){return Ut.call(this,t,webix.html.addCss)}function jt(t){return Ut.call(this,t,webix.html.removeCss)}function Wt(){var t=this,e=this._SelectionMode;if(this.State=this.app.getState(),this.on(this.State.$changes,"selected",(function(i,n){if(n&&t.Unselect(n.date&&"string"==typeof n.date?n.date:n.id),i){var r="0"!==i.id&&i.date?i.date:i.id;setTimeout((function(){return t.Select(r)}),"multi"!==e&&"0"===r?150:0)}})),"multi"!==e){var i=this.app.getService("local").events(!0);this.on(i.data,"onStoreUpdated",(function(e,i,n){"add"===n&&"0"!=e&&t.State.selected&&"0"===t.State.selected.id&&(t.State.selected.id=e)}))}}function Gt(t,e,i){t._SelectionMode=e,t.Select=Vt,t.Unselect=jt,t.HandleSelection=Wt,t.LocateSelected=function(t){return function(e){return this._DataObj?Array.prototype.map.call(this._DataObj.querySelectorAll("[webix_"+(t?"l":"e")+'_id="'+e+'"]'),(function(e){return t?e.firstElementChild:e})):null}}(i),t.HandleSelection()}var zt={$dragIn:function(){return this.getContext().from.mode===this.mode},$dragPos:function(t){var e=this.getContext(),i=webix.html.offset(e.target),n=t.y-i.y;n<e.y_diff?n=e.y_diff:n>i.height&&(n=i.height);var r=n-e.y_diff;zt.updateNodeHeight.call(this,r),e.duration!==r&&(e.duration=r,this.updateText(e)),t.x=e.x_diff,t.y=e.y_diff},updateNodeHeight:function(t){webix.DragControl.getNode().style.height=Math.max(this.master.minEventHeight,t)+"px"},getActualDate:function(t,e){var i=this.getContext(),n=webix.Date.copy(i.event.start_date),r=5*(Math.round(60*i.duration/t.List.type.height/5)||1);return webix.Date.add(n,r,"minute"),!e&&webix.Date.equal(n,i.event.end_date)?null:{start_date:webix.Date.copy(i.event.start_date),end_date:n}}};function Qt(t,e,i){var n=webix.copy(ne[e]);n.view=t,n.master=this,n.State=this.app.getState(),n.Local=this.app.getService("local").events(!0),n.Ops=this.app.getService("operations"),webix.DragControl.addDrag(t.$view,n),i||webix.DragControl.addDrop(t.$view,n,!0)}function qt(t,e){var i,n,r=t.target;do{n=(i=r.getAttribute("webix_e_id"))?r:null,r=r.parentNode}while(!i&&r!==e);return{id:i,node:n}}function Xt(t,e){if(this.State.selected){var i=ct(t);t.$recurring&&(i.date=e.start_date.valueOf()+"_"+t.$id),this.State.selected=i}}function Kt(t,e,i){var n=this,r=e.$id||e.id;if("this"===t&&this.master.HasOneOccurrence(e))return this.Ops.updateEvent(r,i);if(!(t=this.master.ChangeMode(t,e,this.Local.getItem(e.recurring?r:e.origin_id).start_date,e.recurring?e.id:e.start_date)))return e.$recurring=gt(e.$recurring,i,e),i.recurring=et(e.$recurring),this.Ops.updateEvent(r,i);if("this"===t||"next"===t){var a,o="";"this"===t?o=dt(e.id,e):e.recurring?o=lt(e.id,webix.copy(e)):(r=e.origin_id,a=webix.copy(this.Local.getItem(r)),o=lt(i.start_date,webix.copy(a),!0));var s=Jt.call(this,r,t,e,i,a);return this.Ops.updateEvent(r,{recurring:o},"next"===t?"next":"common",webix.Date.dayStart(i.start_date)).then((function(){return n.Ops.addEvent(s)}))}if("all"===t){var u=e.origin_id||e.$id,c=webix.copy(this.Local.getItem(u)),h=c.$recurring;return(h.COUNT||h.UNTIL)&&(h=this.master.CorrectCountUntil(c,t,i.start_date,this.Local)),(h=gt(h,i,c)).EXDATE&&delete h.EXDATE,i.recurring=et(h),this.Ops.updateEvent(e.origin_id||r,i,"unite")}}function Jt(t,e,i,r,a){var o={text:i.text,details:i.details,color:i.color,all_day:i.all_day,start_date:r.start_date,end_date:r.end_date,origin_id:i.origin_id||t};if("next"===e){var s=webix.copy(i.recurring?i.$recurring:a.$recurring);(s.COUNT||s.UNTIL)&&(s=this.master.CorrectCountUntil(n(n({},this.Local.getItem(t)),{$recurring:s}),e,o.start_date,this.Local)),(s=gt(s,o,i)).EXDATE=[],o.recurring=et(s)}return this.master.app.config.calendars&&(o.calendar=i.calendar),o}var Zt={mode:"common",$dragDestroy:function(t,e){var i=this.getContext();return i.$waitUpdate||(i.node.style.visibility="visible"),i.$resize&&webix.html.removeCss(document.body,"webix_active_resize"),webix.html.remove(e),!1},getContext:function(){return webix.DragControl.getContext()},setDragOffset:function(t,e,i){var n=this.getContext(),r=webix.html.pos(i),a=webix.html.offset(t);n.width=a.width,n.height=a.height,n.x_offset=a.x-r.x,n.y_offset=a.y-r.y},updateEvent:function(t,e,i){var n=this;if(i.event.$id||i.event.origin_id)this.master._waitPopup=webix.promise.defer(),this.master._waitPopup.then((function(r){var a=Kt.call(n,r,i.event,e);a.then((function(){return Xt.call(n,t,e)})),n.master.app.callEvent("backend:operation",[a])})).finally((function(){return n.master._waitPopup=null})),this.master.app._dndActionPopup.Show(this.master._waitPopup);else{var r=this.Ops.updateEvent(t.$id||t.id,e);this.finishOperation(r,t,e,i)}},addEvent:function(t,e,i){var n={text:t.text,start_date:e.start_date,end_date:e.end_date,details:""};this.master.app.config.calendars&&(n.calendar=t.calendar);var r=this.Ops.addEvent(n);this.finishOperation(r,n,e,i)},finishOperation:function(t,e,i,r){var a=this;t.then((function(t){return Xt.call(a,t?n(n({},e),{id:t}):e,i)})),this.master.app.callEvent("backend:operation",[t]),r.$waitUpdate=!0}},te=webix.extend({mode:"day",$dragIn:function(t,e){var i=this.getContext();if(i.$resize)return zt.$dragIn.apply(this,arguments);if(i.from.mode!==this.mode)return!1;if(i.target!=e){var n=webix.DragControl.getNode();e.firstChild.appendChild(n),i.target=e}return!0},$drop:function(){var t=this.getContext();if(t.from.mode!==this.mode)return!1;var e=this.getActualDate(this.master);e&&("0"==t.event.id?this.addEvent(t.event,e,t):this.updateEvent(t.event,e,t))},$dragPos:function(t){var e=this.getContext();if(e.$resize)return zt.$dragPos.apply(this,arguments);var i=webix.html.offset(e.target),n=i.height-e.height;t.x=e.x_diff,t.y+=e.y_offset-i.y,t.y<0?t.y=0:t.y>n&&(t.y=n),webix.extend(e,t,!0),e.$last_y!==t.y&&(this.updateText(e),e.$last_y=t.y)},$dragCreate:function(t,e){if(this.State.readonly)return!1;var i=qt(e,t);if(i.id){var n=this.getContext();webix.extend(n,i,!0),webix.extend(n,{from:this,target:t},!0),n.event=this.master.GetEvent(i.id),this.setDragOffset(i.node,t,e),e.target.getAttribute("webix_resizer")&&(webix.html.addCss(document.body,"webix_active_resize",!0),n.$resize=!0);var r=i.node.cloneNode(!0);return r.className+=" webix_drag_zone webix_"+(n.$resize?"resize":"drag")+"_event",t.firstChild.appendChild(r),i.node.style.visibility="hidden",r}return!1},getActualDate:function(t,e){var i=this.getContext();if(i.$resize)return zt.getActualDate.apply(this,arguments);var n=webix.Date.copy(t.Day),r=t.List.getFirstId()*t.List.type.height,a=5*Math.round(60*(i.y+r)/t.List.type.height/5);if(webix.Date.add(n,a,"minute"),!e&&webix.Date.equal(n,i.event.start_date))return null;var o=i.event.end_date-i.event.start_date;return{start_date:n,end_date:new Date(n.valueOf()+o)}},updateText:function(t){var e=webix.DragControl.getNode(),i=webix.DragControl.getMaster(t.target),n=this.getActualDate(i.master,!0);n.text=t.event.text,e.innerHTML="",e.innerHTML=i.master.EventTemplate(n)},setDragOffset:function(t,e,i){var n=this.getContext(),r=webix.html.pos(i),a=webix.html.offset(t);n.height=a.height,n.x_offset=a.x-r.x,n.y_offset=a.y-r.y;var o=webix.html.offset(e);n.x_diff=a.x-o.x-1,n.y_diff=a.y-o.y}},Zt),ee=webix.extend({mode:"month",$dragIn:function(t,e,i){var n=this.getContext();if(n.from.mode!==this.mode)return!1;n.offset=n.offset||webix.html.offset(e);var r=this.locate(i),a=this.view.getIdByIndex(r),o=this.view.getItemNode(a);return n.$marked!==a&&this.markDropArea(a),o},$dragOut:function(t,e,i){return e!==i&&this.markDropArea(),null},$drop:function(t,e,i){var n=this.getContext();if(n.from.mode!==this.mode)return!1;this.markDropArea();var r=this.getActualDate(i);r&&("0"==n.event.id?this.addEvent(n.event,r,n):this.updateEvent(n.event,r,n))},$dragPos:function(t){var e=this.getContext();t.x+=e.x_offset,t.y+=e.y_offset},$dragCreate:function(t,e){if(this.State.readonly)return!1;var i=qt(e,t);if(i.id&&"$wsh_multi_more"!=i.id){var n=this.getContext();webix.extend(n,i,!0),webix.extend(n,{from:this,offset:webix.html.offset(t)},!0),n.event=this.master.Events.getItem(i.id),n.start=this.view.getIdByIndex(this.locate(e)),this.setDragOffset(i.node,t,e);var r=document.createElement("DIV"),a=i.node.cloneNode(!0);return a.style.position="static",r.appendChild(a),r.className=t.className+" webix_drag_zone webix_drag_event",document.body.appendChild(r),i.node.style.visibility="hidden",webix.callEvent("onClick",[e]),r}return!1},getActualDate:function(t){var e=this.getContext(),i=this.locate(t)-this.view.getIndexById(e.start);return i?{start_date:webix.Date.add(e.event.start_date,i,"day",!0),end_date:webix.Date.add(e.event.end_date,i,"day",!0)}:null},markDropArea:function(t){var e=this.getContext();if(e.$marked&&e.$marked!=t&&(this.view.removeCss(e.$marked,"webix_drag_over"),e.$marked=null,e.$extra&&(webix.html.removeCss(this.view.$view,e.$extra),e.$extra=null)),!e.$marked&&t){this.view.addCss(t,"webix_drag_over"),e.$marked=t;var i=void 0;this.view.getFirstId()==t?i="webix_scheduler_dnd_1":this.view.getLastId()==t&&(i="webix_scheduler_dnd_n"),i&&(webix.html.addCss(this.view.$view,i,!0),e.$extra=i)}},locate:function(t){var e=this.getContext(),i=webix.html.pos(t);return i.x-=e.offset.x,i.y-=e.offset.y,Math.min(Math.floor(i.y/this.view.type.height),this.view.config.yCount-1)*this.view.config.xCount+Math.min(Math.floor(i.x/this.view.type.width),this.view.config.xCount-1)}},Zt),ie=webix.extend({mode:"multiday"},ee),ne={day:te,month:ee,more:webix.extend({$dragCreate:function(t,e){if(this.State.readonly)return!1;var i=this.view.locate(e);if(i){var n=this.getContext(),r=this.view.getItemNode(i).children[0];webix.extend(n,{from:this,id:i},!0),n.event=this.master.Events.getItem(i),n.start=this.master.ID,this.setDragOffset(r,t,e);var a=document.createElement("DIV");return a.style.width=n.width+"px",a.style.height=n.height+"px",a.appendChild(r.cloneNode(!0)),a.className=t.className+" webix_drag_zone webix_drag_event",document.body.appendChild(a),this.master.HideWindow(),a}return!1},$dragDestroy:function(t,e){return webix.html.remove(e),!1}},ee),multiday:ie},re=function(t){function e(e,i,n){var r=t.call(this,e,i)||this;return n&&(r.WeekDayNum=n.day),r}return i(e,t),e.prototype.config=function(){var t=this;return{view:"list",localId:"dayList",css:"webix_scheduler_day_events",scroll:!1,autoheight:!0,template:"",type:{height:42,css:"webix_scheduler_day_scale_item"},onClick:{webix_scheduler_day_event:function(e){return t.ShowEvent(e)}},onDblClick:{webix_scheduler_day_scale_item:function(e,i){return t.ShowNew(i)}}}},e.prototype.init=function(){var t=this;this.State=this.app.getState(),this.List=this.$$("dayList"),Gt(this,"scale"),xt(this),this.List.$setSize=function(t,e){webix.ui.view.prototype.$setSize.call(this,t,e)&&this.render()},this.minEventHeight=62,this.ParseHours(),this.on(this.State.$changes,"readonly",(function(){return t.List.render()})),this.List.attachEvent("onAfterRender",(function(){return t.RenderEvents()})),Qt.call(this,this.List,"day")},e.prototype.urlChange=function(){var t=this;if(this.data=this.getParam("data"),this.data){if(this.Day=webix.Date.datePart(this.State.date,!0),this.WeekDayNum>-1){var e=this.data.start;this.Day=webix.Date.add(e,this.WeekDayNum,"day",!0)}var i=webix.Date.add(this.Day,1,"day",!0);this.Events=this.FilterToday(this.Day,i),this._marker_update_interval&&(this._marker_update_interval=clearInterval(this._marker_update_interval)),Ot(this.Day)&&(this._marker_update_interval=setInterval((function(){Ot(t.Day)?t.UpdateMarkerPosition():(webix.html.remove(t._Marker),t._Marker=t._marker_update_interval=clearInterval(t._marker_update_interval))}),3e5)),this.List.render()}},e.prototype.GetEvent=function(t){for(var e=0;e<this.Events.length;e++)if(this.Events[e].id==t)return this.Events[e];return null},e.prototype.FilterToday=function(t,e){return this.WeekDayNum>-1?this.data.single.filter((function(i){if(i.start_date<e&&i.end_date>t)return!0})):this.data.single},e.prototype.MarkToday=function(){if(this.Day&&Ot(this.Day)){var t=webix.html.create("div",{class:"webix_scheduler_today_marker"});this._Marker=this.List.$view.firstChild.appendChild(t),this.UpdateMarkerPosition()}else this._Marker=null},e.prototype.UpdateMarkerPosition=function(){if(this._Marker){var t=new Date,e=60*t.getHours()+t.getMinutes();this._Marker.style.top=Math.round(e*this.List.type.height/60)+"px"}},e.prototype.RenderEvents=function(){var t=this,e=this.Events;if(e&&e.length){this.PrepareEvents();var i=webix.html.create("div",{role:"presentation"});i.innerHTML=e.map((function(e){return t.ToHTML(e)})).join(""),this._DataObj=this.List.$view.firstChild.appendChild(i)}this.MarkToday()},e.prototype.PrepareEvents=function(){for(var t=this.Events,e=[],i=0;i<t.length;i++){var n=t[i];n.$inner=!1;var r=this.PruneStack(n,e);e.length&&(e[e.length-1].$inner=!0),r||(e.length?(n.$sorder=e[e.length-1].$sorder+1,n.$inner=!1):n.$sorder=0),e.splice(n.$sorder,0,n),e.length>(e.max_count||0)&&(e.max_count=e.length)}this.SetPosition(e,t)},e.prototype.PruneStack=function(t,e){for(;e.length&&this.GetEventEndDate(e[e.length-1])<=t.start_date;)e.splice(e.length-1,1);for(var i=0;i<e.length;i++)if(this.GetEventEndDate(e[i])<=t.start_date)return t.$sorder=e[i].$sorder,e.splice(i,1),t.$inner=!0,!0;return!1},e.prototype.SetPosition=function(t,e){for(var i=this.List.getFirstId()*this.List.type.height,n=0;n<e.length;n++){var r=e[n];r.$count=t.max_count;var a=Math.floor(this.List.$width/r.$count);r.$left=r.$sorder*a,r.$inner||(a*=r.$count-r.$sorder),r.$width=a-8;var o=Nt(this.Day,webix.Date.add(this.Day,1,"day",!0))(r),s=60*o.start_date.getHours()+o.start_date.getMinutes(),u=60*o.end_date.getHours()+o.end_date.getMinutes()||1440;r.$top=Math.round(s*this.List.type.height/60)-i,r.$height=Math.max(this.minEventHeight,(u-s)*this.List.type.height/60)}},e.prototype.ToHTML=function(t){var e=this.EventTemplate(t);return this.EventTemplateStart(t)+e+"</div>"},e.prototype.GetEventEndDate=function(t){var e=t.end_date;return(t.end_date-t.start_date)/6e4*this.List.type.height/60<this.minEventHeight&&(e=webix.Date.add(t.start_date,Math.ceil(this.minEventHeight/this.List.type.height*60),"minute",!0)),e},e.prototype.EventTemplateStart=function(t){var e='class="webix_scheduler_day_event '+(!this.State.selected||t.id!=this.State.selected.id&&t.id!=this.State.selected.date?"":"webix_scheduler_event_selected")+'"';return"<div webix_e_id='"+t.id+"' "+e+" style='left:"+t.$left+"px; top:"+t.$top+"px; width:"+t.$width+"px; height:"+t.$height+"px; "+Lt(t)+"'>"},e.prototype.EventTemplate=function(t){var e=this.app.getService("locale")._,i=this.State.readonly?"":"<div class='webix_icon webix_scheduler_resizer' webix_resizer='true'></div>";return'<div class="webix_scheduler_inner_day"><span class="webix_scheduler_event_name">'+(t.text||e("(No title)"))+'</span><div class="webix_scheduler_event_time">'+webix.i18n.timeFormatStr(t.start_date)+" - "+webix.i18n.timeFormatStr(t.end_date)+"</div></div>"+i},e.prototype.ShowEvent=function(t){var e=qt(t,this.List.$view);if(e.id&&"0"!=e.id){var i=this.GetEvent(e.id),n=webix.extend(e,ct(i),!0);this.State.selected=n}return!1},e.prototype.ShowNew=function(t){var e=webix.Date.copy(this.Day||this.State.date);e.setHours(t),this.State.selected={id:"0",date:e}},e}(Bt),ae=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var e=this,i=t.prototype.config.call(this);return i.cols[1]={view:"list",localId:"multiDayList",autoheight:!0,scroll:!1,css:"webix_scheduler_multilist",type:{height:32,template:function(t,i){return e.EventTemplate(t,i)}},onClick:{webix_scheduler_multiday_event:function(t,i,n){return e.ShowEvent(i,n)}}},i},e.prototype.init=function(){this.State=this.app.getState(),t.prototype.init.call(this),this._DataObj=this.List.$view.firstChild,Gt(this,"multi",!0),this.MoreIcon=this.$$("more"),this._moreBtn={id:"$wsh_multi_more",$css:"webix_scheduler_multi_more"}},e.prototype.urlChange=function(){var t=this.getParam("data");t&&(this.LimitData(t.multi),this.List.clearAll(),this.List.parse(t.multi))},e.prototype.EventTemplate=function(t,e){var i=e.height-4,n="height:"+i+"px; line-height:"+i+"px; width:calc(100% - 5px);",r="$wsh_multi_more"!==t.id?Lt(t):"",a=this.GetStyle(t),o=this.app.getService("locale")._;return'\n\t\t\t<div\n\t\t\t\tclass="'+a+'"\n\t\t\t\tstyle="'+n+" "+r+'">\n\t\t\t\t\t'+(t.text||o("(No title)"))+"\n\t\t\t</div>\n\t\t"},e.prototype.GetStyle=function(t){var e=this.State.date,i=t.all_day||webix.Date.timePart(t.end_date)?t.end_date:webix.Date.add(t.end_date,-1,"day",!0),n="webix_scheduler_multiday_event";return n+=!this.State.selected||t.id!=this.State.selected.id&&t.id!=this.State.selected.date?"":" webix_scheduler_event_selected",t.start_date<e&&(n+=" webix_scheduler_event_break_left"),i>=webix.Date.add(e,1,"day",!0)&&(n+=" webix_scheduler_event_break_right"),n},e.prototype.LimitData=function(t){if(t.length>this.maxVisibleLines){var e=t.length-2,i=this.app.getService("locale")._;this._moreBtn.text=e+" "+i("more"),"down"===this._expandState?this._reserve=t.splice(2,e,this._moreBtn):this._reserve=t.slice(2),this.SetMoreIcon(this._expandState),this._reserveIds=this._reserve.map((function(t){return t.id}))}else this.SetMoreIcon()},e.prototype.WrapData=function(){var t=this;if(!this._inAnimation){this._inAnimation=!0,this._expandState="down";var e=this.List.$height-(this._reserveIds.length-1)*this.List.type.height;this.Animate("down",e,(function(){t.List.add(t._moreBtn),t.List.remove(t._reserveIds)}))}},e.prototype.ExpandData=function(){this._inAnimation||(this._inAnimation=!0,this._expandState="up",this.Animate("up"),this.List.remove("$wsh_multi_more"),this.List.parse(this._reserve))},e.prototype.Animate=function(t,e,i){var n=this;this.List.$view.style.transition="height 150ms",e&&(this.List.$view.style.height=e+"px"),setTimeout((function(){i&&i(),n.List.$view.style.transition="",n._inAnimation=!1,n.SetMoreIcon(t)}),150)},e.prototype.SetMoreIcon=function(t){if(t){this._expandState=t;var e="up"===t?"Collapse":"Expand",i=this.app.getService("locale")._;this.MoreIcon.setHTML('<div class="webix_scheduler_more_icon webix_icon wxi-angle-'+t+'" webix_tooltip="'+i(e+" all-day events")+'"><div>')}else this.MoreIcon.setHTML("")},e.prototype.ShowEvent=function(t,e){if("$wsh_multi_more"===t)this.ExpandData();else{var i=ct(this.List.getItem(t));i.node=e,this.State.selected=i}return!1},e}(Ht),oe=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){return{css:"webix_scheduler_day",rows:[{view:"template",localId:"header",css:"webix_scheduler_day_header",height:32,template:function(t){return t.date?webix.Date.dateToStr("%l")(t.date):""}},{localId:"multi",hidden:!0,cols:[ae]},{localId:"scroll",view:"scrollview",css:"webix_scheduler_day_scroll",body:{cols:[Bt,re]}}]}},e.prototype.init=function(){var t=this,e=this.app.getState();this.on(e.$changes,"date",(function(e){return t.RefreshData(e)})),this.on(e.$changes,"active",(function(){return t.RefreshData(e.date)})),this.on(this.app,"events:refresh",(function(){return t.RefreshData(e.date)}));var i=this.app.getService("local").events(!0);this.on(i.data,"onStoreUpdated",(function(i,n,r){return r&&t.RefreshData(e.date)})),this.on(e.$changes,"selected",(function(e){return e&&t.ScrollScale(e)}))},e.prototype.RefreshData=function(t){var e=this;this.$$("header").setValues({date:t}),this.GetDay(t).then((function(t){e.app&&e.setParam("data",t,!0),t.multi.length?e.$$("multi").show():e.$$("multi").hide()}))},e.prototype.GetDay=function(t){var e=webix.Date.add(t,1,"day",!0);return this.app.getService("local").getEvents(t,e).then((function(t){var e=[],i=[];return t.forEach((function(t){Rt(t)?e.push(t):i.push(t)})),{multi:e,single:i}}))},e.prototype.ScrollScale=function(t){var e=this;"0"!==t.id||t.date||setTimeout((function(){var t=40*((new Date).getHours()+2);e.$$("scroll").scrollTo(0,t)}),100)},e}(l),se=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this;return this.Events={},{view:"calendar",localId:"calendar",events:function(e,i){return t.MarkEvent(e,i)},icons:!1,navigation:!1,monthHeader:!1,skipEmptyWeeks:!0,width:0,height:410}},e.prototype.init=function(){var t=this;this.Calendar=this.getRoot(),this.Calendar.attachEvent("onDateSelect",(function(e){t.app.getState().date=webix.Date.dayStart(e)}))},e.prototype.urlChange=function(){this.data=this.getParam("data"),this.data&&this.RefreshData()},e.prototype.RefreshData=function(){var t=this.data,e=t.start,i=t.weeks,n=t.data,r=webix.Date.add(e,i,"week",!0);for(this.Events={};e<r;){for(var a=webix.Date.add(e,1,"day",!0),o=0;o<n.length;o++)(n[o].all_day?n[o].end_date>=e:n[o].end_date>e)&&n[o].start_date<a&&(this.Events[e.valueOf()]=!0);e=a}this.Calendar.setValue(this.app.getState().date)},e.prototype.MarkEvent=function(t,e){var i="";return e||(i+=webix.Date.isHoliday(t)||""),this.Events[t.valueOf()]&&(i+=" webix_cal_day_with_event"),i},e}(l),ue=function(t){function e(e,i,n){var r=t.call(this,e,i)||this;return r.Events=n.events,r}return i(e,t),e.prototype.config=function(){var t=this,e=this.app.getService("locale")._;return{view:"popup",width:266,padding:8,minHeight:70,relative:"right",body:{view:"list",css:"webix_scheduler_more_list",borderless:!0,autoheight:!0,yCount:3,tooltip:{template:""},onClick:{webix_scheduler_month_event:function(e,i){return t.ShowEvent(i)},webix_scheduler_month_event_single:function(e,i){return t.ShowEvent(i)}},type:{height:56,template:function(i,n){return t.MoreTemplate(i,n,e)}}}}},e.prototype.init=function(t){this.Win=t,xt(this),Qt.call(this,t.getBody(),"more",!0)},e.prototype.MoreTemplate=function(t,e,i){var n=webix.i18n,r=!Yt(t.start_date,t.end_date);return'\n\t\t\t<div\n\t\t\t\tclass="webix_scheduler_month_event'+(r?"_single":"")+'"\n\t\t\t\tstyle="'+(r?"":Lt(t))+'"\n\t\t\t>\n\t\t\t\t'+(r?Tt(t):"")+'\n\t\t\t\t<div webix_tooltip="'+t.text+'" class="webix_event_text">'+(t.text||i("(No title)"))+'</div>\n\t\t\t\t<div class="webix_event_time">\n\t\t\t\t\t'+this.DayFormatStr(t.start_date)+"\n\t\t\t\t\t"+n.timeFormatStr(t.start_date)+" -\n\t\t\t\t\t"+(r?"":" "+this.DayFormatStr(t.end_date))+"\n\t\t\t\t\t"+n.timeFormatStr(t.end_date)+"\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"},e.prototype.DayFormatStr=function(t){return webix.Date.dateToStr("%F %j")(t)},e.prototype.ShowEvent=function(t){var e=this.Events.getItem(t);this.app.getState().selected=ct(e)},e.prototype.ShowWindow=function(t,e,i){var n=this;if(this.ID===t&&this.Win.isVisible())return this.Win.hide();this.ID=t,i=i.map((function(t){return n.Events.getItem(t)}));var r=this.Win.getBody();r.clearAll(),r.parse(i),this.Win.show(e)},e.prototype.HideWindow=function(){this.Win.hide()},e}(l),ce=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this;return{view:"dataview",css:"webix_scheduler_calendar",prerender:!0,xCount:7,yCount:5,width:0,height:0,scroll:!1,tooltip:{template:""},onClick:{webix_cal_date:function(e,i){return t.ShowDay(i)},webix_scheduler_month_event:function(e){return t.ShowEvent(e)},webix_scheduler_month_event_single:function(e){return t.ShowEvent(e)},webix_scheduler_more:function(e,i){return t.ShowMore(i)}},onDblClick:{webix_cal_day:function(e,i){return t.ShowNew(i)}},type:{height:"auto",width:"auto",template:function(e,i){return t.CalendarTemplate(e,i)},templateStart:Pt,headerHeight:32,eventHeight:28,padding:8}}},e.prototype.init=function(t){var e=this;this.State=this.app.getState(),this.Calendar=t,t.type.master=this.Calendar,Gt(this,"month"),xt(this),this.Events=new webix.DataCollection({}),this.MoreWindow=this.ui(new(this.app.dynamic(ue))(this.app,"",{events:this.Events})),t.attachEvent("onAfterRender",(function(){return e.RenderEvents()})),Qt.call(this,this.Calendar,"month")},e.prototype.urlChange=function(){this.data=this.getParam("data"),this.data&&this.RefreshData()},e.prototype.CalendarTemplate=function(t){var e=this.app.getService("locale")._,i='<span class="webix_cal_date">'+t.date.getDate()+"</span>";return t.$more&&t.$more.length&&(i+='<div class="webix_scheduler_more">'+t.$more.length+" "+e("more")+"</div>"),i},e.prototype.GetDayCss=function(t,e){var i="webix_cal_day";return Ot(t)&&(i+=" webix_cal_today"),t.getMonth()!=e?i+=" webix_cal_outside":i+=" "+(webix.Date.isHoliday(t)||""),i},e.prototype.GetMonthData=function(){for(var t=[],e=this.data,i=e.start,n=e.weeks,r=webix.Date.add(i,1,"week",!0).getMonth(),a=webix.Date.copy(i),o=0;o<7*n;o++){var s={date:webix.Date.copy(a),$css:this.GetDayCss(a,r)};(o+1)%7==0&&(s.right=!0),o>=7*(n-1)&&(s.bottom=!0),t.push(s),webix.Date.add(a,1,"day")}return t},e.prototype.RenderEvents=function(){if(this.Events.count()&&this.Calendar.count()){var t=webix.html.create("div",{role:"presentation",class:"webix_scheduler_month_events"}),e=this.data.start,i=this.Calendar.type,n=Math.floor((i.height-i.headerHeight+i.padding-2)/(i.eventHeight+i.padding)),r=webix.Date.copy(e),a=webix.Date.add(r,1,"week",!0),o="",s={},u=this.Calendar.getItem(this.Calendar.getLastId()).date,c=this.Calendar.getItem(this.Calendar.getFirstId()).date;this.Calendar.data.each((function(t,e){t.date>=a&&(s={},r=a,a=webix.Date.add(r,1,"week",!0));var i=[],h=[];this.Events.data.each((function(o){var l=o.id;if(!(o.start_date>=a||o.end_date<r||!o.all_day&&webix.Date.equal(o.end_date,r)))if(webix.isUndefined(s[l])){if(o.start_date<webix.Date.add(t.date,1,"day",!0)&&o.end_date>=t.date){for(var d=0;!webix.isUndefined(h[d]);)d++;if(s[l]=d,d>=n)return i.push(l);var p={ms:c,me:u};p.single=!Yt(o.start_date,o.all_day?webix.Date.add(o.end_date,1,"day",!0):o.end_date),p.length=1,p.single||(p.es=o.start_date,p.ee=o.all_day||webix.Date.timePart(o.end_date)?o.end_date:webix.Date.add(o.end_date,-1,"day",!0),p.length+=Yt(p.ls=new Date(Math.max(r,p.es)),p.le=new Date(Math.min(a-1,p.ee)))),p.index=e,h[d]=this.ToHTML(o,d,p)}}else t.date<=o.end_date&&o.all_day||t.date<o.end_date?s[l]>=n?i.push(l):h[s[l]]="":delete s[l]}),this);var l=t.$more&&t.$more.length;t.$more=i,l!=i.length&&this.Calendar.render(t.id,t,"paint"),o+=h.join("")}),this),t.innerHTML=o,this._DataObj=this.Calendar.$view.firstChild.appendChild(t)}},e.prototype.ToHTML=function(t,e,i){var n=this.Calendar.type,r=i.single?"":Lt(t),a=i.length*n.width-n.padding,o=n.eventHeight,s=this.GetPosition(n,e,i.index),u="";i.single&&(u=Tt(t)+'<span class="webix_event_time">'+webix.i18n.timeFormatStr(t.start_date)+"</span>");var c=this.GetStyle(t,i),h=this.app.getService("locale")._;return'\n\t\t\t<div\n\t\t\t\twebix_tooltip="'+t.text+'"\n\t\t\t\twebix_e_id="'+t.id+'"\n\t\t\t\tclass="'+c+'"\n\t\t\t\tstyle="height:'+o+"px;line-height:"+o+"px; width:"+a+"px; "+(s+r)+'">\n\t\t\t\t\t'+(u+(t.text||h("(No title)")))+"\n\t\t\t</div>\n\t\t"},e.prototype.GetStyle=function(t,e){var i="webix_scheduler_month_event"+(e.single?"_single":"");return i+=!this.State.selected||t.id!=this.State.selected.id&&t.id!=this.State.selected.date?"":" webix_scheduler_event_selected",e.single||(e.es<e.ms&&webix.Date.equal(e.ms,webix.Date.dayStart(e.ls))?i+=" webix_scheduler_event_break_left":e.ee>=webix.Date.add(e.me,1,"day",!0)&&webix.Date.equal(e.me,webix.Date.dayStart(e.le))&&(i+=" webix_scheduler_event_break_right")),i},e.prototype.GetPosition=function(t,e,i){var n=Math.floor(i/this.Calendar.config.xCount),r=i%this.Calendar.config.xCount;return"\n\t\t\ttop:"+(n*t.height+t.headerHeight+e*(t.eventHeight+t.padding))+"px;\n\t\t\tleft:"+r*t.width+"px;\n\t\t"},e.prototype.RefreshData=function(){var t=this.data,e=t.data,i=t.weeks;this.Events.clearAll(),this.Events.parse(e),this.Events.sort((function(t,e){var i=webix.Date.dayStart(t.start_date),n=webix.Date.dayStart(e.start_date);if(webix.Date.equal(i,n)){var r=Yt(t.start_date,t.end_date);return Yt(e.start_date,e.end_date)-r||t.start_date-e.start_date}return i-n}));var n=this.GetMonthData();this.Calendar.clearAll(),this.Calendar.config.yCount!=i&&(this.Calendar.define("yCount",i),this.Calendar.resize()),this.Calendar.parse(n)},e.prototype.ShowMore=function(t){return this.MoreWindow.ShowWindow(t,this.Calendar.getItemNode(t),this.Calendar.getItem(t).$more||[]),!1},e.prototype.ShowEvent=function(t){var e=qt(t,this.Calendar.$view);if(e.id&&"0"!=e.id){var i=this.Events.getItem(e.id),n=webix.extend(e,ct(i),!0);this.State.selected=n}return!1},e.prototype.ShowNew=function(t){var e=this.Calendar.getItem(t).date;this.State.selected={id:"0",date:e}},e.prototype.ShowDay=function(t){return this.app.getState().$batch({date:this.Calendar.getItem(t).date,mode:"day"}),!1},e}(l),he=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){return{view:"dataview",css:"webix_scheduler_calendar_header",xCount:7,yCount:1,width:0,height:32,scroll:!1,type:{height:"auto",width:"auto",templateStart:Pt}}},e.prototype.init=function(t){t.type.master=t,t.parse(this.GetHeaderData())},e.prototype.GetHeaderData=function(){for(var t=[],e=webix.Date.startOnMonday?1:0,i=0;i<7;i++)t.push({value:webix.i18n.calendar.dayShort[(e+i)%7]});return t[t.length-1].right=!0,t},e}(l),le=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var t=this;return{view:"list",type:{height:50,template:kt(this.app.getService("locale")._),timeStart:function(e){return t.TimeStart(e)}},on:{onItemClick:function(e){return t.ShowEvent(e)}}}},e.prototype.init=function(){this.List=this.getRoot(),this.State=this.app.getState(),webix.extend(this.List,webix.OverlayBox)},e.prototype.urlChange=function(){this.data=this.getParam("data"),this.data&&this.RefreshData()},e.prototype.RefreshData=function(){var t=this,e=webix.Date.datePart(this.State.date,!0),i=webix.Date.add(e,1,"day",!0);this.app.getService("local").getEvents(e,i).then((function(n){t.List.clearAll(),t.List.parse(n.map(Nt(e,i))),t.ToggleOverlay()}))},e.prototype.ToggleOverlay=function(){if(this.List.count())this.List.hideOverlay();else{var t=this.app.getService("locale")._;this.List.showOverlay(t("No Events"))}},e.prototype.ShowEvent=function(t){var e=this.List.getItem(t);this.State.selected=ct(e)},e.prototype.TimeStart=function(t){var e=this.app.getService("locale")._;return Rt(t)?e("All Day"):It(t.start_date,t.end_date)},e}(l),de=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){return{rows:this.getParam("compact",!0)?[se,le]:[he,ce]}},e.prototype.init=function(){var t=this;this.Data=this.app.getService("local");var e=this.app.getState();this.on(e.$changes,"date",(function(e){return t.RefreshData(e)})),this.on(e.$changes,"active",(function(){return t.RefreshData(e.date)})),this.on(this.app,"events:refresh",(function(){return t.RefreshData(e.date)}));var i=this.app.getService("local").events(!0);this.on(i.data,"onStoreUpdated",(function(i,n,r){return r&&t.RefreshData(e.date)}))},e.prototype.RefreshData=function(t){var e=this,i=webix.Date.monthStart(t),n=webix.Date.add(i,1,"month",!0);i=webix.Date.weekStart(new Date(i.getFullYear(),i.getMonth(),1));var r=Math.ceil((n-i)/864e5/7);n=webix.Date.add(n,r,"week",!0),this.Data.getEvents(i,n).then((function(t){e.app&&e.setParam("data",{start:i,weeks:r,data:t},!0)}))},e}(l),pe=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var e=t.prototype.config.call(this);return e.css="webix_scheduler_week",e.type.headerHeight=28,e},e.prototype.urlChange=function(){this.data=this.getParam("data"),this.data&&(this.List.clearAll(),this.List.parse(this.data.all),this.ToggleOverlay())},e.prototype.TemplateHeader=function(t){var e=new Date(1*t),i="%l, %F <span class='webix_scheduler_monthday"+(Ot(e)?" webix_scheduler_today":"")+"'>%j</span>";return'<span class="webix_unit_header_inner">'+webix.Date.dateToStr(i)(e)+"</span>"},e}(Mt),fe=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){return{type:"clean",cols:[{borderless:!1,width:51},{view:"dataview",localId:"header",css:"webix_scheduler_day_header",xCount:7,yCount:1,width:0,height:32,scroll:!1,type:{height:"auto",width:"auto"},template:function(t){return'<span class="webix_scheduler_weekday">'+t.day+'</span> <span class="webix_scheduler_monthday">'+t.date+"</span>"}}]}},e.prototype.urlChange=function(){this.data=this.getParam("data"),this.data&&this.RefreshData()},e.prototype.RefreshData=function(){for(var t=this.data.start,e=[];t<this.data.end;){var i={day:webix.i18n.calendar.dayShort[t.getDay()],date:t.getDate()};Ot(t)&&(i.$css="webix_scheduler_list_today"),e.push(i),t=webix.Date.add(t,1,"day",!0)}var n=this.$$("header");n.clearAll(),n.parse(e)},e}(l),ve=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){var e=this,i=t.prototype.config.call(this);return i.cols[1]={view:"dataview",localId:"multiDayList",css:"webix_scheduler_multidays",scroll:!1,height:32,xCount:7,yCount:1,width:0,type:{width:"auto",height:"auto",itemHeight:32},template:"",tooltip:{template:""},onClick:{webix_scheduler_multiday_event:function(t){return e.ShowEvent(t)}}},i},e.prototype.init=function(){var e=this;this.State=this.app.getState(),t.prototype.init.call(this),Gt(this,"multi"),xt(this),this.Events=new webix.DataCollection({}),this.List.attachEvent("onAfterRender",(function(){return e.RenderEvents()})),Qt.call(this,this.List,"multiday")},e.prototype.urlChange=function(){this.data=this.getParam("data"),this.data&&this.ParseDays(this.data.multi)},e.prototype.ParseDays=function(t){if(t.length){this.Events.clearAll(),this.Events.parse(t);for(var e=[],i=0;i<7;i++)e.push({id:i+1,date:webix.Date.add(this.data.start,i,"day",!0)});this.BreakEventsByDay(e),this.SetMoreIcon(this._maxEvents>this.maxVisibleLines?this._expandState:null),this.List.blockEvent(),this.List.parse(e),this.ResetListHeight(),this.List.unblockEvent(),this.RenderEvents()}},e.prototype.BreakEventsByDay=function(t){var e=this;this.Days=[];var i={};this._maxEvents=0,t.forEach((function(t,n){var r=t.date;e.Days.push([]),e.Events.data.each((function(t){if(webix.isUndefined(i[t.id])){if(t.start_date<webix.Date.add(r,1,"day",!0)&&t.end_date>=r){for(var a=0;!webix.isUndefined(e.Days[n][a]);)a++;i[t.id]=a;var o={};o.es=t.start_date,o.ee=t.all_day||webix.Date.timePart(t.end_date)?t.end_date:webix.Date.add(t.end_date,-1,"day",!0),o.length=1+Yt(o.ls=new Date(Math.max(e.data.start,o.es)),o.le=new Date(Math.min(e.data.end-1,o.ee))),t.$config=o,e.Days[n][a]=t}}else r<=t.end_date&&t.all_day||r<t.end_date?e.Days[n][i[t.id]]="":delete i[t.id]})),e.Days[n].length>e._maxEvents&&(e._maxEvents=e.Days[n].length)}))},e.prototype.RenderEvents=function(){var t=this,e=this.Events.count();if(e){var i=webix.html.create("div",{role:"presentation"}),n="",r=0,a="down"===this._expandState&&this._maxEvents>this.maxVisibleLines;this.List.data.each((function(e,i){for(var o=[],s=a?t.maxVisibleLines-1:t.Days[i].length,u=0;u<s;++u)o[u]=t.Days[i][u],o[u]&&(o[u]=t.ToHTML(o[u],i,u),r++);n+=o.join("")})),a&&(n+=this.MoreOption(e-r)),i.innerHTML=n,this._DataObj=this.List.$view.firstChild.appendChild(i)}},e.prototype.ToHTML=function(t,e,i){var n=Lt(t),r=this.GetSizePosition(t.$config.length,e,i),a=this.GetStyle(t,t.$config),o=this.app.getService("locale")._;return'\n\t\t\t<div\n\t\t\t\twebix_tooltip="'+(t.text||o("(No title)"))+'"\n\t\t\t\twebix_e_id="'+t.id+'"\n\t\t\t\tclass="'+a+'"\n\t\t\t\tstyle="'+r+" "+n+'">\n\t\t\t\t\t'+(t.text||o("(No title)"))+"\n\t\t\t</div>\n\t\t"},e.prototype.GetStyle=function(t,e){var i=this.data,n=i.start,r=i.end,a="webix_scheduler_multiday_event";return a+=!this.State.selected||t.id!=this.State.selected.id&&t.id!=this.State.selected.date?"":" webix_scheduler_event_selected",e.es<n&&webix.Date.equal(n,webix.Date.dayStart(e.ls))&&(a+=" webix_scheduler_event_break_left"),e.ee>=r&&webix.Date.equal(webix.Date.add(r,-1,"day",!0),webix.Date.dayStart(e.le))&&(a+=" webix_scheduler_event_break_right"),a},e.prototype.MoreOption=function(t){var e=this.app.getService("locale")._;return'<div webix_e_id="$wsh_multi_more" class="webix_scheduler_multiday_event webix_scheduler_multi_more" style="'+this.GetSizePosition(this.List.config.xCount,0,this.maxVisibleLines-1)+'">'+t+" "+e("more")+"</div>"},e.prototype.GetSizePosition=function(t,e,i){var n=t*this.List.type.width-4,r=this.List.type.itemHeight-4;return"width:"+n+"px; height:"+r+"px; line-height:"+r+"px; left:"+(this.List.type.width*e+1)+"px; top:"+(i*this.List.type.itemHeight+1)+"px;"},e.prototype.ShowEvent=function(t){var e=qt(t,this.List.$view);if(e.id){if("$wsh_multi_more"===e.id)return this.ExpandData();var i=this.Events.getItem(e.id),n=webix.extend(e,ct(i),!0);this.State.selected=n}return!1},e.prototype.ExpandData=function(){this._inAnimation||(this._inAnimation=!0,this._expandState="up",this.Animate("up"),this.ResetListHeight(this._maxEvents))},e.prototype.WrapData=function(){var t=this;if(!this._inAnimation){this._inAnimation=!0,this._expandState="down";var e=this.List.$height-(this._maxEvents-this.maxVisibleLines)*this.List.type.height;this.Animate("down",e,(function(){t.ResetListHeight(t.maxVisibleLines)}))}},e.prototype.ResetListHeight=function(t){t||(t="down"===this._expandState?Math.min(this._maxEvents,this.maxVisibleLines):this._maxEvents);var e=t*this.List.type.itemHeight;this.List.type.height!==e&&(this.List.type.height=e,this.List.define("height",e),this.List.resize())},e}(Ht),ge=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return i(e,t),e.prototype.config=function(){if(this.Compact=this.getParam("compact",!0),this.Compact)return{rows:[pe]};for(var t={localId:"scroll",view:"scrollview",scroll:"y",css:"webix_scheduler_week_days",body:{cols:[Bt]}},e=0;e<7;++e)t.body.cols.push(new(this.app.dynamic(re))(this.app,"",{day:e}));return{rows:[fe,{localId:"multi",hidden:!0,cols:[ve]},t]}},e.prototype.init=function(){var t=this,e=this.app.getState();this.on(e.$changes,"date",(function(e){return t.RefreshData(e)})),this.on(e.$changes,"active",(function(){return t.RefreshData(e.date)})),this.on(this.app,"events:refresh",(function(){return t.RefreshData(e.date)}));var i=this.app.getService("local").events(!0);this.on(i.data,"onStoreUpdated",(function(i,n,r){return r&&t.RefreshData(e.date)})),this.Compact||this.on(e.$changes,"selected",(function(e){return e&&t.ScrollScale(e)}))},e.prototype.RefreshData=function(t){var e=this,i=webix.Date.weekStart(t),n=webix.Date.add(i,1,"week",!0);this.GetWeek(i,n).then((function(t){e.app&&e.setParam("data",t,!0),t.multi.length?e.$$("multi").show():e.$$("multi").hide()}))},e.prototype.GetWeek=function(t,e){var i=this;return this.app.getService("local").getEvents(t,e).then((function(n){if(i.Compact)return{start:t,end:e,all:n};var r=[],a=[];return n.forEach((function(t){Rt(t)?r.push(t):a.push(t)})),{start:t,end:e,multi:r,single:a}}))},e.prototype.ScrollScale=function(t){var e=this;"0"!==t.id||t.date||setTimeout((function(){var t=40*((new Date).getHours()+2);e.$$("scroll").scrollTo(0,t)}),100)},e}(l),ye={JetView:l};ye["bars/add"]=V,ye["bars/date"]=j,ye.bars=K,ye["bars/nav"]=W,ye["bars/navpopup"]=X,ye["event/actionmenu"]=J,ye["event/form"]=St,ye["event/formpopup"]=Dt,ye["event/info"]=Et,ye["event/recurringform"]=yt,ye.main=Ct,ye["modes/agenda"]=Ft,ye["modes/common/actionpopup"]=$t,ye["modes/common/hourscale"]=Bt,ye["modes/common/multimore"]=Ht,ye["modes/common/unitlist"]=Mt,ye["modes/day/events"]=re,ye["modes/day"]=oe,ye["modes/day/multiday"]=ae,ye["modes/month/compact"]=se,ye["modes/month/events"]=ce,ye["modes/month/header"]=he,ye["modes/month"]=de,ye["modes/month/list"]=le,ye["modes/month/more"]=ue,ye["modes/week/compact"]=pe,ye["modes/week/header"]=fe,ye["modes/week"]=ge,ye["modes/week/multiday"]=ve,ye["side/editor"]=z,ye.side=q,ye["side/popup"]=Q;var me=function(){function t(t){this.app=t,this.store=this.createEvents(),this.events_ready=null,!1!==t.config.calendars&&(this.cals=this.createCalendars(),this.cals_ready=null),this.timeZoneOffset=(new Date).getTimezoneOffset(),this.loaded_ranges={}}return t.prototype.createEvents=function(){var t=this;return new webix.DataCollection({scheme:{$change:function(e){"string"==typeof e.start_date&&(e.start_date=_e(e.start_date)),"string"==typeof e.end_date&&(e.end_date=_e(e.end_date)),t.app.config.recurring&&(e.$recurring=e.recurring?function(t){for(var e=t.split(";"),i={},n=0;n<e.length;n++){var r=e[n].split("="),a=r[0],o=r[1];i[a]=o}return i.UNTIL&&(i.UNTIL=tt(i.UNTIL)),i.EXDATE&&(i.EXDATE=i.EXDATE.split(",").map((function(t){return tt(t)}))),i}(e.recurring):null,"string"!=typeof e.origin_id||isNaN(e.origin_id)||(e.origin_id*=1)),"string"==typeof e.all_day&&(e.all_day*=1),t.getColor(e,t.cals&&t.cals.getItem(e.calendar))},$serialize:function(t){return be(t)},$export:function(t){return be(t)}}})},t.prototype.events=function(t,e){var i=this,n=this.store;return t?n:this.calendars().then((function(){return i.app.config.dynamic?i.events_ready||(i.events_ready=webix.promise.resolve(i.store)):i.events_ready&&!e||(i.events_ready=i.app.getService("backend").events().then((function(t){return n.clearAll(),n.parse(t),n}))),i.events_ready}))},t.prototype.getEvents=function(t,e){var i,n=this,r=this.app.config.dynamic;if(r){var a=this.getParams(r);i=a.then?a.then((function(){return n.getLocal(t,e)})):!0===a?this.getLocal(t,e):this.loaded_ranges[a.from]=this.getDynamic(a).then((function(){return n.getLocal(t,e)}))}else i=this.getLocal(t,e);return i},t.prototype.getLocal=function(t,e){var i=this;return this.events().then((function(n){var r=i.app.config,a=i.app.getState().active,o=[];return n.data.each((function(n){(!r.calendars||function(t,e){for(var i=0;i<t.length;++i)if(t[i]==e)return!0;return!1}(a,n.calendar))&&n.start_date<e&&(n.end_date>t||n.end_date>=t&&n.all_day||n.$recurring&&(!n.$recurring.UNTIL||n.$recurring.UNTIL>t))&&(i.app.config.recurring&&n.recurring?o=o.concat(function(t,e,i){var n=i.$recurring;"WEEKLY"!==n.FREQ||n.BYDAY||(n.BYDAY=it[i.start_date.getDay()]),"MONTHLY"!==n.FREQ&&"YEARLY"!==n.FREQ||n.BYSETPOS||n.BYMONTHDAY||(n.BYMONTHDAY=i.start_date.getDate()),"YEARLY"!==n.FREQ||n.BYMONTH||(n.BYMONTH=i.start_date.getMonth());var r={},a=[];at(n,r);for(var o=new Date(i.start_date),s=i.end_date-i.start_date,u=1;t-o>=(s||1)&&(!n.UNTIL||o<n.UNTIL)&&(!n.COUNT||u<=n.COUNT)||rt(n.EXDATE,o);)++u,ot(o,n,r);for(;e>o&&(!n.UNTIL||o<n.UNTIL)&&(!n.COUNT||u<=n.COUNT);){if(!rt(n.EXDATE,o)){var c=webix.copy(i);o.setHours(i.start_date.getHours()),c.start_date=new Date(o),c.end_date=new Date(1*o+s),c.$id=i.id,c.id=c.start_date.valueOf()+"_"+i.id,a.push(c)}u++,ot(o,n,r)}return a}(t,e,n)):(delete n.recurring,o.push(n))),n.start_date=i.roundTime(n.start_date),n.end_date=i.roundTime(n.end_date)})),o.sort((function(t,e){return(t=t.start_date)>(e=e.start_date)?1:t<e?-1:0})),o}))},t.prototype.getDynamic=function(t){var e=this;return this.app.getService("backend").events(t).then((function(i){return e.store.parse(i),e.loaded_ranges[t.from]=!0,i}))},t.prototype.getParams=function(t){var e=this.app.getState(),i=webix.i18n.parseFormatStr,n=webix.Date[t+"Start"](e.date),r=i(n);return this.loaded_ranges[r]?this.loaded_ranges[r]:{timeshift:this.timeZoneOffset,from:r,to:i(webix.Date.add(n,1,t,!0))}},t.prototype.createCalendars=function(){var t=this;return new webix.DataCollection({scheme:{$sort:{dir:"desc",by:"active",as:xe}},on:{onAfterDelete:function(){return t.setActive()},onAfterAdd:function(){return t.setActive()},"data->onDataUpdate":function(e,i,n){n&&(i.color!==n.color&&(t.store.data.each((function(n){n.calendar==e&&t.getColor(n,i)})),t.app.callEvent("events:refresh")),i.active!==n.active&&(t.setActive(),setTimeout((function(){t.cals.sort("#active#","desc",xe)}),400)))}}})},t.prototype.calendars=function(t,e){var i=this;if(0==this.app.config.calendars)return!t&&webix.promise.resolve();var n=this.cals;return t?n:(this.cals_ready&&!e||(this.cals_ready=this.app.getService("backend").calendars().then((function(t){return n.clearAll(),n.parse(t),i.setActive(),n}))),this.cals_ready)},t.prototype.setActive=function(){var t=[];this.cals.data.each((function(e){1*e.active&&t.push(e.id)})),this.app.getState().active=t},t.prototype.getColor=function(t,e){var i,n;t.$color=e?e.color:t.color||"#01C2A5",t.$textColor=(i=t.color||t.$color,n=webix.color.toRgb(i),Math.round((299*n[0]+587*n[1]+114*n[2])/1e3)>180?"#475466":"#ffffff")},t.prototype.roundTime=function(t){var e=webix.Date.copy(t);return e.setMinutes(5*Math.round(e.getMinutes()/5)),e},t.prototype.isLastPart=function(t){return!this.store.find((function(e){return t.origin_id==e.origin_id&&(t.$id||t.id)!=e.id&&t.start_date<e.start_date}),!0)},t}(),we=webix.i18n.parseFormatStr,_e=webix.i18n.parseFormatDate;function be(t){return t.start_date=we(t.start_date),t.end_date=we(t.end_date),delete t.$recurring,delete t.$textColor,delete t.$color,t}function xe(t,e){return 1*t>1*e?1:-1}var Se=function(){function t(t){this.app=t,this.Back=t.getService("backend");var e=t.getService("local");this.Events=e.events(!0),this.Cals=e.calendars(!0),this.State=t.getState()}return t.prototype.addEvent=function(t,e){var i=this;return this.Back.addEvent(t).then((function(n){return e&&i.Events.remove(e),t.id=n.id,i.Events.add(t)}))},t.prototype.updateEvent=function(t,e,i,n){var r=this;return this.Back.updateEvent(t,e,i,n).then((function(){if(r.Events.updateItem(t,e),"unite"===i){var a=r.Events.find((function(e){return e.origin_id==t})).map((function(t){return t.id}));r.Events.remove(a)}else if("next"===i&&n){var o=r.Events.getItem(t);o.origin_id&&(t=o.origin_id);a=r.Events.find((function(e){return e.origin_id==t&&e.start_date>=n})).map((function(t){return t.id}));r.Events.remove(a)}}))},t.prototype.removeEvent=function(t,e,i){var n=this,r=this.State.selected?this.State.selected.id:e.$id||e.id,a="";t&&"all"!==t&&(a=this.State.selected?this.State.selected.date:e.$id?e.id:i);var o=!!t&&ft(a,e.start_date);if("next"===t&&o&&(t=vt.call(this,e,t)),!t||"all"===t||"this"===t&&!a||"next"===t&&e.origin_id&&o)"all"===t&&e.origin_id&&(r=e.origin_id),this.Back.removeEvent(r).then((function(){n.Events.remove(r);var t=n.Events.find((function(t){return t.origin_id==r})).map((function(t){return t.id}));n.Events.remove(t)}));else if("this"===t||"next"===t){a||(r=e.origin_id,e=this.app.getService("local").events(!0).getItem(r));var s=webix.Date.dayStart(a?new Date(1*a.split("_")[0]):e.start_date),u="this"===t?dt(s,e):lt(s,e);this.updateEvent(r,{recurring:u},t,s)}},t.prototype.addCalendar=function(t){var e=this;return t||(t={text:"",color:"#997CEB",active:1}),this.Back.addCalendar(t).then((function(i){return t.id=i.id,e.Cals.add(t,0),t.id}))},t.prototype.updateCalendar=function(t,e){var i=this;return this.app.getState().readonly?webix.promise.resolve(this.Cals.updateItem(t,e)):this.Back.updateCalendar(t,e).then((function(){return i.Cals.updateItem(t,e)}))},t.prototype.removeCalendar=function(t){var e=this;this.Back.removeCalendar(t).then((function(){e.Cals.remove(t)}))},t}(),De=function(){function t(t,e){this.app=t,this._url=e}return t.prototype.url=function(t){return this._url+t},t.prototype.events=function(t){return webix.ajax(this.url("events"),t).then((function(t){return t.json()}))},t.prototype.addEvent=function(t){return webix.ajax().post(this.url("events"),t).then((function(t){return t.json()}))},t.prototype.updateEvent=function(t,e,i,n){var r=e;return i&&(r.recurring_update_mode=i),n&&(r.recurring_update_date=n),webix.ajax().put(this.url("events/"+t),r).then((function(t){return t.json()}))},t.prototype.removeEvent=function(t){return webix.ajax().del(this.url("events/"+t)).then((function(t){return t.json()}))},t.prototype.calendars=function(){return webix.ajax(this.url("calendars")).then((function(t){return t.json()}))},t.prototype.addCalendar=function(t){return webix.ajax().post(this.url("calendars"),t).then((function(t){return t.json()}))},t.prototype.updateCalendar=function(t,e){return webix.ajax().put(this.url("calendars/"+t),e).then((function(t){return t.json()}))},t.prototype.removeCalendar=function(t){return webix.ajax().del(this.url("calendars/"+t)).then((function(t){return t.json()}))},t}(),Ee=function(t){function e(e){var i=this,r=H({mode:e.mode||"month",date:webix.Date.dayStart(e.date||new Date),readonly:e.readonly||!1,active:[],selected:null});e=e||{};var a=webix.extend({router:_,version:"8.0.5",debug:!0,start:"/main",params:{state:r,forceCompact:e.compact},compactWidth:780,recurring:void 0===e.recurring||e.recurring,calendars:void 0===e.calendars||e.calendars},e);return(i=t.call(this,n({},a))||this).setService("backend",new(i.dynamic(De))(i,i.config.url)),i.setService("local",new(i.dynamic(me))(i,e)),i.setService("operations",new(i.dynamic(Se))(i)),i.use(Y,i.config.locale||{lang:"en",webix:{en:"en-US"}}),i}return i(e,t),e.prototype.dynamic=function(t){return this.config.override&&this.config.override.get(t)||t},e.prototype.require=function(t,e){return"jet-views"===t?ye[e]:"jet-locales"===t?Ce[e]:null},e.prototype.getState=function(){return this.config.params.state},e}(w);webix.protoUI({name:"scheduler",app:Ee,defaults:{borderless:!0},$init:function(){this.name="scheduler";var t=this.$app.getState();for(var e in t)B(t,this.config,e);t.$changes.attachEvent("date",(function(){}))},getState:function(){return this.$app.getState()},getService:function(t){return this.$app.getService(t)}},webix.ui.jetapp);var $e={Backend:De,LocalData:me,Operations:Se},Ce={en:{Week:"Week",Day:"Day",Month:"Month",Agenda:"Agenda",Today:"Today",Create:"Create",Next:"Next",Previous:"Previous","Next day":"Next day","Previous day":"Previous day","Next week":"Next week","Previous week":"Previous week","Next month":"Next month","Previous month":"Previous month","Add calendar":"Add calendar","Do you really want to remove this calendar?":"Do you really want to remove this calendar?","Edit calendar":"Edit calendar",Delete:"Delete",Save:"Save",Title:"Title",Color:"Color",Active:"Active",Settings:"Settings","(no title)":"(no title)","Inactive calendar":"Inactive calendar","No Events":"No Events","All Day":"All Day",more:"more","Expand all-day events":"Expand all-day events","Collapse all-day events":"Collapse all-day events","The event will be deleted permanently, are you sure?":"The event will be deleted permanently, are you sure?",Done:"Done","Delete event":"Delete event",Close:"Close",Edit:"Edit","(No title)":"(No title)",Event:"Event",Start:"Start",End:"End",Calendar:"Calendar",Notes:"Notes",from:"from",to:"to",labelAllday:"All day",labelTime:"Time","Edit event":"Edit event",never:"never",none:"none",daily:"daily",day:"day",days:"days",every:"Every",weekly:"weekly",week:"week",weeks:"weeks",each:"Every",monthly:"monthly",month:"month",months:"months",yearly:"yearly",year:"year",years:"years",Repeat:"Repeat","End repeat":"End repeat","Repeats each":"Repeats each",till:"till",times:"times","weekly, every":"weekly, every","monthly, every":"monthly, every","yearly, every":"yearly, every","every working day":"every working day",custom:"custom",Every:"Every",on:"on","after several occurrences":"after several occurrences",date:"date","week on":"week on","Change recurring pattern":"Change recurring pattern","Save changes?":"Save changes?","All events":"All events","This event":"This event","This event and the following":"This event and the following",Cancel:"Cancel",Apply:"Apply","Edit recurring event":"Edit recurring event"}};t.App=Ee,t.locales=Ce,t.services=$e,t.views=ye,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=scheduler.min.js.map
